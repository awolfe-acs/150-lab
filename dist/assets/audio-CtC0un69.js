import{g as D}from"./index-B8M1MhT3.js";import{l as t}from"./logger-2Ii2FPkr.js";const z=document.querySelector('script[src*="/content/dam/acsorg/150/"]')!==null,F=window.location.hostname.includes("github.io")||window.location.pathname.startsWith("/150-lab/"),H=z?"/content/dam/acsorg/150/assets":F?"/150-lab/assets":"",W=`${H}/audio/ui-click.mp3`,$=`${H}/audio/chemistry-3-final.mp3`;let o=null,s=!1,n=!1,V=!1,B=!1,C=!1,g=!1,v=0;const w=25;let m=null,A=!1,b=null,q=0;const G=50;let P=null,Y=null;const _=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);function J(){if(!Y)try{const e=window.AudioContext||window.webkitAudioContext;e&&(Y=new e,t.log("[audio.js] Created shared AudioContext"))}catch(e){t.warn("[audio.js] Could not create AudioContext:",e)}return Y}async function L(){const e=J();if(e&&e.state==="suspended")try{await e.resume(),t.log("[audio.js] AudioContext resumed, state:",e.state)}catch(i){t.warn("[audio.js] Could not resume AudioContext:",i)}return e}function O(){b||(b=new Audio(W),b.volume=.35,b.preload="auto")}function I(){P&&(cancelAnimationFrame(P),P=null)}function h(e,i=1e3,r=null){if(!o)return;I();const l=o.volume,a=performance.now(),u=d=>{const k=d-a,f=Math.min(k/i,1),y=f*f;o.volume=l+(e-l)*y,f<1?P=requestAnimationFrame(u):(P=null,r&&r())};P=requestAnimationFrame(u)}const p=()=>{if(n)return;const e=Date.now();if(!(e-q<G)){q=e;try{b||O();const i=b.cloneNode();i.volume=.35,i.play().catch(r=>{t.warn("UI click sound play was prevented:",r)})}catch(i){t.error("Error playing UI click sound:",i)}}};async function x(){if(t.log("[audio.js] resumeBackgroundAudio called"),!o||n){t.log("[audio.js] Cannot resume: instance missing or muted");return}I(),await L(),o.volume<.01&&(o.volume=.001),_&&o.paused&&o.currentTime>0&&t.log("[audio.js] Safari: Audio was paused, ensuring good state");try{await o.play(),t.log("[audio.js] Audio play confirmed, fading in to 0.22"),h(.22,1e3)}catch(e){t.warn("[audio.js] Audio play blocked:",e);const i=async()=>{if(t.log("[audio.js] User interacted, retrying audio resume"),o&&!n)try{await L(),await o.play(),h(.22,1e3)}catch(r){t.error("[audio.js] Retry failed:",r)}document.removeEventListener("click",i),document.removeEventListener("touchend",i)};document.addEventListener("click",i,{once:!0}),document.addEventListener("touchend",i,{once:!0,passive:!0})}}window.playUIClickSound=p;window.cancelActiveFade=I;window.fadeBackgroundAudio=h;window.resumeBackgroundAudio=x;function U(e){n&&(e.volume=0,e.muted=!0),e.addEventListener("play",()=>{const i=document.querySelector(".sound-toggle");i&&i.classList.contains("muted")&&(e.volume=0,e.muted=!0)})}function K(){return window.YT&&window.YT.Player?Promise.resolve():new Promise(e=>{if(window.onYouTubeIframeAPIReady){const l=window.onYouTubeIframeAPIReady;window.onYouTubeIframeAPIReady=()=>{l(),e()};return}window.onYouTubeIframeAPIReady=()=>{e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api";const r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(i,r)})}function N(e){if(e.dataset.clickHandlerAdded)return;e.dataset.clickHandlerAdded="true",e.id||(e.id="youtube-iframe-"+Date.now()+"-"+Math.random().toString(36).substr(2,9));const i=e.src;if(i&&(i.includes("youtube.com")||i.includes("youtu.be"))&&!i.includes("enablejsapi=1")){const f=i.includes("?")?"&":"?",y=i+f+"enablejsapi=1";t.log("[audio.js] Adding enablejsapi to iframe:",e.id,"- will need to wait for reload"),e.src=y}const r=e.parentElement;if(r?r.querySelector(".video-start-overlay"):null){t.log("[audio.js] Custom video overlay detected, skipping Player creation for:",e.id,"(video.js will manage this)");return}if(e.hasAttribute("data-player-managed")||window.mainYouTubePlayerManaged){t.log("[audio.js] Player already managed by video.js, skipping for:",e.id);return}if(e.id==="youtube-video-iframe"){t.log("[audio.js] Main YouTube video detected, skipping Player creation (video.js manages this)");return}let a=null,u=!1;K().then(()=>{setTimeout(()=>{if(e.hasAttribute("data-player-managed")||e.hasAttribute("data-yt-player-initialized")||window.mainYouTubePlayerManaged||e.id==="youtube-video-iframe"){t.log("[audio.js] Player was initialized by video.js during delay, skipping for:",e.id);return}try{t.log("[audio.js] Setting up YouTube Player API for iframe:",e.id),a=new window.YT.Player(e.id,{events:{onReady:y=>{t.log("[audio.js] YouTube Player ready for iframe:",e.id),u=!0},onStateChange:y=>{t.log("YouTube Player state changed:",y.data,"for iframe:",e.id),y.data===1?(t.log("Video playing, pausing background audio"),I(),o&&h(.001,1e3,()=>{t.log("Background audio ducked (vol 0.001)")})):(y.data===0||y.data===2)&&(t.log("[audio.js] Video paused/ended, calling resumeBackgroundAudio"),x())}}});const f=e.closest(".preview-video-wrapper")||e.parentElement;f&&(new IntersectionObserver(c=>{c.forEach(j=>{if(!j.isIntersecting){t.log("[audio.js] Video",e.id,"scrolled out of view, attempting to pause");let T=!1;try{u&&a&&typeof a.getPlayerState=="function"&&a.getPlayerState()===1&&(T=!0,a.pauseVideo(),t.log("[audio.js] Video paused successfully"))}catch(M){t.warn("[audio.js] Could not pause video:",M)}(k||T)&&(t.log("[audio.js] Video left viewport after being played, resuming background audio as fallback"),setTimeout(()=>{!(window.isMainVideoPlaying?window.isMainVideoPlaying():!1)&&!n&&x()},300))}})},{threshold:.25}).observe(f),t.log("[audio.js] IntersectionObserver set up for iframe:",e.id))}catch(f){t.error("Could not initialize YouTube Player API for iframe:",e.id,f),u=!1}},200)}).catch(f=>{t.error("Could not load YouTube API:",f)});const d=document.createElement("div");d.style.position="absolute",d.style.top="0",d.style.left="0",d.style.width="100%",d.style.height="100%",d.style.zIndex="10",d.style.cursor="pointer",d.style.pointerEvents="auto",d.style.backgroundColor="transparent",r&&getComputedStyle(r).position==="static"&&(r.style.position="relative"),r&&r.insertBefore(d,e);let k=!1;d.addEventListener("click",f=>{f.stopPropagation(),n||p(),d.style.pointerEvents="none",k=!0,setTimeout(()=>{I(),o&&!o.paused&&h(.001,1e3,()=>{t.log("[audio.js] Background audio ducked (vol 0.001) via overlay click")})},100),t.log("[audio.js] Overlay clicked for iframe:",e.id,"| Player ready:",u,"| Player exists:",!!a),(()=>{if(u&&a&&typeof a.playVideo=="function"){t.log("[audio.js] Using ready Player API to play video");try{a.playVideo();return}catch(c){t.warn("[audio.js] Player API failed, trying fallback:",c)}}t.log("[audio.js] Using postMessage API as primary method");try{e.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}',"*")}catch(c){t.warn("[audio.js] postMessage failed:",c)}if(a&&typeof a.playVideo=="function"){t.log("[audio.js] Attempting Player API as backup");try{a.playVideo()}catch(c){t.warn("[audio.js] Backup Player API call failed:",c)}}if(!a&&window.YT&&window.YT.Player){t.log("[audio.js] Player instance missing, creating new Player");try{a=new window.YT.Player(e.id,{events:{onReady:c=>{t.log("[audio.js] New player ready, playing immediately"),u=!0,c.target.playVideo()},onStateChange:c=>{c.data===1?(I(),o&&!o.paused&&h(.001,1e3,()=>{t.log("Background audio ducked (vol 0.001)")})):(c.data===0||c.data===2)&&x()}}})}catch(c){t.error("[audio.js] Failed to create new player:",c)}}if(!u){t.log("[audio.js] Player not ready, setting up retry mechanism");let c=0;const j=setInterval(()=>{if(c++,u&&a&&typeof a.playVideo=="function"){clearInterval(j),t.log("[audio.js] Player became ready after",c*100,"ms, playing video");try{a.playVideo()}catch(T){t.warn("[audio.js] Delayed play attempt failed:",T)}}c>30&&(clearInterval(j),t.warn("[audio.js] Player never became ready after 3 seconds"))},100)}})()})}function R(e){if(e.dataset.clickSoundHandlerAdded)return;e.dataset.clickSoundHandlerAdded="true",e.addEventListener("click",r=>{e.paused&&(n||p())});const i=e.closest(".video-wrapper");if(i){const r=i.querySelector(".video-overlay");r&&!r.dataset.clickSoundHandlerAdded&&(r.dataset.clickSoundHandlerAdded="true",r.addEventListener("click",()=>{n||p()}),r.addEventListener("touchend",l=>{n||p()},{passive:!0}))}e.addEventListener("play",()=>{o&&!o.paused&&o.pause()}),e.addEventListener("pause",()=>{o&&s&&!n&&e.ended&&o.play().catch(r=>{t.warn("Could not resume background audio:",r)})}),e.addEventListener("ended",()=>{o&&s&&!n&&o.play().catch(r=>{t.warn("Could not resume background audio:",r)})})}function Q(){document.addEventListener("click",e=>{e.target.closest(".video-overlay")&&!n&&p()}),document.addEventListener("touchend",e=>{e.target.closest(".video-overlay")&&!n&&p()},{passive:!0}),console.log("[audio.js] Video overlay click sound handler registered")}function X(){new MutationObserver(a=>{a.forEach(u=>{u.type==="childList"&&u.addedNodes.forEach(d=>{d.nodeName==="AUDIO"||d.nodeName==="VIDEO"?(U(d),d.nodeName==="VIDEO"&&R(d)):d.querySelectorAll&&(d.querySelectorAll("audio, video").forEach(y=>{U(y),y.nodeName==="VIDEO"&&R(y)}),d.querySelectorAll('iframe[src*="youtube.com"], iframe[src*="youtu.be"]').forEach(y=>{N(y)}))})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll('iframe[src*="youtube.com"], iframe[src*="youtu.be"]').forEach(a=>{N(a)}),document.querySelectorAll("video").forEach(a=>{R(a)});let l;window.addEventListener("scroll",()=>{l&&clearTimeout(l),l=setTimeout(()=>{const a=window.isMainVideoPlaying?window.isMainVideoPlaying():!1,u=window.isSecondVideoPlaying?window.isSecondVideoPlaying():!1;!a&&!u&&o&&!o.paused&&o.volume<.05&&!n&&(t.log("[audio.js] Scroll fallback: No videos playing, resuming ducked audio"),h(.22,1e3))},200)})}function E(e=!1){if(!(s||n)){if(v++,window.audioRetryCount=v,window.maxAudioRetries=w,v>=w){t.warn(`Exceeded maximum audio retry attempts (${w}). Stopping retries.`);return}try{o.volume=.22,e&&L().catch(i=>{t.warn("Could not resume audio context:",i)}),o.play().then(()=>{s=!0,window.audioInitialized=!0;const i=document.querySelector(".sound-toggle");i&&i.classList.add("active"),v=0,window.audioRetryCount=0}).catch(i=>{t.error("Audio play was prevented:",i),s=!1,(e||g)&&v<w&&setTimeout(()=>{!s&&!n&&E(!0)},500)})}catch(i){t.error("Error playing audio:",i),s=!1,(e||g)&&v<w&&setTimeout(()=>{!s&&!n&&E(!0)},500)}}}const Z=()=>{document.hidden?o&&!o.paused&&s&&(A=!0,o.pause()):o&&A&&s&&!n&&(A=!1,o.play().catch(e=>{t.warn("Could not resume background audio:",e),s=!1,g&&setTimeout(()=>{S(!0)},100)}))};function ee(){document.addEventListener("visibilitychange",Z),window.addEventListener("blur",()=>{o&&!o.paused&&s&&(A=!0,o.pause())}),window.addEventListener("focus",()=>{o&&A&&s&&!n&&(A=!1,o.play().catch(e=>{t.warn("Could not resume background audio on focus:",e),s=!1,g&&setTimeout(()=>{S(!0)},100)}))})}const S=(e=!1)=>{if(!n&&(e&&(g=!0,window.enterButtonClicked=!0),!!g&&!s)){if(v>=w){t.warn(`Exceeded maximum audio retry attempts (${w}). Stopping retries.`),m&&(clearInterval(m),m=null);return}if(e){setTimeout(()=>{if(!n)if(C||o&&o.readyState>=3)E(!0);else try{o.load()}catch(i){t.warn("Error reloading background audio:",i)}},2e3);return}if(C||o&&o.readyState>=3)E(e);else if(e)try{o.load()}catch(i){t.warn("Error reloading background audio:",i)}}};function ie(){const e=new Audio;e.addEventListener("canplaythrough",()=>{C=!0,g&&!s&&!n&&E(!0)}),e.addEventListener("error",i=>{t.error("Audio loading error:",i),t.error("Audio src:",e.src),(window.location.hostname==="localhost"||window.location.hostname.includes("127.0.0.1"))&&t.warn("Audio failed to load in dev mode. Ensure audio files are in 150-lab/public/audio/ directory.")}),e.loop=!0,e.volume=0,e.preload="auto",e.src=$;try{e.load()}catch(i){t.error("Error loading background audio:",i)}o=e,window.backgroundAudioInstance=e,window.backgroundAudio=e,s=!1,n=!1,V=!1,B=!1,C=!1,g=!1,v=0,window.audioInitialized=!1,window.audioMuted=!1,window.userInteracted=!1,window.heroAnimationComplete=!1,window.enterButtonClicked=!1,window.audioRetryCount=0,window.maxAudioRetries=w,window.audioRetryTimer=null,ee()}const ae=()=>{O(),document.querySelectorAll('a, button, input[type="button"], input[type="submit"], input[type="reset"], input[type="checkbox"], input[type="radio"], .marker, .minor-node').forEach(r=>{r.addEventListener("click",l=>{if(r.classList.contains("enter-experience")){r.dataset.clickSoundPlayed||(n||p(),r.dataset.clickSoundPlayed="true");return}n||p()})}),new MutationObserver(r=>{r.forEach(l=>{l.type==="childList"&&l.addedNodes.forEach(a=>{a.nodeType===1&&(a.matches('a, button, input[type="button"], input[type="submit"], input[type="reset"], input[type="checkbox"], input[type="radio"], .marker, .minor-node')&&a.addEventListener("click",d=>{if(a.classList.contains("enter-experience")){a.dataset.clickSoundPlayed||(n||p(),a.dataset.clickSoundPlayed="true");return}n||p()}),a.querySelectorAll('a, button, input[type="button"], input[type="submit"], input[type="reset"], input[type="checkbox"], input[type="radio"], .marker, .minor-node').forEach(d=>{d.addEventListener("click",k=>{if(d.classList.contains("enter-experience")){d.dataset.clickSoundPlayed||(n||p(),d.dataset.clickSoundPlayed="true");return}n||p()})}))})})}).observe(document.body,{childList:!0,subtree:!0}),X(),Q()},ne=e=>{V=!0,g&&!s&&B&&!n&&S(!0)};function re(){const e=document.querySelector(".sound-toggle");if(e){const i=document.getElementById("waveGroup");i&&(window.waveAnimation=D.to(i,{x:"-=100",ease:"linear",duration:2,repeat:-1})),e.addEventListener("click",()=>{const r=n;if(e.classList.toggle("muted"),n=e.classList.contains("muted"),window.audioMuted=n,r)try{b||O();const a=b.cloneNode();a.volume=.38,a.play().catch(u=>{t.warn("UI click sound play was prevented:",u)})}catch(a){t.error("Error playing UI click sound:",a)}else p();const l=window.waveAnimation;if(n)l&&l.pause(),o&&(o.volume=0,m&&(clearInterval(m),m=null));else{l&&l.resume();const a=document.getElementById("anniversary-video");a&&!a.paused&&!a.ended||(!s&&g&&o?(S(!0),m||(m=setInterval(()=>{s?(clearInterval(m),m=null):!n&&g&&(v<w?S(!0):(t.warn(`Exceeded maximum audio retry attempts (${w}). Stopping retries.`),clearInterval(m),m=null))},500))):s&&o&&(L().then(()=>{t.log("[audio.js] AudioContext resumed on unmute")}).catch(d=>{t.warn("[audio.js] Error resuming AudioContext on unmute:",d)}),o.volume=.22,t.log("[audio.js] Unmuting - attempting to play audio"),(async()=>{try{await o.play(),t.log("[audio.js] Audio resumed successfully on unmute")}catch(d){t.warn("Audio play was prevented on unmute:",d),s=!1,g&&S(!0)}})()))}})}}const de=()=>({audioInitialized:s,audioMuted:n,userInteracted:V,heroAnimationComplete:B,backgroundAudioLoaded:C,enterButtonClicked:g,backgroundAudioInstance:o});function se(e){B=e,window.heroAnimationComplete=e}function ue(e){g=e,window.enterButtonClicked=e}function le(e){V=e,window.userInteracted=e}function ce(){n=!n;const e=document.querySelector(".sound-toggle");e&&(n?e.classList.add("muted"):e.classList.remove("muted")),o&&(o.volume=n?0:.22)}export{ne as enableAudioOnInteraction,de as getAudioState,U as handleNewAudioElement,S as playBackgroundAudio,ie as preloadBackgroundAudio,ue as setEnterButtonClicked,se as setHeroAnimationComplete,le as setUserInteracted,re as setupSoundToggle,ae as setupUIClickSounds,ce as toggleMute};
