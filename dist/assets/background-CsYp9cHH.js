const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mobileFilmGrain-CmB6Tq7x.js","assets/logger-2Ii2FPkr.js"])))=>i.map(i=>d[i]);
import{T as Zi,a as Vo,b as si,L as ri,c as Rt,F as ro,M as Ne,V as ao,C as X,d as Ie,S as Xe,e as Qi,P as es,D as ai,f as lo,g as Ke,I as ts,Q as li,h as os,O as ci,i as ns,j as is,B as ge,k as di,l as ui,N as ss,m as rs,n as as,o as jo,p as fi,R as Ko,q as ls,r as cs,s as ds,t as Do,u as us,v as hi,w as Xo,x as kt,y as fs,z as co,A as hs,E as $o,G as ps,H as ms,J as gs,K as qo,U as Lt,W as vs,X as _s,Y as pi,Z as ws,_ as ys,$ as bs,a0 as Cs,a1 as mi,a2 as gi,a3 as Yo,a4 as Nn,a5 as zn,a6 as Bn,a7 as Jo,a8 as Ss,a9 as xs,aa as Zo,ab as Ts,ac as le,ad as As,ae as ft,af as Hn,ag as et,ah as no,ai as Es,aj as Un,ak as Gn}from"./mobileFilmGrain-CmB6Tq7x.js";import{l as D}from"./logger-2Ii2FPkr.js";import{_ as Ms}from"./index-DHkcmSZ9.js";import Io from"./aemModeDetector-DID0UQIE.js";function Os(a){if(!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=a,document.head.appendChild(e),a}}function mt(a,e){var t=a.__state.conversionName.toString(),n=Math.round(a.r),o=Math.round(a.g),i=Math.round(a.b),r=a.a,l=Math.round(a.h),c=a.s.toFixed(1),d=a.v.toFixed(1);if(e||t==="THREE_CHAR_HEX"||t==="SIX_CHAR_HEX"){for(var m=a.hex.toString(16);m.length<6;)m="0"+m;return"#"+m}else{if(t==="CSS_RGB")return"rgb("+n+","+o+","+i+")";if(t==="CSS_RGBA")return"rgba("+n+","+o+","+i+","+r+")";if(t==="HEX")return"0x"+a.hex.toString(16);if(t==="RGB_ARRAY")return"["+n+","+o+","+i+"]";if(t==="RGBA_ARRAY")return"["+n+","+o+","+i+","+r+"]";if(t==="RGB_OBJ")return"{r:"+n+",g:"+o+",b:"+i+"}";if(t==="RGBA_OBJ")return"{r:"+n+",g:"+o+",b:"+i+",a:"+r+"}";if(t==="HSV_OBJ")return"{h:"+l+",s:"+c+",v:"+d+"}";if(t==="HSVA_OBJ")return"{h:"+l+",s:"+c+",v:"+d+",a:"+r+"}"}return"unknown format"}var Wn=Array.prototype.forEach,At=Array.prototype.slice,b={BREAK:{},extend:function(e){return this.each(At.call(arguments,1),function(t){var n=this.isObject(t)?Object.keys(t):[];n.forEach(function(o){this.isUndefined(t[o])||(e[o]=t[o])}.bind(this))},this),e},defaults:function(e){return this.each(At.call(arguments,1),function(t){var n=this.isObject(t)?Object.keys(t):[];n.forEach(function(o){this.isUndefined(e[o])&&(e[o]=t[o])}.bind(this))},this),e},compose:function(){var e=At.call(arguments);return function(){for(var t=At.call(arguments),n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},each:function(e,t,n){if(e){if(Wn&&e.forEach&&e.forEach===Wn)e.forEach(t,n);else if(e.length===e.length+0){var o=void 0,i=void 0;for(o=0,i=e.length;o<i;o++)if(o in e&&t.call(n,e[o],o)===this.BREAK)return}else for(var r in e)if(t.call(n,e[r],r)===this.BREAK)return}},defer:function(e){setTimeout(e,0)},debounce:function(e,t,n){var o=void 0;return function(){var i=this,r=arguments;function l(){o=null,n||e.apply(i,r)}var c=n||!o;clearTimeout(o),o=setTimeout(l,t),c&&e.apply(i,r)}},toArray:function(e){return e.toArray?e.toArray():At.call(e)},isUndefined:function(e){return e===void 0},isNull:function(e){return e===null},isNaN:(function(a){function e(t){return a.apply(this,arguments)}return e.toString=function(){return a.toString()},e})(function(a){return isNaN(a)}),isArray:Array.isArray||function(a){return a.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return e===!1||e===!0},isFunction:function(e){return e instanceof Function}},ks=[{litmus:b.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:mt},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:mt},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:mt},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:mt}}},{litmus:b.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:b.isArray,conversions:{RGB_ARRAY:{read:function(e){return e.length!==3?!1:{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return e.length!==4?!1:{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:b.isObject,conversions:{RGBA_OBJ:{read:function(e){return b.isNumber(e.r)&&b.isNumber(e.g)&&b.isNumber(e.b)&&b.isNumber(e.a)?{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return b.isNumber(e.r)&&b.isNumber(e.g)&&b.isNumber(e.b)?{space:"RGB",r:e.r,g:e.g,b:e.b}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return b.isNumber(e.h)&&b.isNumber(e.s)&&b.isNumber(e.v)&&b.isNumber(e.a)?{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return b.isNumber(e.h)&&b.isNumber(e.s)&&b.isNumber(e.v)?{space:"HSV",h:e.h,s:e.s,v:e.v}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],Et=void 0,io=void 0,Qo=function(){io=!1;var e=arguments.length>1?b.toArray(arguments):arguments[0];return b.each(ks,function(t){if(t.litmus(e))return b.each(t.conversions,function(n,o){if(Et=n.read(e),io===!1&&Et!==!1)return io=Et,Et.conversionName=o,Et.conversion=n,b.BREAK}),b.BREAK}),io},Vn=void 0,uo={hsv_to_rgb:function(e,t,n){var o=Math.floor(e/60)%6,i=e/60-Math.floor(e/60),r=n*(1-t),l=n*(1-i*t),c=n*(1-(1-i)*t),d=[[n,c,r],[l,n,r],[r,n,c],[r,l,n],[c,r,n],[n,r,l]][o];return{r:d[0]*255,g:d[1]*255,b:d[2]*255}},rgb_to_hsv:function(e,t,n){var o=Math.min(e,t,n),i=Math.max(e,t,n),r=i-o,l=void 0,c=void 0;if(i!==0)c=r/i;else return{h:NaN,s:0,v:0};return e===i?l=(t-n)/r:t===i?l=2+(n-e)/r:l=4+(e-t)/r,l/=6,l<0&&(l+=1),{h:l*360,s:c,v:i/255}},rgb_to_hex:function(e,t,n){var o=this.hex_with_component(0,2,e);return o=this.hex_with_component(o,1,t),o=this.hex_with_component(o,0,n),o},component_from_hex:function(e,t){return e>>t*8&255},hex_with_component:function(e,t,n){return n<<(Vn=t*8)|e&~(255<<Vn)}},Ps=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},Oe=function(a,e){if(!(a instanceof e))throw new TypeError("Cannot call a class as a function")},ke=(function(){function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}})(),$e=function a(e,t,n){e===null&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(o===void 0){var i=Object.getPrototypeOf(e);return i===null?void 0:a(i,t,n)}else{if("value"in o)return o.value;var r=o.get;return r===void 0?void 0:r.call(n)}},qe=function(a,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);a.prototype=Object.create(e&&e.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(a,e):a.__proto__=e)},Ye=function(a,e){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:a},ie=(function(){function a(){if(Oe(this,a),this.__state=Qo.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return ke(a,[{key:"toString",value:function(){return mt(this)}},{key:"toHexString",value:function(){return mt(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),a})();function ln(a,e,t){Object.defineProperty(a,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(ie.recalculateRGB(this,e,t),this.__state[e])},set:function(o){this.__state.space!=="RGB"&&(ie.recalculateRGB(this,e,t),this.__state.space="RGB"),this.__state[e]=o}})}function cn(a,e){Object.defineProperty(a,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(ie.recalculateHSV(this),this.__state[e])},set:function(n){this.__state.space!=="HSV"&&(ie.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=n}})}ie.recalculateRGB=function(a,e,t){if(a.__state.space==="HEX")a.__state[e]=uo.component_from_hex(a.__state.hex,t);else if(a.__state.space==="HSV")b.extend(a.__state,uo.hsv_to_rgb(a.__state.h,a.__state.s,a.__state.v));else throw new Error("Corrupted color state")};ie.recalculateHSV=function(a){var e=uo.rgb_to_hsv(a.r,a.g,a.b);b.extend(a.__state,{s:e.s,v:e.v}),b.isNaN(e.h)?b.isUndefined(a.__state.h)&&(a.__state.h=0):a.__state.h=e.h};ie.COMPONENTS=["r","g","b","h","s","v","hex","a"];ln(ie.prototype,"r",2);ln(ie.prototype,"g",1);ln(ie.prototype,"b",0);cn(ie.prototype,"h");cn(ie.prototype,"s");cn(ie.prototype,"v");Object.defineProperty(ie.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}});Object.defineProperty(ie.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=uo.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var ot=(function(){function a(e,t){Oe(this,a),this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onChange=void 0,this.__onFinishChange=void 0}return ke(a,[{key:"onChange",value:function(t){return this.__onChange=t,this}},{key:"onFinishChange",value:function(t){return this.__onFinishChange=t,this}},{key:"setValue",value:function(t){return this.object[this.property]=t,this.__onChange&&this.__onChange.call(this,t),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),a})(),Rs={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},vi={};b.each(Rs,function(a,e){b.each(a,function(t){vi[t]=e})});var Ls=/(\d+(\.\d+)?)px/;function Fe(a){if(a==="0"||b.isUndefined(a))return 0;var e=a.match(Ls);return b.isNull(e)?0:parseFloat(e[1])}var v={makeSelectable:function(e,t){e===void 0||e.style===void 0||(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,n){var o=n,i=t;b.isUndefined(i)&&(i=!0),b.isUndefined(o)&&(o=!0),e.style.position="absolute",i&&(e.style.left=0,e.style.right=0),o&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,n,o){var i=n||{},r=vi[t];if(!r)throw new Error("Event type "+t+" not supported.");var l=document.createEvent(r);switch(r){case"MouseEvents":{var c=i.x||i.clientX||0,d=i.y||i.clientY||0;l.initMouseEvent(t,i.bubbles||!1,i.cancelable||!0,window,i.clickCount||1,0,0,c,d,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var m=l.initKeyboardEvent||l.initKeyEvent;b.defaults(i,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),m(t,i.bubbles||!1,i.cancelable,window,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.keyCode,i.charCode);break}default:{l.initEvent(t,i.bubbles||!1,i.cancelable||!0);break}}b.defaults(l,o),e.dispatchEvent(l)},bind:function(e,t,n,o){var i=o||!1;return e.addEventListener?e.addEventListener(t,n,i):e.attachEvent&&e.attachEvent("on"+t,n),v},unbind:function(e,t,n,o){var i=o||!1;return e.removeEventListener?e.removeEventListener(t,n,i):e.detachEvent&&e.detachEvent("on"+t,n),v},addClass:function(e,t){if(e.className===void 0)e.className=t;else if(e.className!==t){var n=e.className.split(/ +/);n.indexOf(t)===-1&&(n.push(t),e.className=n.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return v},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var n=e.className.split(/ +/),o=n.indexOf(t);o!==-1&&(n.splice(o,1),e.className=n.join(" "))}else e.className=void 0;return v},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return Fe(t["border-left-width"])+Fe(t["border-right-width"])+Fe(t["padding-left"])+Fe(t["padding-right"])+Fe(t.width)},getHeight:function(e){var t=getComputedStyle(e);return Fe(t["border-top-width"])+Fe(t["border-bottom-width"])+Fe(t["padding-top"])+Fe(t["padding-bottom"])+Fe(t.height)},getOffset:function(e){var t=e,n={left:0,top:0};if(t.offsetParent)do n.left+=t.offsetLeft,n.top+=t.offsetTop,t=t.offsetParent;while(t);return n},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},_i=(function(a){qe(e,a);function e(t,n){Oe(this,e);var o=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),i=o;o.__prev=o.getValue(),o.__checkbox=document.createElement("input"),o.__checkbox.setAttribute("type","checkbox");function r(){i.setValue(!i.__prev)}return v.bind(o.__checkbox,"change",r,!1),o.domElement.appendChild(o.__checkbox),o.updateDisplay(),o}return ke(e,[{key:"setValue",value:function(n){var o=$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,n);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),o}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(ot),Fs=(function(a){qe(e,a);function e(t,n,o){Oe(this,e);var i=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),r=o,l=i;if(i.__select=document.createElement("select"),b.isArray(r)){var c={};b.each(r,function(d){c[d]=d}),r=c}return b.each(r,function(d,m){var h=document.createElement("option");h.innerHTML=m,h.setAttribute("value",d),l.__select.appendChild(h)}),i.updateDisplay(),v.bind(i.__select,"change",function(){var d=this.options[this.selectedIndex].value;l.setValue(d)}),i.domElement.appendChild(i.__select),i}return ke(e,[{key:"setValue",value:function(n){var o=$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,n);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),o}},{key:"updateDisplay",value:function(){return v.isActive(this.__select)?this:(this.__select.value=this.getValue(),$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e})(ot),Ds=(function(a){qe(e,a);function e(t,n){Oe(this,e);var o=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),i=o;function r(){i.setValue(i.__input.value)}function l(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}return o.__input=document.createElement("input"),o.__input.setAttribute("type","text"),v.bind(o.__input,"keyup",r),v.bind(o.__input,"change",r),v.bind(o.__input,"blur",l),v.bind(o.__input,"keydown",function(c){c.keyCode===13&&this.blur()}),o.updateDisplay(),o.domElement.appendChild(o.__input),o}return ke(e,[{key:"updateDisplay",value:function(){return v.isActive(this.__input)||(this.__input.value=this.getValue()),$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(ot);function jn(a){var e=a.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var wi=(function(a){qe(e,a);function e(t,n,o){Oe(this,e);var i=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),r=o||{};return i.__min=r.min,i.__max=r.max,i.__step=r.step,b.isUndefined(i.__step)?i.initialValue===0?i.__impliedStep=1:i.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(i.initialValue))/Math.LN10))/10:i.__impliedStep=i.__step,i.__precision=jn(i.__impliedStep),i}return ke(e,[{key:"setValue",value:function(n){var o=n;return this.__min!==void 0&&o<this.__min?o=this.__min:this.__max!==void 0&&o>this.__max&&(o=this.__max),this.__step!==void 0&&o%this.__step!==0&&(o=Math.round(o/this.__step)*this.__step),$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,o)}},{key:"min",value:function(n){return this.__min=n,this}},{key:"max",value:function(n){return this.__max=n,this}},{key:"step",value:function(n){return this.__step=n,this.__impliedStep=n,this.__precision=jn(n),this}}]),e})(ot);function Is(a,e){var t=Math.pow(10,e);return Math.round(a*t)/t}var fo=(function(a){qe(e,a);function e(t,n,o){Oe(this,e);var i=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,o));i.__truncationSuspended=!1;var r=i,l=void 0;function c(){var T=parseFloat(r.__input.value);b.isNaN(T)||r.setValue(T)}function d(){r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}function m(){d()}function h(T){var S=l-T.clientY;r.setValue(r.getValue()+S*r.__impliedStep),l=T.clientY}function g(){v.unbind(window,"mousemove",h),v.unbind(window,"mouseup",g),d()}function C(T){v.bind(window,"mousemove",h),v.bind(window,"mouseup",g),l=T.clientY}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),v.bind(i.__input,"change",c),v.bind(i.__input,"blur",m),v.bind(i.__input,"mousedown",C),v.bind(i.__input,"keydown",function(T){T.keyCode===13&&(r.__truncationSuspended=!0,this.blur(),r.__truncationSuspended=!1,d())}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return ke(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():Is(this.getValue(),this.__precision),$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(wi);function Kn(a,e,t,n,o){return n+(o-n)*((a-e)/(t-e))}var en=(function(a){qe(e,a);function e(t,n,o,i,r){Oe(this,e);var l=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,{min:o,max:i,step:r})),c=l;l.__background=document.createElement("div"),l.__foreground=document.createElement("div"),v.bind(l.__background,"mousedown",d),v.bind(l.__background,"touchstart",g),v.addClass(l.__background,"slider"),v.addClass(l.__foreground,"slider-fg");function d(S){document.activeElement.blur(),v.bind(window,"mousemove",m),v.bind(window,"mouseup",h),m(S)}function m(S){S.preventDefault();var x=c.__background.getBoundingClientRect();return c.setValue(Kn(S.clientX,x.left,x.right,c.__min,c.__max)),!1}function h(){v.unbind(window,"mousemove",m),v.unbind(window,"mouseup",h),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}function g(S){S.touches.length===1&&(v.bind(window,"touchmove",C),v.bind(window,"touchend",T),C(S))}function C(S){var x=S.touches[0].clientX,L=c.__background.getBoundingClientRect();c.setValue(Kn(x,L.left,L.right,c.__min,c.__max))}function T(){v.unbind(window,"touchmove",C),v.unbind(window,"touchend",T),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}return l.updateDisplay(),l.__background.appendChild(l.__foreground),l.domElement.appendChild(l.__background),l}return ke(e,[{key:"updateDisplay",value:function(){var n=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=n*100+"%",$e(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(wi),yi=(function(a){qe(e,a);function e(t,n,o){Oe(this,e);var i=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),r=i;return i.__button=document.createElement("div"),i.__button.innerHTML=o===void 0?"Fire":o,v.bind(i.__button,"click",function(l){return l.preventDefault(),r.fire(),!1}),v.addClass(i.__button,"button"),i.domElement.appendChild(i.__button),i}return ke(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e})(ot),tn=(function(a){qe(e,a);function e(t,n){Oe(this,e);var o=Ye(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));o.__color=new ie(o.getValue()),o.__temp=new ie(0);var i=o;o.domElement=document.createElement("div"),v.makeSelectable(o.domElement,!1),o.__selector=document.createElement("div"),o.__selector.className="selector",o.__saturation_field=document.createElement("div"),o.__saturation_field.className="saturation-field",o.__field_knob=document.createElement("div"),o.__field_knob.className="field-knob",o.__field_knob_border="2px solid ",o.__hue_knob=document.createElement("div"),o.__hue_knob.className="hue-knob",o.__hue_field=document.createElement("div"),o.__hue_field.className="hue-field",o.__input=document.createElement("input"),o.__input.type="text",o.__input_textShadow="0 1px 1px ",v.bind(o.__input,"keydown",function(S){S.keyCode===13&&h.call(this)}),v.bind(o.__input,"blur",h),v.bind(o.__selector,"mousedown",function(){v.addClass(this,"drag").bind(window,"mouseup",function(){v.removeClass(i.__selector,"drag")})}),v.bind(o.__selector,"touchstart",function(){v.addClass(this,"drag").bind(window,"touchend",function(){v.removeClass(i.__selector,"drag")})});var r=document.createElement("div");b.extend(o.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),b.extend(o.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:o.__field_knob_border+(o.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),b.extend(o.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),b.extend(o.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),b.extend(r.style,{width:"100%",height:"100%",background:"none"}),Xn(r,"top","rgba(0,0,0,0)","#000"),b.extend(o.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),zs(o.__hue_field),b.extend(o.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:o.__input_textShadow+"rgba(0,0,0,0.7)"}),v.bind(o.__saturation_field,"mousedown",l),v.bind(o.__saturation_field,"touchstart",l),v.bind(o.__field_knob,"mousedown",l),v.bind(o.__field_knob,"touchstart",l),v.bind(o.__hue_field,"mousedown",c),v.bind(o.__hue_field,"touchstart",c);function l(S){C(S),v.bind(window,"mousemove",C),v.bind(window,"touchmove",C),v.bind(window,"mouseup",d),v.bind(window,"touchend",d)}function c(S){T(S),v.bind(window,"mousemove",T),v.bind(window,"touchmove",T),v.bind(window,"mouseup",m),v.bind(window,"touchend",m)}function d(){v.unbind(window,"mousemove",C),v.unbind(window,"touchmove",C),v.unbind(window,"mouseup",d),v.unbind(window,"touchend",d),g()}function m(){v.unbind(window,"mousemove",T),v.unbind(window,"touchmove",T),v.unbind(window,"mouseup",m),v.unbind(window,"touchend",m),g()}function h(){var S=Qo(this.value);S!==!1?(i.__color.__state=S,i.setValue(i.__color.toOriginal())):this.value=i.__color.toString()}function g(){i.__onFinishChange&&i.__onFinishChange.call(i,i.__color.toOriginal())}o.__saturation_field.appendChild(r),o.__selector.appendChild(o.__field_knob),o.__selector.appendChild(o.__saturation_field),o.__selector.appendChild(o.__hue_field),o.__hue_field.appendChild(o.__hue_knob),o.domElement.appendChild(o.__input),o.domElement.appendChild(o.__selector),o.updateDisplay();function C(S){S.type.indexOf("touch")===-1&&S.preventDefault();var x=i.__saturation_field.getBoundingClientRect(),L=S.touches&&S.touches[0]||S,U=L.clientX,z=L.clientY,B=(U-x.left)/(x.right-x.left),q=1-(z-x.top)/(x.bottom-x.top);return q>1?q=1:q<0&&(q=0),B>1?B=1:B<0&&(B=0),i.__color.v=q,i.__color.s=B,i.setValue(i.__color.toOriginal()),!1}function T(S){S.type.indexOf("touch")===-1&&S.preventDefault();var x=i.__hue_field.getBoundingClientRect(),L=S.touches&&S.touches[0]||S,U=L.clientY,z=1-(U-x.top)/(x.bottom-x.top);return z>1?z=1:z<0&&(z=0),i.__color.h=z*360,i.setValue(i.__color.toOriginal()),!1}return o}return ke(e,[{key:"updateDisplay",value:function(){var n=Qo(this.getValue());if(n!==!1){var o=!1;b.each(ie.COMPONENTS,function(l){if(!b.isUndefined(n[l])&&!b.isUndefined(this.__color.__state[l])&&n[l]!==this.__color.__state[l])return o=!0,{}},this),o&&b.extend(this.__color.__state,n)}b.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var i=this.__color.v<.5||this.__color.s>.5?255:0,r=255-i;b.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+i+","+i+","+i+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,Xn(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),b.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+i+","+i+","+i+")",textShadow:this.__input_textShadow+"rgba("+r+","+r+","+r+",.7)"})}}]),e})(ot),Ns=["-moz-","-o-","-webkit-","-ms-",""];function Xn(a,e,t,n){a.style.background="",b.each(Ns,function(o){a.style.cssText+="background: "+o+"linear-gradient("+e+", "+t+" 0%, "+n+" 100%); "})}function zs(a){a.style.background="",a.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",a.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",a.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var Bs={load:function(e,t){var n=t||document,o=n.createElement("link");o.type="text/css",o.rel="stylesheet",o.href=e,n.getElementsByTagName("head")[0].appendChild(o)},inject:function(e,t){var n=t||document,o=document.createElement("style");o.type="text/css",o.innerHTML=e;var i=n.getElementsByTagName("head")[0];try{i.appendChild(o)}catch{}}},Hs=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,Us=function(e,t){var n=e[t];return b.isArray(arguments[2])||b.isObject(arguments[2])?new Fs(e,t,arguments[2]):b.isNumber(n)?b.isNumber(arguments[2])&&b.isNumber(arguments[3])?b.isNumber(arguments[4])?new en(e,t,arguments[2],arguments[3],arguments[4]):new en(e,t,arguments[2],arguments[3]):b.isNumber(arguments[4])?new fo(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new fo(e,t,{min:arguments[2],max:arguments[3]}):b.isString(n)?new Ds(e,t):b.isFunction(n)?new yi(e,t,""):b.isBoolean(n)?new _i(e,t):null};function Gs(a){setTimeout(a,1e3/60)}var Ws=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Gs,Vs=(function(){function a(){Oe(this,a),this.backgroundElement=document.createElement("div"),b.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),v.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),b.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;v.bind(this.backgroundElement,"click",function(){e.hide()})}return ke(a,[{key:"show",value:function(){var t=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),b.defer(function(){t.backgroundElement.style.opacity=1,t.domElement.style.opacity=1,t.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var t=this,n=function o(){t.domElement.style.display="none",t.backgroundElement.style.display="none",v.unbind(t.domElement,"webkitTransitionEnd",o),v.unbind(t.domElement,"transitionend",o),v.unbind(t.domElement,"oTransitionEnd",o)};v.bind(this.domElement,"webkitTransitionEnd",n),v.bind(this.domElement,"transitionend",n),v.bind(this.domElement,"oTransitionEnd",n),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-v.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-v.getHeight(this.domElement)/2+"px"}}]),a})(),js=Os(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);Bs.inject(js);var $n="dg",qn=72,Yn=20,It="Default",Pt=(function(){try{return!!window.localStorage}catch{return!1}})(),Ft=void 0,Jn=!0,ht=void 0,No=!1,bi=[],J=function a(e){var t=this,n=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),v.addClass(this.domElement,$n),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],n=b.defaults(n,{closeOnTop:!1,autoPlace:!0,width:a.DEFAULT_WIDTH}),n=b.defaults(n,{resizable:n.autoPlace,hideable:n.autoPlace}),b.isUndefined(n.load)?n.load={preset:It}:n.preset&&(n.load.preset=n.preset),b.isUndefined(n.parent)&&n.hideable&&bi.push(this),n.resizable=b.isUndefined(n.parent)&&n.resizable,n.autoPlace&&b.isUndefined(n.scrollable)&&(n.scrollable=!0);var o=Pt&&localStorage.getItem(pt(this,"isLocal"))==="true",i=void 0,r=void 0;if(Object.defineProperties(this,{parent:{get:function(){return n.parent}},scrollable:{get:function(){return n.scrollable}},autoPlace:{get:function(){return n.autoPlace}},closeOnTop:{get:function(){return n.closeOnTop}},preset:{get:function(){return t.parent?t.getRoot().preset:n.load.preset},set:function(g){t.parent?t.getRoot().preset=g:n.load.preset=g,qs(this),t.revert()}},width:{get:function(){return n.width},set:function(g){n.width=g,sn(t,g)}},name:{get:function(){return n.name},set:function(g){n.name=g,r&&(r.innerHTML=n.name)}},closed:{get:function(){return n.closed},set:function(g){n.closed=g,n.closed?v.addClass(t.__ul,a.CLASS_CLOSED):v.removeClass(t.__ul,a.CLASS_CLOSED),this.onResize(),t.__closeButton&&(t.__closeButton.innerHTML=g?a.TEXT_OPEN:a.TEXT_CLOSED)}},load:{get:function(){return n.load}},useLocalStorage:{get:function(){return o},set:function(g){Pt&&(o=g,g?v.bind(window,"unload",i):v.unbind(window,"unload",i),localStorage.setItem(pt(t,"isLocal"),g))}}}),b.isUndefined(n.parent)){if(this.closed=n.closed||!1,v.addClass(this.domElement,a.CLASS_MAIN),v.makeSelectable(this.domElement,!1),Pt&&o){t.useLocalStorage=!0;var l=localStorage.getItem(pt(this,"gui"));l&&(n.load=JSON.parse(l))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=a.TEXT_CLOSED,v.addClass(this.__closeButton,a.CLASS_CLOSE_BUTTON),n.closeOnTop?(v.addClass(this.__closeButton,a.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(v.addClass(this.__closeButton,a.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),v.bind(this.__closeButton,"click",function(){t.closed=!t.closed})}else{n.closed===void 0&&(n.closed=!0);var c=document.createTextNode(n.name);v.addClass(c,"controller-name"),r=dn(t,c);var d=function(g){return g.preventDefault(),t.closed=!t.closed,!1};v.addClass(this.__ul,a.CLASS_CLOSED),v.addClass(r,"title"),v.bind(r,"click",d),n.closed||(this.closed=!1)}n.autoPlace&&(b.isUndefined(n.parent)&&(Jn&&(ht=document.createElement("div"),v.addClass(ht,$n),v.addClass(ht,a.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(ht),Jn=!1),ht.appendChild(this.domElement),v.addClass(this.domElement,a.CLASS_AUTO_PLACE)),this.parent||sn(t,n.width)),this.__resizeHandler=function(){t.onResizeDebounced()},v.bind(window,"resize",this.__resizeHandler),v.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),v.bind(this.__ul,"transitionend",this.__resizeHandler),v.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),n.resizable&&$s(this),i=function(){Pt&&localStorage.getItem(pt(t,"isLocal"))==="true"&&localStorage.setItem(pt(t,"gui"),JSON.stringify(t.getSaveObject()))},this.saveToLocalStorageIfPossible=i;function m(){var h=t.getRoot();h.width+=1,b.defer(function(){h.width-=1})}n.parent||m()};J.toggleHide=function(){No=!No,b.each(bi,function(a){a.domElement.style.display=No?"none":""})};J.CLASS_AUTO_PLACE="a";J.CLASS_AUTO_PLACE_CONTAINER="ac";J.CLASS_MAIN="main";J.CLASS_CONTROLLER_ROW="cr";J.CLASS_TOO_TALL="taller-than-window";J.CLASS_CLOSED="closed";J.CLASS_CLOSE_BUTTON="close-button";J.CLASS_CLOSE_TOP="close-top";J.CLASS_CLOSE_BOTTOM="close-bottom";J.CLASS_DRAG="drag";J.DEFAULT_WIDTH=245;J.TEXT_CLOSED="Close Controls";J.TEXT_OPEN="Open Controls";J._keydownHandler=function(a){document.activeElement.type!=="text"&&(a.which===qn||a.keyCode===qn)&&J.toggleHide()};v.bind(window,"keydown",J._keydownHandler,!1);b.extend(J.prototype,{add:function(e,t){return Dt(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return Dt(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;b.defer(function(){t.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&ht.removeChild(this.domElement);var e=this;b.each(this.__folders,function(t){e.removeFolder(t)}),v.unbind(window,"keydown",J._keydownHandler,!1),Zn(this)},addFolder:function(e){if(this.__folders[e]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var n=new J(t);this.__folders[e]=n;var o=dn(this,n.domElement);return v.addClass(o,"folder"),n},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],Zn(e);var t=this;b.each(e.__folders,function(n){e.removeFolder(n)}),b.defer(function(){t.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=v.getOffset(e.__ul).top,n=0;b.each(e.__ul.childNodes,function(o){e.autoPlace&&o===e.__save_row||(n+=v.getHeight(o))}),window.innerHeight-t-Yn<n?(v.addClass(e.domElement,J.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-Yn+"px"):(v.removeClass(e.domElement,J.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&b.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:b.debounce(function(){this.onResize()},50),remember:function(){if(b.isUndefined(Ft)&&(Ft=new Vs,Ft.domElement.innerHTML=Hs),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;b.each(Array.prototype.slice.call(arguments),function(t){e.__rememberedObjects.length===0&&Xs(e),e.__rememberedObjects.indexOf(t)===-1&&e.__rememberedObjects.push(t)}),this.autoPlace&&sn(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=so(this)),e.folders={},b.each(this.__folders,function(t,n){e.folders[n]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=so(this),on(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[It]=so(this,!0)),this.load.remembered[e]=so(this),this.preset=e,nn(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){b.each(this.__controllers,function(t){this.getRoot().load.remembered?Ci(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())},this),b.each(this.__folders,function(t){t.revert(t)}),e||on(this.getRoot(),!1)},listen:function(e){var t=this.__listening.length===0;this.__listening.push(e),t&&Si(this.__listening)},updateDisplay:function(){b.each(this.__controllers,function(e){e.updateDisplay()}),b.each(this.__folders,function(e){e.updateDisplay()})}});function dn(a,e,t){var n=document.createElement("li");return e&&n.appendChild(e),t?a.__ul.insertBefore(n,t):a.__ul.appendChild(n),a.onResize(),n}function Zn(a){v.unbind(window,"resize",a.__resizeHandler),a.saveToLocalStorageIfPossible&&v.unbind(window,"unload",a.saveToLocalStorageIfPossible)}function on(a,e){var t=a.__preset_select[a.__preset_select.selectedIndex];e?t.innerHTML=t.value+"*":t.innerHTML=t.value}function Ks(a,e,t){if(t.__li=e,t.__gui=a,b.extend(t,{options:function(r){if(arguments.length>1){var l=t.__li.nextElementSibling;return t.remove(),Dt(a,t.object,t.property,{before:l,factoryArgs:[b.toArray(arguments)]})}if(b.isArray(r)||b.isObject(r)){var c=t.__li.nextElementSibling;return t.remove(),Dt(a,t.object,t.property,{before:c,factoryArgs:[r]})}},name:function(r){return t.__li.firstElementChild.firstElementChild.innerHTML=r,t},listen:function(){return t.__gui.listen(t),t},remove:function(){return t.__gui.remove(t),t}}),t instanceof en){var n=new fo(t.object,t.property,{min:t.__min,max:t.__max,step:t.__step});b.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(i){var r=t[i],l=n[i];t[i]=n[i]=function(){var c=Array.prototype.slice.call(arguments);return l.apply(n,c),r.apply(t,c)}}),v.addClass(e,"has-slider"),t.domElement.insertBefore(n.domElement,t.domElement.firstElementChild)}else if(t instanceof fo){var o=function(r){if(b.isNumber(t.__min)&&b.isNumber(t.__max)){var l=t.__li.firstElementChild.firstElementChild.innerHTML,c=t.__gui.__listening.indexOf(t)>-1;t.remove();var d=Dt(a,t.object,t.property,{before:t.__li.nextElementSibling,factoryArgs:[t.__min,t.__max,t.__step]});return d.name(l),c&&d.listen(),d}return r};t.min=b.compose(o,t.min),t.max=b.compose(o,t.max)}else t instanceof _i?(v.bind(e,"click",function(){v.fakeEvent(t.__checkbox,"click")}),v.bind(t.__checkbox,"click",function(i){i.stopPropagation()})):t instanceof yi?(v.bind(e,"click",function(){v.fakeEvent(t.__button,"click")}),v.bind(e,"mouseover",function(){v.addClass(t.__button,"hover")}),v.bind(e,"mouseout",function(){v.removeClass(t.__button,"hover")})):t instanceof tn&&(v.addClass(e,"color"),t.updateDisplay=b.compose(function(i){return e.style.borderLeftColor=t.__color.toString(),i},t.updateDisplay),t.updateDisplay());t.setValue=b.compose(function(i){return a.getRoot().__preset_select&&t.isModified()&&on(a.getRoot(),!0),i},t.setValue)}function Ci(a,e){var t=a.getRoot(),n=t.__rememberedObjects.indexOf(e.object);if(n!==-1){var o=t.__rememberedObjectIndecesToControllers[n];if(o===void 0&&(o={},t.__rememberedObjectIndecesToControllers[n]=o),o[e.property]=e,t.load&&t.load.remembered){var i=t.load.remembered,r=void 0;if(i[a.preset])r=i[a.preset];else if(i[It])r=i[It];else return;if(r[n]&&r[n][e.property]!==void 0){var l=r[n][e.property];e.initialValue=l,e.setValue(l)}}}}function Dt(a,e,t,n){if(e[t]===void 0)throw new Error('Object "'+e+'" has no property "'+t+'"');var o=void 0;if(n.color)o=new tn(e,t);else{var i=[e,t].concat(n.factoryArgs);o=Us.apply(a,i)}n.before instanceof ot&&(n.before=n.before.__li),Ci(a,o),v.addClass(o.domElement,"c");var r=document.createElement("span");v.addClass(r,"property-name"),r.innerHTML=o.property;var l=document.createElement("div");l.appendChild(r),l.appendChild(o.domElement);var c=dn(a,l,n.before);return v.addClass(c,J.CLASS_CONTROLLER_ROW),o instanceof tn?v.addClass(c,"color"):v.addClass(c,Ps(o.getValue())),Ks(a,c,o),a.__controllers.push(o),o}function pt(a,e){return document.location.href+"."+e}function nn(a,e,t){var n=document.createElement("option");n.innerHTML=e,n.value=e,a.__preset_select.appendChild(n),t&&(a.__preset_select.selectedIndex=a.__preset_select.length-1)}function Qn(a,e){e.style.display=a.useLocalStorage?"block":"none"}function Xs(a){var e=a.__save_row=document.createElement("li");v.addClass(a.domElement,"has-save"),a.__ul.insertBefore(e,a.__ul.firstChild),v.addClass(e,"save-row");var t=document.createElement("span");t.innerHTML="&nbsp;",v.addClass(t,"button gears");var n=document.createElement("span");n.innerHTML="Save",v.addClass(n,"button"),v.addClass(n,"save");var o=document.createElement("span");o.innerHTML="New",v.addClass(o,"button"),v.addClass(o,"save-as");var i=document.createElement("span");i.innerHTML="Revert",v.addClass(i,"button"),v.addClass(i,"revert");var r=a.__preset_select=document.createElement("select");if(a.load&&a.load.remembered?b.each(a.load.remembered,function(h,g){nn(a,g,g===a.preset)}):nn(a,It,!1),v.bind(r,"change",function(){for(var h=0;h<a.__preset_select.length;h++)a.__preset_select[h].innerHTML=a.__preset_select[h].value;a.preset=this.value}),e.appendChild(r),e.appendChild(t),e.appendChild(n),e.appendChild(o),e.appendChild(i),Pt){var l=document.getElementById("dg-local-explain"),c=document.getElementById("dg-local-storage"),d=document.getElementById("dg-save-locally");d.style.display="block",localStorage.getItem(pt(a,"isLocal"))==="true"&&c.setAttribute("checked","checked"),Qn(a,l),v.bind(c,"change",function(){a.useLocalStorage=!a.useLocalStorage,Qn(a,l)})}var m=document.getElementById("dg-new-constructor");v.bind(m,"keydown",function(h){h.metaKey&&(h.which===67||h.keyCode===67)&&Ft.hide()}),v.bind(t,"click",function(){m.innerHTML=JSON.stringify(a.getSaveObject(),void 0,2),Ft.show(),m.focus(),m.select()}),v.bind(n,"click",function(){a.save()}),v.bind(o,"click",function(){var h=prompt("Enter a new preset name.");h&&a.saveAs(h)}),v.bind(i,"click",function(){a.revert()})}function $s(a){var e=void 0;a.__resize_handle=document.createElement("div"),b.extend(a.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function t(i){return i.preventDefault(),a.width+=e-i.clientX,a.onResize(),e=i.clientX,!1}function n(){v.removeClass(a.__closeButton,J.CLASS_DRAG),v.unbind(window,"mousemove",t),v.unbind(window,"mouseup",n)}function o(i){return i.preventDefault(),e=i.clientX,v.addClass(a.__closeButton,J.CLASS_DRAG),v.bind(window,"mousemove",t),v.bind(window,"mouseup",n),!1}v.bind(a.__resize_handle,"mousedown",o),v.bind(a.__closeButton,"mousedown",o),a.domElement.insertBefore(a.__resize_handle,a.domElement.firstElementChild)}function sn(a,e){a.domElement.style.width=e+"px",a.__save_row&&a.autoPlace&&(a.__save_row.style.width=e+"px"),a.__closeButton&&(a.__closeButton.style.width=e+"px")}function so(a,e){var t={};return b.each(a.__rememberedObjects,function(n,o){var i={},r=a.__rememberedObjectIndecesToControllers[o];b.each(r,function(l,c){i[c]=e?l.initialValue:l.getValue()}),t[o]=i}),t}function qs(a){for(var e=0;e<a.__preset_select.length;e++)a.__preset_select[e].value===a.preset&&(a.__preset_select.selectedIndex=e)}function Si(a){a.length!==0&&Ws.call(window,function(){Si(a)}),b.each(a,function(e){e.updateDisplay()})}var Ys=J;function ei(a,e){if(e===Zi)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),a;if(e===Vo||e===si){let t=a.getIndex();if(t===null){const r=[],l=a.getAttribute("position");if(l!==void 0){for(let c=0;c<l.count;c++)r.push(c);a.setIndex(r),t=a.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),a}const n=t.count-2,o=[];if(e===Vo)for(let r=1;r<=n;r++)o.push(t.getX(0)),o.push(t.getX(r)),o.push(t.getX(r+1));else for(let r=0;r<n;r++)r%2===0?(o.push(t.getX(r)),o.push(t.getX(r+1)),o.push(t.getX(r+2))):(o.push(t.getX(r+2)),o.push(t.getX(r+1)),o.push(t.getX(r)));o.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=a.clone();return i.setIndex(o),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),a}class Js extends ri{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new or(t)}),this.register(function(t){return new nr(t)}),this.register(function(t){return new fr(t)}),this.register(function(t){return new hr(t)}),this.register(function(t){return new pr(t)}),this.register(function(t){return new sr(t)}),this.register(function(t){return new rr(t)}),this.register(function(t){return new ar(t)}),this.register(function(t){return new lr(t)}),this.register(function(t){return new tr(t)}),this.register(function(t){return new cr(t)}),this.register(function(t){return new ir(t)}),this.register(function(t){return new ur(t)}),this.register(function(t){return new dr(t)}),this.register(function(t){return new Qs(t)}),this.register(function(t){return new mr(t)}),this.register(function(t){return new gr(t)})}load(e,t,n,o){const i=this;let r;if(this.resourcePath!=="")r=this.resourcePath;else if(this.path!==""){const d=Rt.extractUrlBase(e);r=Rt.resolveURL(d,this.path)}else r=Rt.extractUrlBase(e);this.manager.itemStart(e);const l=function(d){o?o(d):console.error(d),i.manager.itemError(e),i.manager.itemEnd(e)},c=new ro(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(e,function(d){try{i.parse(d,r,function(m){t(m),i.manager.itemEnd(e)},l)}catch(m){l(m)}},n,l)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,o){let i;const r={},l={},c=new TextDecoder;if(typeof e=="string")i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(c.decode(new Uint8Array(e,0,4))===xi){try{r[W.KHR_BINARY_GLTF]=new vr(e)}catch(h){o&&o(h);return}i=JSON.parse(r[W.KHR_BINARY_GLTF].content)}else i=JSON.parse(c.decode(e));else i=e;if(i.asset===void 0||i.asset.version[0]<2){o&&o(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const d=new kr(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});d.fileLoader.setRequestHeader(this.requestHeader);for(let m=0;m<this.pluginCallbacks.length;m++){const h=this.pluginCallbacks[m](d);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),l[h.name]=h,r[h.name]=!0}if(i.extensionsUsed)for(let m=0;m<i.extensionsUsed.length;++m){const h=i.extensionsUsed[m],g=i.extensionsRequired||[];switch(h){case W.KHR_MATERIALS_UNLIT:r[h]=new er;break;case W.KHR_DRACO_MESH_COMPRESSION:r[h]=new _r(i,this.dracoLoader);break;case W.KHR_TEXTURE_TRANSFORM:r[h]=new wr;break;case W.KHR_MESH_QUANTIZATION:r[h]=new yr;break;default:g.indexOf(h)>=0&&l[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}d.setExtensions(r),d.setPlugins(l),d.parse(n,o)}parseAsync(e,t){const n=this;return new Promise(function(o,i){n.parse(e,t,o,i)})}}function Zs(){let a={};return{get:function(e){return a[e]},add:function(e,t){a[e]=t},remove:function(e){delete a[e]},removeAll:function(){a={}}}}const W={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Qs{constructor(e){this.parser=e,this.name=W.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,o=t.length;n<o;n++){const i=t[n];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let o=t.cache.get(n);if(o)return o;const i=t.json,c=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let d;const m=new X(16777215);c.color!==void 0&&m.setRGB(c.color[0],c.color[1],c.color[2],Ie);const h=c.range!==void 0?c.range:0;switch(c.type){case"directional":d=new ai(m),d.target.position.set(0,0,-1),d.add(d.target);break;case"point":d=new es(m),d.distance=h;break;case"spot":d=new Qi(m),d.distance=h,c.spot=c.spot||{},c.spot.innerConeAngle=c.spot.innerConeAngle!==void 0?c.spot.innerConeAngle:0,c.spot.outerConeAngle=c.spot.outerConeAngle!==void 0?c.spot.outerConeAngle:Math.PI/4,d.angle=c.spot.outerConeAngle,d.penumbra=1-c.spot.innerConeAngle/c.spot.outerConeAngle,d.target.position.set(0,0,-1),d.add(d.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+c.type)}return d.position.set(0,0,0),De(d,c),c.intensity!==void 0&&(d.intensity=c.intensity),d.name=t.createUniqueName(c.name||"light_"+e),o=Promise.resolve(d),t.cache.add(n,o),o}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,i=n.json.nodes[e],l=(i.extensions&&i.extensions[this.name]||{}).light;return l===void 0?null:this._loadLight(l).then(function(c){return n._getNodeRef(t.cache,l,c)})}}class er{constructor(){this.name=W.KHR_MATERIALS_UNLIT}getMaterialType(){return kt}extendParams(e,t,n){const o=[];e.color=new X(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const r=i.baseColorFactor;e.color.setRGB(r[0],r[1],r[2],Ie),e.opacity=r[3]}i.baseColorTexture!==void 0&&o.push(n.assignTexture(e,"map",i.baseColorTexture,Xe))}return Promise.all(o)}}class tr{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const o=this.parser.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=o.extensions[this.name].emissiveStrength;return i!==void 0&&(t.emissiveIntensity=i),Promise.resolve()}}class or{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],r=o.extensions[this.name];if(r.clearcoatFactor!==void 0&&(t.clearcoat=r.clearcoatFactor),r.clearcoatTexture!==void 0&&i.push(n.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),r.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),r.clearcoatRoughnessTexture!==void 0&&i.push(n.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),r.clearcoatNormalTexture!==void 0&&(i.push(n.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),r.clearcoatNormalTexture.scale!==void 0)){const l=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new ao(l,l)}return Promise.all(i)}}class nr{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_DISPERSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const o=this.parser.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=o.extensions[this.name];return t.dispersion=i.dispersion!==void 0?i.dispersion:0,Promise.resolve()}}class ir{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],r=o.extensions[this.name];return r.iridescenceFactor!==void 0&&(t.iridescence=r.iridescenceFactor),r.iridescenceTexture!==void 0&&i.push(n.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),r.iridescenceIor!==void 0&&(t.iridescenceIOR=r.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),r.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),r.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),r.iridescenceThicknessTexture!==void 0&&i.push(n.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(i)}}class sr{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_SHEEN}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new X(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=o.extensions[this.name];if(r.sheenColorFactor!==void 0){const l=r.sheenColorFactor;t.sheenColor.setRGB(l[0],l[1],l[2],Ie)}return r.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=r.sheenRoughnessFactor),r.sheenColorTexture!==void 0&&i.push(n.assignTexture(t,"sheenColorMap",r.sheenColorTexture,Xe)),r.sheenRoughnessTexture!==void 0&&i.push(n.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(i)}}class rr{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],r=o.extensions[this.name];return r.transmissionFactor!==void 0&&(t.transmission=r.transmissionFactor),r.transmissionTexture!==void 0&&i.push(n.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(i)}}class ar{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_VOLUME}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],r=o.extensions[this.name];t.thickness=r.thicknessFactor!==void 0?r.thicknessFactor:0,r.thicknessTexture!==void 0&&i.push(n.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const l=r.attenuationColor||[1,1,1];return t.attenuationColor=new X().setRGB(l[0],l[1],l[2],Ie),Promise.all(i)}}class lr{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_IOR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const o=this.parser.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=o.extensions[this.name];return t.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class cr{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_SPECULAR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],r=o.extensions[this.name];t.specularIntensity=r.specularFactor!==void 0?r.specularFactor:1,r.specularTexture!==void 0&&i.push(n.assignTexture(t,"specularIntensityMap",r.specularTexture));const l=r.specularColorFactor||[1,1,1];return t.specularColor=new X().setRGB(l[0],l[1],l[2],Ie),r.specularColorTexture!==void 0&&i.push(n.assignTexture(t,"specularColorMap",r.specularColorTexture,Xe)),Promise.all(i)}}class dr{constructor(e){this.parser=e,this.name=W.EXT_MATERIALS_BUMP}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],r=o.extensions[this.name];return t.bumpScale=r.bumpFactor!==void 0?r.bumpFactor:1,r.bumpTexture!==void 0&&i.push(n.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(i)}}class ur{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Ne}extendMaterialParams(e,t){const n=this.parser,o=n.json.materials[e];if(!o.extensions||!o.extensions[this.name])return Promise.resolve();const i=[],r=o.extensions[this.name];return r.anisotropyStrength!==void 0&&(t.anisotropy=r.anisotropyStrength),r.anisotropyRotation!==void 0&&(t.anisotropyRotation=r.anisotropyRotation),r.anisotropyTexture!==void 0&&i.push(n.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(i)}}class fr{constructor(e){this.parser=e,this.name=W.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,o=n.textures[e];if(!o.extensions||!o.extensions[this.name])return null;const i=o.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,r)}}class hr{constructor(e){this.parser=e,this.name=W.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,n=this.parser,o=n.json,i=o.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],l=o.images[r.source];let c=n.textureLoader;if(l.uri){const d=n.options.manager.getHandler(l.uri);d!==null&&(c=d)}return n.loadTextureImage(e,r.source,c)}}class pr{constructor(e){this.parser=e,this.name=W.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,n=this.parser,o=n.json,i=o.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],l=o.images[r.source];let c=n.textureLoader;if(l.uri){const d=n.options.manager.getHandler(l.uri);d!==null&&(c=d)}return n.loadTextureImage(e,r.source,c)}}class mr{constructor(e){this.name=W.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const o=n.extensions[this.name],i=this.parser.getDependency("buffer",o.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(l){const c=o.byteOffset||0,d=o.byteLength||0,m=o.count,h=o.byteStride,g=new Uint8Array(l,c,d);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(m,h,g,o.mode,o.filter).then(function(C){return C.buffer}):r.ready.then(function(){const C=new ArrayBuffer(m*h);return r.decodeGltfBuffer(new Uint8Array(C),m,h,g,o.mode,o.filter),C})})}else return null}}class gr{constructor(e){this.name=W.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||n.mesh===void 0)return null;const o=t.meshes[n.mesh];for(const d of o.primitives)if(d.mode!==Ae.TRIANGLES&&d.mode!==Ae.TRIANGLE_STRIP&&d.mode!==Ae.TRIANGLE_FAN&&d.mode!==void 0)return null;const r=n.extensions[this.name].attributes,l=[],c={};for(const d in r)l.push(this.parser.getDependency("accessor",r[d]).then(m=>(c[d]=m,c[d])));return l.length<1?null:(l.push(this.parser.createNodeMesh(e)),Promise.all(l).then(d=>{const m=d.pop(),h=m.isGroup?m.children:[m],g=d[0].count,C=[];for(const T of h){const S=new lo,x=new Ke,L=new li,U=new Ke(1,1,1),z=new ts(T.geometry,T.material,g);for(let B=0;B<g;B++)c.TRANSLATION&&x.fromBufferAttribute(c.TRANSLATION,B),c.ROTATION&&L.fromBufferAttribute(c.ROTATION,B),c.SCALE&&U.fromBufferAttribute(c.SCALE,B),z.setMatrixAt(B,S.compose(x,L,U));for(const B in c)if(B==="_COLOR_0"){const q=c[B];z.instanceColor=new os(q.array,q.itemSize,q.normalized)}else B!=="TRANSLATION"&&B!=="ROTATION"&&B!=="SCALE"&&T.geometry.setAttribute(B,c[B]);ci.prototype.copy.call(z,T),this.parser.assignFinalMaterial(z),C.push(z)}return m.isGroup?(m.clear(),m.add(...C),m):C[0]}))}}const xi="glTF",Mt=12,ti={JSON:1313821514,BIN:5130562};class vr{constructor(e){this.name=W.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Mt),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==xi)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const o=this.header.length-Mt,i=new DataView(e,Mt);let r=0;for(;r<o;){const l=i.getUint32(r,!0);r+=4;const c=i.getUint32(r,!0);if(r+=4,c===ti.JSON){const d=new Uint8Array(e,Mt+r,l);this.content=n.decode(d)}else if(c===ti.BIN){const d=Mt+r;this.body=e.slice(d,d+l)}r+=l}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class _r{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=W.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,o=this.dracoLoader,i=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,l={},c={},d={};for(const m in r){const h=rn[m]||m.toLowerCase();l[h]=r[m]}for(const m in e.attributes){const h=rn[m]||m.toLowerCase();if(r[m]!==void 0){const g=n.accessors[e.attributes[m]],C=gt[g.componentType];d[h]=C.name,c[h]=g.normalized===!0}}return t.getDependency("bufferView",i).then(function(m){return new Promise(function(h,g){o.decodeDracoFile(m,function(C){for(const T in C.attributes){const S=C.attributes[T],x=c[T];x!==void 0&&(S.normalized=x)}h(C)},l,d,Ie,g)})})}}class wr{constructor(){this.name=W.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class yr{constructor(){this.name=W.KHR_MESH_QUANTIZATION}}class Ti extends xs{constructor(e,t,n,o){super(e,t,n,o)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,o=this.valueSize,i=e*o*3+o;for(let r=0;r!==o;r++)t[r]=n[i+r];return t}interpolate_(e,t,n,o){const i=this.resultBuffer,r=this.sampleValues,l=this.valueSize,c=l*2,d=l*3,m=o-t,h=(n-t)/m,g=h*h,C=g*h,T=e*d,S=T-d,x=-2*C+3*g,L=C-g,U=1-x,z=L-g+h;for(let B=0;B!==l;B++){const q=r[S+B+l],ce=r[S+B+c]*m,Y=r[T+B+l],de=r[T+B]*m;i[B]=U*q+z*ce+x*Y+L*de}return i}}const br=new li;class Cr extends Ti{interpolate_(e,t,n,o){const i=super.interpolate_(e,t,n,o);return br.fromArray(i).normalize().toArray(i),i}}const Ae={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},gt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},oi={9728:fi,9729:jo,9984:as,9985:rs,9986:ss,9987:ui},ni={33071:cs,33648:ls,10497:Ko},zo={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},rn={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},je={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Sr={CUBICSPLINE:void 0,LINEAR:mi,STEP:Cs},Bo={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function xr(a){return a.DefaultMaterial===void 0&&(a.DefaultMaterial=new hi({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Ss})),a.DefaultMaterial}function tt(a,e,t){for(const n in t.extensions)a[n]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=t.extensions[n])}function De(a,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(a.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Tr(a,e,t){let n=!1,o=!1,i=!1;for(let d=0,m=e.length;d<m;d++){const h=e[d];if(h.POSITION!==void 0&&(n=!0),h.NORMAL!==void 0&&(o=!0),h.COLOR_0!==void 0&&(i=!0),n&&o&&i)break}if(!n&&!o&&!i)return Promise.resolve(a);const r=[],l=[],c=[];for(let d=0,m=e.length;d<m;d++){const h=e[d];if(n){const g=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):a.attributes.position;r.push(g)}if(o){const g=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):a.attributes.normal;l.push(g)}if(i){const g=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):a.attributes.color;c.push(g)}}return Promise.all([Promise.all(r),Promise.all(l),Promise.all(c)]).then(function(d){const m=d[0],h=d[1],g=d[2];return n&&(a.morphAttributes.position=m),o&&(a.morphAttributes.normal=h),i&&(a.morphAttributes.color=g),a.morphTargetsRelative=!0,a})}function Ar(a,e){if(a.updateMorphTargets(),e.weights!==void 0)for(let t=0,n=e.weights.length;t<n;t++)a.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(a.morphTargetInfluences.length===t.length){a.morphTargetDictionary={};for(let n=0,o=t.length;n<o;n++)a.morphTargetDictionary[t[n]]=n}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Er(a){let e;const t=a.extensions&&a.extensions[W.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Ho(t.attributes):e=a.indices+":"+Ho(a.attributes)+":"+a.mode,a.targets!==void 0)for(let n=0,o=a.targets.length;n<o;n++)e+=":"+Ho(a.targets[n]);return e}function Ho(a){let e="";const t=Object.keys(a).sort();for(let n=0,o=t.length;n<o;n++)e+=t[n]+":"+a[t[n]]+";";return e}function an(a){switch(a){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Mr(a){return a.search(/\.jpe?g($|\?)/i)>0||a.search(/^data\:image\/jpeg/)===0?"image/jpeg":a.search(/\.webp($|\?)/i)>0||a.search(/^data\:image\/webp/)===0?"image/webp":a.search(/\.ktx2($|\?)/i)>0||a.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Or=new lo;class kr{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Zs,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,o=-1,i=!1,r=-1;if(typeof navigator<"u"){const l=navigator.userAgent;n=/^((?!chrome|android).)*safari/i.test(l)===!0;const c=l.match(/Version\/(\d+)/);o=n&&c?parseInt(c[1],10):-1,i=l.indexOf("Firefox")>-1,r=i?l.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||n&&o<17||i&&r<98?this.textureLoader=new ns(this.options.manager):this.textureLoader=new is(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ro(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,o=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(r){return r._markDefs&&r._markDefs()}),Promise.all(this._invokeAll(function(r){return r.beforeRoot&&r.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(r){const l={scene:r[0][o.scene||0],scenes:r[0],animations:r[1],cameras:r[2],asset:o.asset,parser:n,userData:{}};return tt(i,l,o),De(l,o),Promise.all(n._invokeAll(function(c){return c.afterRoot&&c.afterRoot(l)})).then(function(){for(const c of l.scenes)c.updateMatrixWorld();e(l)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let o=0,i=t.length;o<i;o++){const r=t[o].joints;for(let l=0,c=r.length;l<c;l++)e[r[l]].isBone=!0}for(let o=0,i=e.length;o<i;o++){const r=e[o];r.mesh!==void 0&&(this._addNodeRef(this.meshCache,r.mesh),r.skin!==void 0&&(n[r.mesh].isSkinnedMesh=!0)),r.camera!==void 0&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const o=n.clone(),i=(r,l)=>{const c=this.associations.get(r);c!=null&&this.associations.set(l,c);for(const[d,m]of r.children.entries())i(m,l.children[d])};return i(n,o),o.name+="_instance_"+e.uses[t]++,o}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const o=e(t[n]);if(o)return o}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let o=0;o<t.length;o++){const i=e(t[o]);i&&n.push(i)}return n}getDependency(e,t){const n=e+":"+t;let o=this.cache.get(n);if(!o){switch(e){case"scene":o=this.loadScene(t);break;case"node":o=this._invokeOne(function(i){return i.loadNode&&i.loadNode(t)});break;case"mesh":o=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(t)});break;case"accessor":o=this.loadAccessor(t);break;case"bufferView":o=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(t)});break;case"buffer":o=this.loadBuffer(t);break;case"material":o=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(t)});break;case"texture":o=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(t)});break;case"skin":o=this.loadSkin(t);break;case"animation":o=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(t)});break;case"camera":o=this.loadCamera(t);break;default:if(o=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)}),!o)throw new Error("Unknown type: "+e);break}this.cache.add(n,o)}return o}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,o=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(o.map(function(i,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[W.KHR_BINARY_GLTF].body);const o=this.options;return new Promise(function(i,r){n.load(Rt.resolveURL(t.uri,o.path),i,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(n){const o=t.byteLength||0,i=t.byteOffset||0;return n.slice(i,i+o)})}loadAccessor(e){const t=this,n=this.json,o=this.json.accessors[e];if(o.bufferView===void 0&&o.sparse===void 0){const r=zo[o.type],l=gt[o.componentType],c=o.normalized===!0,d=new l(o.count*r);return Promise.resolve(new ge(d,r,c))}const i=[];return o.bufferView!==void 0?i.push(this.getDependency("bufferView",o.bufferView)):i.push(null),o.sparse!==void 0&&(i.push(this.getDependency("bufferView",o.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",o.sparse.values.bufferView))),Promise.all(i).then(function(r){const l=r[0],c=zo[o.type],d=gt[o.componentType],m=d.BYTES_PER_ELEMENT,h=m*c,g=o.byteOffset||0,C=o.bufferView!==void 0?n.bufferViews[o.bufferView].byteStride:void 0,T=o.normalized===!0;let S,x;if(C&&C!==h){const L=Math.floor(g/C),U="InterleavedBuffer:"+o.bufferView+":"+o.componentType+":"+L+":"+o.count;let z=t.cache.get(U);z||(S=new d(l,L*C,o.count*C/m),z=new di(S,C/m),t.cache.add(U,z)),x=new gi(z,c,g%C/m,T)}else l===null?S=new d(o.count*c):S=new d(l,g,o.count*c),x=new ge(S,c,T);if(o.sparse!==void 0){const L=zo.SCALAR,U=gt[o.sparse.indices.componentType],z=o.sparse.indices.byteOffset||0,B=o.sparse.values.byteOffset||0,q=new U(r[1],z,o.sparse.count*L),ce=new d(r[2],B,o.sparse.count*c);l!==null&&(x=new ge(x.array.slice(),x.itemSize,x.normalized)),x.normalized=!1;for(let Y=0,de=q.length;Y<de;Y++){const Se=q[Y];if(x.setX(Se,ce[Y*c]),c>=2&&x.setY(Se,ce[Y*c+1]),c>=3&&x.setZ(Se,ce[Y*c+2]),c>=4&&x.setW(Se,ce[Y*c+3]),c>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}x.normalized=T}return x})}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e].source,r=t.images[i];let l=this.textureLoader;if(r.uri){const c=n.manager.getHandler(r.uri);c!==null&&(l=c)}return this.loadTextureImage(e,i,l)}loadTextureImage(e,t,n){const o=this,i=this.json,r=i.textures[e],l=i.images[t],c=(l.uri||l.bufferView)+":"+r.sampler;if(this.textureCache[c])return this.textureCache[c];const d=this.loadImageSource(t,n).then(function(m){m.flipY=!1,m.name=r.name||l.name||"",m.name===""&&typeof l.uri=="string"&&l.uri.startsWith("data:image/")===!1&&(m.name=l.uri);const g=(i.samplers||{})[r.sampler]||{};return m.magFilter=oi[g.magFilter]||jo,m.minFilter=oi[g.minFilter]||ui,m.wrapS=ni[g.wrapS]||Ko,m.wrapT=ni[g.wrapT]||Ko,m.generateMipmaps=!m.isCompressedTexture&&m.minFilter!==fi&&m.minFilter!==jo,o.associations.set(m,{textures:e}),m}).catch(function(){return null});return this.textureCache[c]=d,d}loadImageSource(e,t){const n=this,o=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const r=o.images[e],l=self.URL||self.webkitURL;let c=r.uri||"",d=!1;if(r.bufferView!==void 0)c=n.getDependency("bufferView",r.bufferView).then(function(h){d=!0;const g=new Blob([h],{type:r.mimeType});return c=l.createObjectURL(g),c});else if(r.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const m=Promise.resolve(c).then(function(h){return new Promise(function(g,C){let T=g;t.isImageBitmapLoader===!0&&(T=function(S){const x=new Yo(S);x.needsUpdate=!0,g(x)}),t.load(Rt.resolveURL(h,i.path),T,void 0,C)})}).then(function(h){return d===!0&&l.revokeObjectURL(c),De(h,r),h.userData.mimeType=r.mimeType||Mr(r.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),h});return this.sourceCache[e]=m,m}assignTexture(e,t,n,o){const i=this;return this.getDependency("texture",n.index).then(function(r){if(!r)return null;if(n.texCoord!==void 0&&n.texCoord>0&&(r=r.clone(),r.channel=n.texCoord),i.extensions[W.KHR_TEXTURE_TRANSFORM]){const l=n.extensions!==void 0?n.extensions[W.KHR_TEXTURE_TRANSFORM]:void 0;if(l){const c=i.associations.get(r);r=i.extensions[W.KHR_TEXTURE_TRANSFORM].extendTexture(r,l),i.associations.set(r,c)}}return o!==void 0&&(r.colorSpace=o),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const o=t.attributes.tangent===void 0,i=t.attributes.color!==void 0,r=t.attributes.normal===void 0;if(e.isPoints){const l="PointsMaterial:"+n.uuid;let c=this.cache.get(l);c||(c=new ds,Do.prototype.copy.call(c,n),c.color.copy(n.color),c.map=n.map,c.sizeAttenuation=!1,this.cache.add(l,c)),n=c}else if(e.isLine){const l="LineBasicMaterial:"+n.uuid;let c=this.cache.get(l);c||(c=new us,Do.prototype.copy.call(c,n),c.color.copy(n.color),c.map=n.map,this.cache.add(l,c)),n=c}if(o||i||r){let l="ClonedMaterial:"+n.uuid+":";o&&(l+="derivative-tangents:"),i&&(l+="vertex-colors:"),r&&(l+="flat-shading:");let c=this.cache.get(l);c||(c=n.clone(),i&&(c.vertexColors=!0),r&&(c.flatShading=!0),o&&(c.normalScale&&(c.normalScale.y*=-1),c.clearcoatNormalScale&&(c.clearcoatNormalScale.y*=-1)),this.cache.add(l,c),this.associations.set(c,this.associations.get(n))),n=c}e.material=n}getMaterialType(){return hi}loadMaterial(e){const t=this,n=this.json,o=this.extensions,i=n.materials[e];let r;const l={},c=i.extensions||{},d=[];if(c[W.KHR_MATERIALS_UNLIT]){const h=o[W.KHR_MATERIALS_UNLIT];r=h.getMaterialType(),d.push(h.extendParams(l,i,t))}else{const h=i.pbrMetallicRoughness||{};if(l.color=new X(1,1,1),l.opacity=1,Array.isArray(h.baseColorFactor)){const g=h.baseColorFactor;l.color.setRGB(g[0],g[1],g[2],Ie),l.opacity=g[3]}h.baseColorTexture!==void 0&&d.push(t.assignTexture(l,"map",h.baseColorTexture,Xe)),l.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,l.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(d.push(t.assignTexture(l,"metalnessMap",h.metallicRoughnessTexture)),d.push(t.assignTexture(l,"roughnessMap",h.metallicRoughnessTexture))),r=this._invokeOne(function(g){return g.getMaterialType&&g.getMaterialType(e)}),d.push(Promise.all(this._invokeAll(function(g){return g.extendMaterialParams&&g.extendMaterialParams(e,l)})))}i.doubleSided===!0&&(l.side=Xo);const m=i.alphaMode||Bo.OPAQUE;if(m===Bo.BLEND?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,m===Bo.MASK&&(l.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&r!==kt&&(d.push(t.assignTexture(l,"normalMap",i.normalTexture)),l.normalScale=new ao(1,1),i.normalTexture.scale!==void 0)){const h=i.normalTexture.scale;l.normalScale.set(h,h)}if(i.occlusionTexture!==void 0&&r!==kt&&(d.push(t.assignTexture(l,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(l.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&r!==kt){const h=i.emissiveFactor;l.emissive=new X().setRGB(h[0],h[1],h[2],Ie)}return i.emissiveTexture!==void 0&&r!==kt&&d.push(t.assignTexture(l,"emissiveMap",i.emissiveTexture,Xe)),Promise.all(d).then(function(){const h=new r(l);return i.name&&(h.name=i.name),De(h,i),t.associations.set(h,{materials:e}),i.extensions&&tt(o,h,i),h})}createUniqueName(e){const t=fs.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,o=this.primitiveCache;function i(l){return n[W.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(l,t).then(function(c){return ii(c,l,t)})}const r=[];for(let l=0,c=e.length;l<c;l++){const d=e[l],m=Er(d),h=o[m];if(h)r.push(h.promise);else{let g;d.extensions&&d.extensions[W.KHR_DRACO_MESH_COMPRESSION]?g=i(d):g=ii(new co,d,t),o[m]={primitive:d,promise:g},r.push(g)}}return Promise.all(r)}loadMesh(e){const t=this,n=this.json,o=this.extensions,i=n.meshes[e],r=i.primitives,l=[];for(let c=0,d=r.length;c<d;c++){const m=r[c].material===void 0?xr(this.cache):this.getDependency("material",r[c].material);l.push(m)}return l.push(t.loadGeometries(r)),Promise.all(l).then(function(c){const d=c.slice(0,c.length-1),m=c[c.length-1],h=[];for(let C=0,T=m.length;C<T;C++){const S=m[C],x=r[C];let L;const U=d[C];if(x.mode===Ae.TRIANGLES||x.mode===Ae.TRIANGLE_STRIP||x.mode===Ae.TRIANGLE_FAN||x.mode===void 0)L=i.isSkinnedMesh===!0?new hs(S,U):new $o(S,U),L.isSkinnedMesh===!0&&L.normalizeSkinWeights(),x.mode===Ae.TRIANGLE_STRIP?L.geometry=ei(L.geometry,si):x.mode===Ae.TRIANGLE_FAN&&(L.geometry=ei(L.geometry,Vo));else if(x.mode===Ae.LINES)L=new ps(S,U);else if(x.mode===Ae.LINE_STRIP)L=new ms(S,U);else if(x.mode===Ae.LINE_LOOP)L=new gs(S,U);else if(x.mode===Ae.POINTS)L=new qo(S,U);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+x.mode);Object.keys(L.geometry.morphAttributes).length>0&&Ar(L,i),L.name=t.createUniqueName(i.name||"mesh_"+e),De(L,i),x.extensions&&tt(o,L,x),t.assignFinalMaterial(L),h.push(L)}for(let C=0,T=h.length;C<T;C++)t.associations.set(h[C],{meshes:e,primitives:C});if(h.length===1)return i.extensions&&tt(o,h[0],i),h[0];const g=new Lt;i.extensions&&tt(o,g,i),t.associations.set(g,{meshes:e});for(let C=0,T=h.length;C<T;C++)g.add(h[C]);return g})}loadCamera(e){let t;const n=this.json.cameras[e],o=n[n.type];if(!o){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return n.type==="perspective"?t=new vs(_s.radToDeg(o.yfov),o.aspectRatio||1,o.znear||1,o.zfar||2e6):n.type==="orthographic"&&(t=new pi(-o.xmag,o.xmag,o.ymag,-o.ymag,o.znear,o.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),De(t,n),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],n=[];for(let o=0,i=t.joints.length;o<i;o++)n.push(this._loadNodeShallow(t.joints[o]));return t.inverseBindMatrices!==void 0?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(o){const i=o.pop(),r=o,l=[],c=[];for(let d=0,m=r.length;d<m;d++){const h=r[d];if(h){l.push(h);const g=new lo;i!==null&&g.fromArray(i.array,d*16),c.push(g)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[d])}return new ws(l,c)})}loadAnimation(e){const t=this.json,n=this,o=t.animations[e],i=o.name?o.name:"animation_"+e,r=[],l=[],c=[],d=[],m=[];for(let h=0,g=o.channels.length;h<g;h++){const C=o.channels[h],T=o.samplers[C.sampler],S=C.target,x=S.node,L=o.parameters!==void 0?o.parameters[T.input]:T.input,U=o.parameters!==void 0?o.parameters[T.output]:T.output;S.node!==void 0&&(r.push(this.getDependency("node",x)),l.push(this.getDependency("accessor",L)),c.push(this.getDependency("accessor",U)),d.push(T),m.push(S))}return Promise.all([Promise.all(r),Promise.all(l),Promise.all(c),Promise.all(d),Promise.all(m)]).then(function(h){const g=h[0],C=h[1],T=h[2],S=h[3],x=h[4],L=[];for(let z=0,B=g.length;z<B;z++){const q=g[z],ce=C[z],Y=T[z],de=S[z],Se=x[z];if(q===void 0)continue;q.updateMatrix&&q.updateMatrix();const he=n._createAnimationTracks(q,ce,Y,de,Se);if(he)for(let ye=0;ye<he.length;ye++)L.push(he[ye])}const U=new ys(i,void 0,L);return De(U,o),U})}createNodeMesh(e){const t=this.json,n=this,o=t.nodes[e];return o.mesh===void 0?null:n.getDependency("mesh",o.mesh).then(function(i){const r=n._getNodeRef(n.meshCache,o.mesh,i);return o.weights!==void 0&&r.traverse(function(l){if(l.isMesh)for(let c=0,d=o.weights.length;c<d;c++)l.morphTargetInfluences[c]=o.weights[c]}),r})}loadNode(e){const t=this.json,n=this,o=t.nodes[e],i=n._loadNodeShallow(e),r=[],l=o.children||[];for(let d=0,m=l.length;d<m;d++)r.push(n.getDependency("node",l[d]));const c=o.skin===void 0?Promise.resolve(null):n.getDependency("skin",o.skin);return Promise.all([i,Promise.all(r),c]).then(function(d){const m=d[0],h=d[1],g=d[2];g!==null&&m.traverse(function(C){C.isSkinnedMesh&&C.bind(g,Or)});for(let C=0,T=h.length;C<T;C++)m.add(h[C]);return m})}_loadNodeShallow(e){const t=this.json,n=this.extensions,o=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const i=t.nodes[e],r=i.name?o.createUniqueName(i.name):"",l=[],c=o._invokeOne(function(d){return d.createNodeMesh&&d.createNodeMesh(e)});return c&&l.push(c),i.camera!==void 0&&l.push(o.getDependency("camera",i.camera).then(function(d){return o._getNodeRef(o.cameraCache,i.camera,d)})),o._invokeAll(function(d){return d.createNodeAttachment&&d.createNodeAttachment(e)}).forEach(function(d){l.push(d)}),this.nodeCache[e]=Promise.all(l).then(function(d){let m;if(i.isBone===!0?m=new bs:d.length>1?m=new Lt:d.length===1?m=d[0]:m=new ci,m!==d[0])for(let h=0,g=d.length;h<g;h++)m.add(d[h]);if(i.name&&(m.userData.name=i.name,m.name=r),De(m,i),i.extensions&&tt(n,m,i),i.matrix!==void 0){const h=new lo;h.fromArray(i.matrix),m.applyMatrix4(h)}else i.translation!==void 0&&m.position.fromArray(i.translation),i.rotation!==void 0&&m.quaternion.fromArray(i.rotation),i.scale!==void 0&&m.scale.fromArray(i.scale);if(!o.associations.has(m))o.associations.set(m,{});else if(i.mesh!==void 0&&o.meshCache.refs[i.mesh]>1){const h=o.associations.get(m);o.associations.set(m,{...h})}return o.associations.get(m).nodes=e,m}),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],o=this,i=new Lt;n.name&&(i.name=o.createUniqueName(n.name)),De(i,n),n.extensions&&tt(t,i,n);const r=n.nodes||[],l=[];for(let c=0,d=r.length;c<d;c++)l.push(o.getDependency("node",r[c]));return Promise.all(l).then(function(c){for(let m=0,h=c.length;m<h;m++)i.add(c[m]);const d=m=>{const h=new Map;for(const[g,C]of o.associations)(g instanceof Do||g instanceof Yo)&&h.set(g,C);return m.traverse(g=>{const C=o.associations.get(g);C!=null&&h.set(g,C)}),h};return o.associations=d(i),i})}_createAnimationTracks(e,t,n,o,i){const r=[],l=e.name?e.name:e.uuid,c=[];je[i.path]===je.weights?e.traverse(function(g){g.morphTargetInfluences&&c.push(g.name?g.name:g.uuid)}):c.push(l);let d;switch(je[i.path]){case je.weights:d=zn;break;case je.rotation:d=Bn;break;case je.translation:case je.scale:d=Nn;break;default:switch(n.itemSize){case 1:d=zn;break;case 2:case 3:default:d=Nn;break}break}const m=o.interpolation!==void 0?Sr[o.interpolation]:mi,h=this._getArrayFromAccessor(n);for(let g=0,C=c.length;g<C;g++){const T=new d(c[g]+"."+je[i.path],t.array,h,m);o.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(T),r.push(T)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const n=an(t.constructor),o=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)o[i]=t[i]*n;t=o}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(n){const o=this instanceof Bn?Cr:Ti;return new o(this.times,this.values,this.getValueSize()/3,n)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Pr(a,e,t){const n=e.attributes,o=new Zo;if(n.POSITION!==void 0){const l=t.json.accessors[n.POSITION],c=l.min,d=l.max;if(c!==void 0&&d!==void 0){if(o.set(new Ke(c[0],c[1],c[2]),new Ke(d[0],d[1],d[2])),l.normalized){const m=an(gt[l.componentType]);o.min.multiplyScalar(m),o.max.multiplyScalar(m)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const l=new Ke,c=new Ke;for(let d=0,m=i.length;d<m;d++){const h=i[d];if(h.POSITION!==void 0){const g=t.json.accessors[h.POSITION],C=g.min,T=g.max;if(C!==void 0&&T!==void 0){if(c.setX(Math.max(Math.abs(C[0]),Math.abs(T[0]))),c.setY(Math.max(Math.abs(C[1]),Math.abs(T[1]))),c.setZ(Math.max(Math.abs(C[2]),Math.abs(T[2]))),g.normalized){const S=an(gt[g.componentType]);c.multiplyScalar(S)}l.max(c)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(l)}a.boundingBox=o;const r=new Ts;o.getCenter(r.center),r.radius=o.min.distanceTo(o.max)/2,a.boundingSphere=r}function ii(a,e,t){const n=e.attributes,o=[];function i(r,l){return t.getDependency("accessor",r).then(function(c){a.setAttribute(l,c)})}for(const r in n){const l=rn[r]||r.toLowerCase();l in a.attributes||o.push(i(n[r],l))}if(e.indices!==void 0&&!a.index){const r=t.getDependency("accessor",e.indices).then(function(l){a.setIndex(l)});o.push(r)}return Jo.workingColorSpace!==Ie&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Jo.workingColorSpace}" not supported.`),De(a,e),Pr(a,e,t),Promise.all(o).then(function(){return e.targets!==void 0?Tr(a,e.targets,t):a})}const Uo=new WeakMap;class Rr extends ri{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,n,o){const i=new ro(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,r=>{this.parse(r,t,o)},n,o)}parse(e,t,n=()=>{}){this.decodeDracoFile(e,t,null,null,Xe,n).catch(n)}decodeDracoFile(e,t,n,o,i=Ie,r=()=>{}){const l={attributeIDs:n||this.defaultAttributeIDs,attributeTypes:o||this.defaultAttributeTypes,useUniqueIDs:!!n,vertexColorSpace:i};return this.decodeGeometry(e,l).then(t).catch(r)}decodeGeometry(e,t){const n=JSON.stringify(t);if(Uo.has(e)){const c=Uo.get(e);if(c.key===n)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let o;const i=this.workerNextTaskID++,r=e.byteLength,l=this._getWorker(i,r).then(c=>(o=c,new Promise((d,m)=>{o._callbacks[i]={resolve:d,reject:m},o.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return l.catch(()=>!0).then(()=>{o&&i&&this._releaseTask(o,i)}),Uo.set(e,{key:n,promise:l}),l}_createGeometry(e){const t=new co;e.index&&t.setIndex(new ge(e.index.array,1));for(let n=0;n<e.attributes.length;n++){const{name:o,array:i,itemSize:r,stride:l,vertexColorSpace:c}=e.attributes[n];let d;if(r===l)d=new ge(i,r);else{const m=new di(i,l);d=new gi(m,r,0)}o==="color"&&(this._assignVertexColorSpace(d,c),d.normalized=!(i instanceof Float32Array)),t.setAttribute(o,d)}return t}_assignVertexColorSpace(e,t){if(t!==Xe)return;const n=new X;for(let o=0,i=e.count;o<i;o++)n.fromBufferAttribute(e,o),Jo.colorSpaceToWorking(n,Xe),e.setXYZ(o,n.r,n.g,n.b)}_loadLibrary(e,t){const n=new ro(this.manager);return n.setPath(this.decoderPath),n.setResponseType(t),n.setWithCredentials(this.withCredentials),new Promise((o,i)=>{n.load(e,o,void 0,i)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(n=>{const o=n[0];e||(this.decoderConfig.wasmBinary=n[1]);const i=Lr.toString(),r=["/* draco decoder */",o,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([r]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const o=new Worker(this.workerSourceURL);o._callbacks={},o._taskCosts={},o._taskLoad=0,o.postMessage({type:"init",decoderConfig:this.decoderConfig}),o.onmessage=function(i){const r=i.data;switch(r.type){case"decode":o._callbacks[r.id].resolve(r);break;case"error":o._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(o)}else this.workerPool.sort(function(o,i){return o._taskLoad>i._taskLoad?-1:1});const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[e]=t,n._taskLoad+=t,n})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function Lr(){let a,e;onmessage=function(r){const l=r.data;switch(l.type){case"init":a=l.decoderConfig,e=new Promise(function(m){a.onModuleLoaded=function(h){m({draco:h})},DracoDecoderModule(a)});break;case"decode":const c=l.buffer,d=l.taskConfig;e.then(m=>{const h=m.draco,g=new h.Decoder;try{const C=t(h,g,new Int8Array(c),d),T=C.attributes.map(S=>S.array.buffer);C.index&&T.push(C.index.array.buffer),self.postMessage({type:"decode",id:l.id,geometry:C},T)}catch(C){console.error(C),self.postMessage({type:"error",id:l.id,error:C.message})}finally{h.destroy(g)}});break}};function t(r,l,c,d){const m=d.attributeIDs,h=d.attributeTypes;let g,C;const T=l.GetEncodedGeometryType(c);if(T===r.TRIANGULAR_MESH)g=new r.Mesh,C=l.DecodeArrayToMesh(c,c.byteLength,g);else if(T===r.POINT_CLOUD)g=new r.PointCloud,C=l.DecodeArrayToPointCloud(c,c.byteLength,g);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!C.ok()||g.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+C.error_msg());const S={index:null,attributes:[]};for(const x in m){const L=self[h[x]];let U,z;if(d.useUniqueIDs)z=m[x],U=l.GetAttributeByUniqueId(g,z);else{if(z=l.GetAttributeId(g,r[m[x]]),z===-1)continue;U=l.GetAttribute(g,z)}const B=o(r,l,g,x,L,U);x==="color"&&(B.vertexColorSpace=d.vertexColorSpace),S.attributes.push(B)}return T===r.TRIANGULAR_MESH&&(S.index=n(r,l,g)),r.destroy(g),S}function n(r,l,c){const m=c.num_faces()*3,h=m*4,g=r._malloc(h);l.GetTrianglesUInt32Array(c,h,g);const C=new Uint32Array(r.HEAPF32.buffer,g,m).slice();return r._free(g),{array:C,itemSize:1}}function o(r,l,c,d,m,h){const g=c.num_points(),C=h.num_components(),T=i(r,m),S=C*m.BYTES_PER_ELEMENT,x=Math.ceil(S/4)*4,L=x/m.BYTES_PER_ELEMENT,U=g*S,z=g*x,B=r._malloc(U);l.GetAttributeDataArrayForAllPoints(c,h,T,U,B);const q=new m(r.HEAPF32.buffer,B,U/m.BYTES_PER_ELEMENT);let ce;if(S===x)ce=q.slice();else{ce=new m(z/m.BYTES_PER_ELEMENT);let Y=0;for(let de=0,Se=q.length;de<Se;de++){for(let he=0;he<C;he++)ce[Y+he]=q[de*C+he];Y+=L}}return r._free(B),{name:d,count:g,itemSize:C,array:ce,stride:L}}function i(r,l){switch(l){case Float32Array:return r.DT_FLOAT32;case Int8Array:return r.DT_INT8;case Int16Array:return r.DT_INT16;case Int32Array:return r.DT_INT32;case Uint8Array:return r.DT_UINT8;case Uint16Array:return r.DT_UINT16;case Uint32Array:return r.DT_UINT32}}}const Fr="/150-lab/assets/models/globe-hd.glb";class Dr{constructor(e,t=60){this.animateCallback=e,this.targetFPS=Math.min(t,60),this.baseTargetFPS=this.targetFPS,this.frameInterval=1e3/this.targetFPS,this.lastFrameTime=0,this.isVisible=!0,this.isRunning=!1,this.rafId=null,this.pausedByTimeline=!1,this.inTimeline=!1,this.frameCount=0,this.fpsCheckInterval=1e3,this.lastFPSCheck=performance.now(),this.currentFPS=this.targetFPS,this.isDegraded=!1,this.minFPS=30,this.currentCanvasId="shaderBackground",this.observers=new Map,this.isScrolling=!1,this.isMobile=le.isMobile(),this.scrollThrottleFPS=this.isMobile?30:45,this.setupVisibilityObserver(this.currentCanvasId),this.setupPageVisibilityListener(),this.setupDegradationListener(),this.setupScrollListener()}setupScrollListener(){le.onScrollStateChange(({isScrolling:e})=>{if(this.isScrolling=e,this.isMobile)if(e){const t=Math.min(this.scrollThrottleFPS,this.baseTargetFPS);this.setTargetFPS(t)}else this.setTargetFPS(this.baseTargetFPS)})}setupDegradationListener(){le.onDegradation(e=>{e.tier==="low"&&!this.isDegraded&&(D.log("[Adaptive Renderer] Received degradation signal - reducing to 30fps"),this.isDegraded=!0,this.setTargetFPS(e.targetFPS||this.minFPS))}),le.onFpsCapChange(e=>{if(D.log(`[Adaptive Renderer] Received FPS cap signal: ${e.cap}fps (${e.reason})`),e.reason==="performance_improved"&&e.cap>this.baseTargetFPS){D.log(`[Adaptive Renderer] Performance improved - upgrading from ${this.baseTargetFPS}fps to ${e.cap}fps`),this.baseTargetFPS=e.cap,this.isDegraded=!1,this.scrollThrottleFPS=this.isMobile?30:45,this.isScrolling||this.setTargetFPS(e.cap);return}e.cap<this.baseTargetFPS&&(this.baseTargetFPS=e.cap,D.log(`[Adaptive Renderer] Updated base target FPS to ${e.cap}fps`)),e.cap===30&&(this.scrollThrottleFPS=30,this.isDegraded=!0),e.cap<this.targetFPS&&!this.isScrolling&&this.setTargetFPS(e.cap)})}setupVisibilityObserver(e){const t=document.getElementById(e);if(!t){D.warn(`[Adaptive Renderer] Canvas #${e} not found for observation`);return}const n={root:null,rootMargin:"50px",threshold:.1},o=new IntersectionObserver(i=>{i.forEach(r=>{r.target.id===this.currentCanvasId&&(this.isVisible=r.isIntersecting,this.isVisible&&this.isRunning||this.isVisible)})},n);o.observe(t),this.observers.set(e,o)}setupPageVisibilityListener(){document.addEventListener("visibilitychange",()=>{document.hidden?this.pause():this.resume()})}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.lastFPSCheck=performance.now(),this.frameCount=0,this.loop())}loop(){if(!this.isRunning)return;this.rafId=requestAnimationFrame(()=>this.loop());const e=performance.now(),t=e-this.lastFrameTime;e-this.lastFPSCheck>=this.fpsCheckInterval&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSCheck=e,!this.pausedByTimeline&&this.isVisible&&!document.hidden&&le.recordFpsSample(this.currentFPS)),!(t<this.frameInterval)&&(!this.isVisible||this.pausedByTimeline||document.hidden||(this.lastFrameTime=e-t%this.frameInterval,this.frameCount++,this.animateCallback&&this.animateCallback(t)))}pause(){this.isRunning=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null)}resume(){this.isRunning||this.start()}setPausedByTimeline(e){this.pausedByTimeline=e,e&&this.currentCanvasId==="shaderBackground"&&(this.frameCount=0,this.lastFPSCheck=performance.now())}setInTimeline(e){this.inTimeline!==e&&(this.inTimeline=e,e?this.switchCanvasMonitoring("timeline-shader-bg"):this.switchCanvasMonitoring("shaderBackground"))}switchCanvasMonitoring(e){this.currentCanvasId!==e&&(this.currentCanvasId=e,this.observers.has(e)||this.setupVisibilityObserver(e),this.frameCount=0,this.lastFPSCheck=performance.now())}setTargetFPS(e){this.targetFPS=e,this.frameInterval=1e3/e}getCurrentFPS(){return this.currentFPS}destroy(){this.pause(),this.observers.forEach(e=>e.disconnect()),this.observers.clear()}}class Ir{constructor(){this.metrics={fps:0,frameTime:0,memory:0,drawCalls:0,triangles:0,geometries:0,textures:0},this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.maxHistoryLength=60,this.warningThreshold={fps:30,frameTime:33,memory:200},this.onWarning=null,this.lastWarningTime=0,this.warningCooldown=6e4,this.warningHistory=new Map,this.consecutiveLowFps=0,this.persistenceThreshold=5}update(e){const t=performance.now(),n=t-this.lastTime;if(this.frameCount++,n>=1e3){if(this.metrics.fps=Math.round(this.frameCount*1e3/n),this.metrics.frameTime=n/this.frameCount,this.fpsHistory.push(this.metrics.fps),this.fpsHistory.length>this.maxHistoryLength&&this.fpsHistory.shift(),e&&e.info){const o=e.info;this.metrics.drawCalls=o.render.calls,this.metrics.triangles=o.render.triangles,this.metrics.geometries=o.memory.geometries,this.metrics.textures=o.memory.textures}performance.memory&&(this.metrics.memory=Math.round(performance.memory.usedJSHeapSize/1048576)),this.checkWarnings(),this.frameCount=0,this.lastTime=t}}checkWarnings(){const e=performance.now();if(this.metrics.fps<this.warningThreshold.fps&&this.getAverageFPS()<this.warningThreshold.fps?this.consecutiveLowFps++:this.consecutiveLowFps=Math.max(0,this.consecutiveLowFps-1),e-this.lastWarningTime<this.warningCooldown)return;const t=[];if(this.consecutiveLowFps>=this.persistenceThreshold&&this.metrics.fps<this.warningThreshold.fps&&this.getAverageFPS()<this.warningThreshold.fps&&(!this.warningHistory.has("fps")||e-this.warningHistory.get("fps")>this.warningCooldown)&&(t.push(`Persistent low FPS: ${this.metrics.fps} (avg: ${this.getAverageFPS()}, streak: ${this.consecutiveLowFps})`),this.warningHistory.set("fps",e)),this.metrics.memory>this.warningThreshold.memory*1.5){const n="memory";(!this.warningHistory.has(n)||e-this.warningHistory.get(n)>this.warningCooldown)&&(t.push(`High memory usage: ${this.metrics.memory}MB (threshold: ${this.warningThreshold.memory}MB)`),this.warningHistory.set(n,e))}t.length>0&&this.onWarning&&(this.lastWarningTime=e,this.onWarning(t))}getAverageFPS(){if(this.fpsHistory.length===0)return 0;const e=this.fpsHistory.reduce((t,n)=>t+n,0);return Math.round(e/this.fpsHistory.length)}getMetrics(){return{...this.metrics}}log(){D.log("[Performance Monitor]",{fps:this.metrics.fps,avgFPS:this.getAverageFPS(),frameTime:`${this.metrics.frameTime.toFixed(1)}ms`,memory:`${this.metrics.memory}MB`,drawCalls:this.metrics.drawCalls,triangles:this.metrics.triangles,geometries:this.metrics.geometries,textures:this.metrics.textures})}createDebugOverlay(){const e=document.createElement("div");return e.id="perf-monitor-overlay",e.style.cssText=`
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      border-radius: 4px;
      z-index: 999999;
      min-width: 200px;
    `,document.body.appendChild(e),setInterval(()=>{const t=this.getMetrics();e.innerHTML=`
        <div style="font-weight: bold; margin-bottom: 5px;">Performance Monitor</div>
        <div>FPS: ${t.fps} (avg: ${this.getAverageFPS()})</div>
        <div>Frame Time: ${t.frameTime.toFixed(1)}ms</div>
        <div>Memory: ${t.memory}MB</div>
        <div>Draw Calls: ${t.drawCalls}</div>
        <div>Triangles: ${t.triangles}</div>
        <div>Geometries: ${t.geometries}</div>
        <div>Textures: ${t.textures}</div>
      `},1e3),e}removeDebugOverlay(){const e=document.getElementById("perf-monitor-overlay");e&&e.remove()}createFpsCounter(){return Ms(()=>import("./mobileFilmGrain-CmB6Tq7x.js").then(e=>e.ao),__vite__mapDeps([0,1])).then(e=>{const t=e.default,n=document.createElement("div");n.id="fps-counter",n.style.cssText=`
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #0f0;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 4px;
        z-index: 999999;
        pointer-events: none;
        user-select: none;
        min-width: 60px;
        text-align: center;
      `,document.body.appendChild(n);let o=null;t.onFpsCapChange(h=>{o=h.cap});let i=0,r=performance.now(),l=60,c=[];const d=10,m=()=>{if(!document.getElementById("fps-counter"))return;i++;const h=performance.now(),g=h-r;if(g>=1e3){l=Math.round(i*1e3/g),i=0,r=h,c.push(l),c.length>d&&c.shift();const C=Math.round(c.reduce((z,B)=>z+B,0)/c.length);let T="#0f0";const S=o||60,x=S*.8,L=S*.5;l<L?T="#f00":l<x&&(T="#ff0"),n.style.color=T;let U="";if(o){const z=o===30?"#f80":"#0af",B=o===30?"cap:30 (degraded)":`cap:${o}`;U=` <span style="color: ${z}; font-size: 9px;">${B}</span>`}n.innerHTML=`${l} FPS <span style="color: #888; font-size: 9px;">(avg: ${C})</span>${U}`}requestAnimationFrame(m)};requestAnimationFrame(m)}),document.getElementById("fps-counter")}removeFpsCounter(){const e=document.getElementById("fps-counter");e&&e.remove(),this.fpsCounterInterval&&(clearInterval(this.fpsCounterInterval),this.fpsCounterInterval=null)}setWarningCallback(e){this.onWarning=e}}class Nr{constructor(){this.disposables=new Set,this.textures=new Set,this.geometries=new Set,this.materials=new Set}track(e,t="disposable"){if(e)switch(t){case"texture":this.textures.add(e);break;case"geometry":this.geometries.add(e);break;case"material":this.materials.add(e);break;default:this.disposables.add(e)}}dispose(e){if(e)try{e.dispose&&typeof e.dispose=="function"&&e.dispose(),this.disposables.delete(e),this.textures.delete(e),this.geometries.delete(e),this.materials.delete(e)}catch(t){D.warn("[Memory Manager] Error disposing resource:",t)}}disposeAll(){let e=0;return this.textures.forEach(t=>{try{t&&t.dispose&&(t.dispose(),e++)}catch(n){D.warn("[Memory Manager] Error disposing texture:",n)}}),this.textures.clear(),this.geometries.forEach(t=>{try{t&&t.dispose&&(t.dispose(),e++)}catch(n){D.warn("[Memory Manager] Error disposing geometry:",n)}}),this.geometries.clear(),this.materials.forEach(t=>{try{t&&t.dispose&&(t.dispose(),e++)}catch(n){D.warn("[Memory Manager] Error disposing material:",n)}}),this.materials.clear(),this.disposables.forEach(t=>{try{t&&t.dispose&&(t.dispose(),e++)}catch(n){D.warn("[Memory Manager] Error disposing resource:",n)}}),this.disposables.clear(),D.log(`[Memory Manager] Disposed ${e} resources`),e}disposeObject(e){e&&(e.children&&e.children.forEach(t=>this.disposeObject(t)),e.geometry&&this.dispose(e.geometry),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{this.disposeMaterial(t)}):this.disposeMaterial(e.material)),e.parent&&e.parent.remove(e))}disposeMaterial(e){if(!e)return;["map","lightMap","bumpMap","normalMap","specularMap","envMap","alphaMap","aoMap","displacementMap","emissiveMap","gradientMap","metalnessMap","roughnessMap"].forEach(n=>{e[n]&&this.dispose(e[n])}),this.dispose(e)}getStats(){return{textures:this.textures.size,geometries:this.geometries.size,materials:this.materials.size,disposables:this.disposables.size,total:this.textures.size+this.geometries.size+this.materials.size+this.disposables.size}}forceGC(){try{if(window.gc)window.gc(),D.log("[Memory Manager] Forced garbage collection");else{const e=new Array(1e6);e.fill(0),e.length=0}}catch{}}}const Ot=new Nr;function zr(a,e){if(window.PRELOADED_ASSETS&&window.PRELOADED_ASSETS[a]){const t=window.PRELOADED_ASSETS[a];if(t instanceof ArrayBuffer){const n=new Blob([t]);return URL.createObjectURL(n)}}return e}async function Br(){if(window.shaderBackgroundInitialized){D.warn("Shader background already initialized. Skipping...");return}const a=Io.detect(),e=Io.getSettings();if(e.mode==="fallback"||!e.enableBackground){D.log("[Background Init] Skipping initialization - AEM fallback mode detected"),D.log("[Background Init] AEM Mode:",a),Io.applyStaticBackground(),window.shaderBackgroundInitialized=!0;return}const t=await le.detect(),n=le.getSettings();D.log("[Background Init] AEM Mode:",a),D.log("[Background Init] Performance Tier:",t),D.log("[Background Init] Settings:",n),window.colorPhase=1,window.specialColorsActive=!1,window.particlesFullyHidden=!1,window.particlesMovementPaused=!1;let o=Date.now();const i=6e9;function r(){const s=document.querySelector("#events");if(!s)return!0;const u=s.getBoundingClientRect(),_=window.innerHeight*1.2;return u.top>_}const l=document.getElementById("shaderBackground");if(!l)return;function c(){try{const s=document.createElement("canvas");return!!(s.getContext("webgl")||s.getContext("experimental-webgl"))}catch{return!1}}if(!c()){D.warn("WebGL is not supported on this device/browser. Skipping shader background initialization."),l.style.display="none",document.body.style.backgroundColor="#1a1a2e";return}window.specialColorsActive=!1,window.colorPhase=0;function d(s,u){let p,_,y,w,O,P,I,R;if(!document.querySelector("#video-travel-area")){D.warn("Could not find #video-travel-area element for shader animation");return}if(f&&f.color1&&f.color2&&(p=f.color1.value.clone(),_=f.color2.value.clone(),y=f.waveSpeed.value,w=f.waveAmplitude.value,O=f.waveFrequency.value,P=f.ambientLight.value,I=f.directionalLight.value,R=f.yOffset.value),s.timeline({scrollTrigger:{trigger:"#intro-text-travel-area",start:"35% top",end:"45% top",scrub:!0,markers:!1,invalidateOnRefresh:!0,onUpdate:te=>{f&&f.colorDarkness&&(f.colorDarkness.value=te.progress*2,f.colorDarkness.value>=1.95?window.colorPhase===1?(f.color1&&f.color1.value.set(p),f.color2&&f.color2.value.set(_),window.specialColorsActive=!0):window.colorPhase===0&&(f.color1&&f.color1.value.set("#e2e2e2"),f.color2&&f.color2.value.set("#515151"),window.specialColorsActive=!0):p&&_&&(window.colorPhase===1?(f.color1&&f.color1.value.copy(p),f.color2&&f.color2.value.copy(_),window.specialColorsActive=!1):window.colorPhase===0&&(f.color1&&f.color1.value.set("#e2e2e2"),f.color2&&f.color2.value.set("#515151"),window.specialColorsActive=!1)),h())}}}),setTimeout(()=>{m(s)},100),!document.querySelector("#get-involved")){D.warn("Could not find #get-involved element for globe opacity animation");return}s.timeline({scrollTrigger:{trigger:"#get-involved",start:"top bottom",end:"#get-involved-earth center center",scrub:!0,markers:!1,onUpdate:te=>{const F=te.progress;E&&(F>.01&&!E.visible?(E.visible=!0,H.visible=!0,T()):F<=.01&&E.visible&&(E.visible=!1,H.visible=!1,T()),E.visible&&(E.traverse(j=>{j.isMesh&&j.material&&(j.material.transparent=!0,j.material.opacity=F)}),H.opacity=F,C())),G&&(F>.01&&!G.visible?(G.visible=!0,Z.enabled=!0,S()):F<=.01&&G.visible&&(G.visible=!1,Z.enabled=!1,S()),$&&$.uniforms&&(F>.01&&G.visible?($.uniforms.startOpacity.value=Z.startOpacity*F,$.uniforms.endOpacity.value=Z.endOpacity*F):($.uniforms.startOpacity.value=0,$.uniforms.endOpacity.value=0)))}}}),s.timeline({scrollTrigger:{trigger:"#get-involved",start:"top 90%",end:"bottom top",scrub:.5,markers:!1,onUpdate:te=>{const F=te.progress,j=.15;if(!window.particlesFullyHidden&&F>=j?(window.particlesFullyHidden=!0,window.particlesMovementPaused=!0):window.particlesFullyHidden&&F<j*.8&&(window.particlesFullyHidden=!1,window.particlesMovementPaused=!1),window.particlesFullyHidden){V&&V.uniforms&&V.uniforms.opacity&&(V.uniforms.opacity.value=0,In());return}const me=1-Math.min(F/j,1),oo=.5*Math.pow(me,3);V&&V.uniforms&&V.uniforms.opacity&&(V.uniforms.opacity.value=oo,In())}}}),s.timeline({scrollTrigger:{trigger:"#get-involved-earth",start:"top bottom",end:"bottom top",scrub:.3,markers:!1,onUpdate:te=>{const F=te.progress;if(Je){if(window.innerWidth<=768){Je.position.y=0;return}const j=-322,oe=120,me=1-Math.pow(1-F,3),Ve=j+oe*me;if(Je.position.y=Ve,A&&A.__folders["Globe Model Controls"]){const to=A.__folders["Globe Model Controls"].__folders.Position;if(to&&to.__controllers){for(let oo of to.__controllers)if(oo.property==="positionY"){oo.updateDisplay();break}}}}}}});const we=new X("#e2e2e2"),St=new X("#515151"),$i=new X("#32c2d6"),qi=new X("#004199"),Mn=new X,On=new X;let kn=-1,xt=null;const Lo=document.querySelector("#hero-travel-area");if(!Lo){D.warn("[Background] #hero-travel-area not found - color animations will not work");return}D.log("[Background] #hero-travel-area found, creating color ScrollTriggers"),s.timeline({scrollTrigger:{trigger:Lo,start:"top bottom",end:"top top",scrub:!0,markers:!1,onUpdate:te=>{if(!f||!f.color1||!f.color2)return;const F=Math.round(te.progress*1e3)/1e3;if(F!==kn&&(kn=F,Mn.copy(we).lerp($i,F),On.copy(St).lerp(qi,F),f.color1.value.copy(Mn),f.color2.value.copy(On),F>.9?window.colorPhase=1:F<.1?window.colorPhase=0:window.colorPhase=.5,window.specialColorsActive=!0,xt||(xt=document.querySelector("#cover-area-overlay")),xt)){const j=1-F,oe=1+F*1.2;xt.style.opacity=j,xt.style.filter=`saturate(${oe})`}}}});const Pn=new X("#32c2d6"),Rn=new X("#004199"),Ln=new X("#B225B1"),Fn=new X("#FCC72D"),Yi=new X("#DA281C"),Ji=new X("#FCC72D"),Zt=new X,Qt=new X;let Dn=-1,Tt=null,eo=null,Fo=!1;s.timeline({scrollTrigger:{trigger:Lo,start:"top top",end:"bottom bottom",scrub:!0,markers:!1,onUpdate:te=>{if(!f||!f.color1||!f.color2)return;const F=Math.round(te.progress*1e3)/1e3;if(F!==Dn){if(Dn=F,F<=.4)Zt.copy(Pn);else if(F<=.8){const j=(F-.4)/.4;Zt.copy(Pn).lerp(Ln,j)}else{const j=(F-.8)/.2;Zt.copy(Ln).lerp(Yi,j)}if(F<=.6)Qt.copy(Rn);else if(F<=.8){const j=(F-.6)/.2;Qt.copy(Rn).lerp(Fn,j)}else{const j=(F-.8)/.2;Qt.copy(Fn).lerp(Ji,j)}if(f.color1.value.copy(Zt),f.color2.value.copy(Qt),Fo||(eo||(eo=document.getElementById("shaderBackground")),eo&&(eo.style.filter="hue-rotate(0deg)",Fo=!0)),F>.9?window.colorPhase=2:F<.1?window.colorPhase=1:window.colorPhase=1.5,o=Date.now(),window.specialColorsActive=!0,Tt||(Tt=document.querySelector("#cover-area-overlay")),Tt){let j=0;if(F>=.3){const me=(F-.3)/.7;j=Math.min(.5,me*.5)}const oe=1+F*1.2;Tt.style.opacity=j,Tt.style.filter=`saturate(${oe})`}}},onLeaveBack:()=>{Fo=!1}}}),requestAnimationFrame(()=>{u&&typeof u.refresh=="function"&&(u.refresh(),D.log("[Background] ScrollTrigger refreshed after color animation setup"))}),s.timeline({scrollTrigger:{trigger:"#video-travel-area",start:"top top",end:"bottom top",scrub:!1,markers:!1,onEnter:()=>{f&&f.color1&&f.color2&&(f.color1.value.set("#DA281C"),f.color2.value.set("#FCC72D"),window.colorPhase=2,window.specialColorsActive=!0,g())},onLeaveBack:()=>{}}}),s.timeline({scrollTrigger:{trigger:"#video-travel-area",start:"top bottom",end:"top 66.67%",scrub:!0,markers:!1,onUpdate:te=>{const F=te.progress,j=document.querySelector("#cover-area-overlay");if(j){const oe=.5-F*.5;j.style.opacity=oe,j.style.filter="saturate(2.2)"}}}}),s.timeline({scrollTrigger:{trigger:"#get-involved-cards",start:"top 50%",end:"top -10%",scrub:!0,markers:!1,onUpdate:te=>{if(!f||!f.color1||!f.color2)return;const F=te.progress;if(F>.1)f.color1.value.set("#8300ff"),f.color2.value.set("#14d15f"),f.yOffset&&(f.yOffset.value=-.05),f.ambientLight.value=.4,f.directionalLight.value=.4,f.waveAmplitude.value=1.2,f.waveFrequency.value=2.2,window.colorPhase=3,window.specialColorsActive=!0,g(),Go(),Wo();else if(F<=.1&&window.colorPhase===3){const j=f.time.value+f.colorCycleOffset.value;f.colorCycleOffset.value=j,f.time.value=0,f.color1.value.set("#DA281C"),f.color2.value.set("#FCC72D"),f.yOffset&&R!==void 0&&(f.yOffset.value=R),P!==void 0&&(f.ambientLight.value=P),I!==void 0&&(f.directionalLight.value=I),f.waveSpeed.value=1,w!==void 0&&(f.waveAmplitude.value=w),O!==void 0&&(f.waveFrequency.value=O),window.colorPhase=2,o=Date.now(),window.specialColorsActive=!0,g(),Go(),Wo()}h()}}}),s.timeline({scrollTrigger:{trigger:"#get-involved-cards",start:"top 50%",end:"top -10%",scrub:1,markers:!1,onUpdate:te=>{const j=1-te.progress,oe=Math.pow(j,3);E&&(E.visible=!0,E.traverse(me=>{me.isMesh&&me.material&&(Array.isArray(me.material)?me.material.forEach(Ve=>{Ve.transparent=!0,Ve.opacity=oe,Ve.depthWrite=oe>.1,Ve.blending=Gn,Ve.needsUpdate=!0}):(me.material.transparent=!0,me.material.opacity=oe,me.material.depthWrite=oe>.1,me.material.blending=Gn,me.material.needsUpdate=!0))}),oe<.01&&(E.visible=!1),H.opacity=oe,H.rotationPaused=oe<.01,C()),G&&$&&$.uniforms&&(G.visible=oe>.01,$.uniforms.startOpacity.value=Z.startOpacity*oe,$.uniforms.endOpacity.value=Z.endOpacity*oe,Z.enabled=oe>.01,S())}}}),s.timeline({scrollTrigger:{trigger:"#get-involved",start:"bottom bottom",end:"top top",scrub:!0,markers:!1,onUpdate:te=>{te.progress<=.1&&y!==void 0&&window.colorPhase===1&&(f.waveSpeed&&(f.waveSpeed.value=y),f.waveAmplitude&&(f.waveAmplitude.value=w),f.waveFrequency&&(f.waveFrequency.value=O),f.yOffset&&(f.yOffset.value=R),Go(),Wo())}}});function In(te){if(typeof A<"u"&&A&&A.__folders&&A.__folders["Particle System"]){const F=A.__folders["Particle System"];if(F&&F.__controllers){for(let j of F.__controllers)if(j.property==="value"&&j.object===V.uniforms.opacity){j.updateDisplay();break}}}}}function m(s,u,p,_){if(!document.querySelector("#events")){document.addEventListener("DOMContentLoaded",()=>{m(s)});return}const w=new X("#8300ff"),O=new X("#dcfff6");s.timeline({scrollTrigger:{trigger:"#get-involved-cards",start:"top 50%",end:"bottom 50%",scrub:!0,markers:!1,onUpdate:P=>{if(f&&f.colorDarkness)if(f.colorDarkness.value=1.5-P.progress*2,window.colorPhase===3){const I=P.progress;f.color1&&(f.color1.value.r=w.r+(O.r-w.r)*I,f.color1.value.g=w.g+(O.g-w.g)*I,f.color1.value.b=w.b+(O.b-w.b)*I),f.color2&&f.color2.value.set("#14d15f"),f.ambientLight.value=.4,f.directionalLight.value=.4,f.waveSpeed.value=.9,f.waveAmplitude.value=1.2,window.specialColorsActive=!0}else window.colorPhase===2?(f.color1&&f.color1.value.set("#da281c"),f.color2&&f.color2.value.set("#FCC72D"),window.specialColorsActive=!0):window.colorPhase===1?(f.color1&&f.color1.value.set("#32c2d6"),f.color2&&f.color2.value.set("#004199"),window.specialColorsActive=!0):(f.color1&&f.color1.value.set("#e2e2e2"),f.color2&&f.color2.value.set("#515151"),window.specialColorsActive=!0)}}})}function h(){const s=window.gui,u=window.uniforms;if(typeof s<"u"&&s&&s.__folders&&s.__folders["Color Controls"]){const p=s.__folders["Color Controls"];if(p&&p.__controllers){for(let _ of p.__controllers)if(_.property==="value"&&_.object===u.colorDarkness){_.updateDisplay();break}}}}function g(){const s=window.gui,u=window.uniforms;if(typeof s<"u"&&s&&s.__folders&&s.__folders["Color Controls"]){const p=s.__folders["Color Controls"];p&&p.__controllers&&p.__controllers.forEach(_=>{if(_.property==="color"&&_.__color){if(_.property==="color"&&_.__li&&_.__li.querySelector(".property-name").textContent==="Color 1"){const w="#"+u.color1.value.getHexString();_.setValue(w)}else if(_.property==="color"&&_.__li&&_.__li.querySelector(".property-name").textContent==="Color 2"){const w="#"+u.color2.value.getHexString();_.setValue(w)}}})}}function C(){if(typeof A<"u"&&A&&A.__folders&&A.__folders["Globe Model Controls"]&&A.__folders["Globe Model Controls"].__folders&&A.__folders["Globe Model Controls"].__folders.Material){const s=A.__folders["Globe Model Controls"].__folders.Material;if(s&&s.__controllers)for(let u of s.__controllers)u.property==="opacity"&&u.updateDisplay()}}function T(){if(typeof A<"u"&&A&&A.__folders&&A.__folders["Globe Model Controls"]){const s=A.__folders["Globe Model Controls"];if(s&&s.__controllers){for(let u of s.__controllers)if(u.property==="visible"){u.updateDisplay();break}}}}function S(){if(typeof A<"u"&&A&&A.__folders&&A.__folders["Gradient Overlay Controls"]){const s=A.__folders["Gradient Overlay Controls"];if(s&&s.__controllers){for(let u of s.__controllers)if(u.property==="enabled"){u.updateDisplay();break}}}}function x(){return Math.max(window.innerHeight,document.documentElement.clientHeight)}const L=window.innerWidth,U=x();l.style.position="fixed",l.style.top="0",l.style.left="0",l.style.width=`${L}px`,l.style.height=`${U}px`,l.style.zIndex="-1";const z=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),B=window.innerWidth<640,q=1.5,ce=B&&!z;ce?(l.style.transform=`translateZ(0) scaleX(${q})`,l.style.transformOrigin="center center",D.log(`[Background Init] Mobile shader widening enabled: ${q}x width`),console.log(`%c[ShaderBackground] Mobile widening ACTIVE - CSS scaleX(${q})`,"color: orange; font-weight: bold")):(l.style.transform="translateZ(0)",z&&B&&D.log("[Background Init] Safari detected - mobile shader widening DISABLED to prevent stretch")),l.style.transformStyle="preserve-3d",l.style.willChange="transform",window._mobileShaderScale=ce?q:1,window._isSafariBrowser=z;let Y;try{Y=new As({canvas:l,alpha:!0,antialias:n.antialias,powerPreference:t==="high"?"high-performance":"default",failIfMajorPerformanceCaveat:!1}),Y.setSize(L,U),Y.setPixelRatio(n.pixelRatio),D.log("[Background Init] Renderer pixel ratio:",n.pixelRatio)}catch(s){D.error("Failed to create WebGL renderer:",s),D.warn("Falling back to fallback background. WebGL initialization failed."),l.style.display="none",document.body.style.backgroundColor="#1a1a2e",document.body.style.background="linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%)";return}window.shaderBackgroundInitialized=!0,window.addEventListener("beforeunload",s=>{if(window._isMailtoOperation||window._preventBackgroundCleanup){D.log("[Background] Skipping cleanup for mailto/non-navigation action");return}D.log("[Background] Cleaning up resources before page unload"),window.shaderBackgroundRenderer&&window.shaderBackgroundRenderer.pause(),le.isMobile()&&ft.destroy();const u=Ot.disposeAll();D.log(`[Background] Disposed ${u} Three.js resources`),Y&&(Y.dispose(),Y.forceContextLoss()),Ot.forceGC()}),l.addEventListener("webglcontextlost",function(s){D.warn("WebGL context lost. Attempting to restore..."),s.preventDefault(),window.shaderBackgroundInitialized=!1}),l.addEventListener("webglcontextrestored",function(){setTimeout(()=>{if(!window.shaderBackgroundReinitializing){window.shaderBackgroundReinitializing=!0;try{Br()}catch(s){D.error("Failed to reinitialize shader background after context restore:",s)}finally{window.shaderBackgroundReinitializing=!1}}},100)});const de=new Hn,Se=new Hn;let he=0;const ye={zoom:2.471,zPosition:1},N=new pi(-window.innerWidth/2,window.innerWidth/2,window.innerHeight/2,-window.innerHeight/2,-1e3,1e3);N.position.z=ye.zPosition,N.zoom=ye.zoom,N.updateProjectionMatrix();const Je=new Lt;Je.position.y=-322,Je.frustumCulled=!0,de.add(Je);let $,G;const Z={enabled:!1,startOpacity:0,endOpacity:1,offsetY:.05,height:2.5,color:"#000000",yOffset:.09};function Ai(){$=new no({transparent:!0,uniforms:{startOpacity:{value:Z.startOpacity},endOpacity:{value:Z.endOpacity},overlayColor:{value:new X(Z.color)},offsetY:{value:Z.offsetY},heightMultiplier:{value:Z.height}},vertexShader:`
        varying vec2 vUv;
        
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform float startOpacity;
        uniform float endOpacity;
        uniform float offsetY;
        uniform float heightMultiplier;
        uniform vec3 overlayColor;
        varying vec2 vUv;
        
        void main() {
          // Calculate y position with offset and height multiplier
          // Use vUv.y directly (0 at bottom, 1 at top)
          float y = (vUv.y - offsetY) * heightMultiplier;
          
          // Clamp y between 0 and 1
          y = clamp(y, 0.0, 1.0);
          
          // Linear gradient from bottom to top
          // endOpacity at bottom (y=0), startOpacity at top (y=1)
          float opacity = mix(endOpacity, startOpacity, y);
          
          gl_FragColor = vec4(overlayColor, opacity);
        }
      `,depthTest:!1,depthWrite:!1,side:Xo});const s=window.innerHeight,u=N.right-N.left,p=N.top-N.bottom,_=s*.66*(p/s),y=new et(u,_);G=new $o(y,$),G.rotation.set(0,0,0),G.position.x=0,G.position.y=Z.yOffset*p,G.position.z=-100,G.frustumCulled=!1,G.renderOrder=9999,G.visible=Z.enabled,de.add(G)}function vt(){if(!G)return;G.rotation.set(0,0,0),G.position.x=0;const s=N.top-N.bottom;G.position.y=Z.yOffset*s,G.position.z=-100}Ai();const H={visible:!1,scale:25,positionX:0,positionY:-280,positionZ:0,rotationX:0,rotationY:0,rotationZ:0,autoRotate:!0,autoRotateSpeed:.05,baseRotateSpeed:.05,scrollRotateSpeed:.075,responsive:!0,baseScale:25,opacity:0,rotationPaused:!1},un=new Js,ho=new Rr;ho.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.6/"),ho.setDecoderConfig({type:"js"}),un.setDRACOLoader(ho);let E,po=1;function nt(s){if(!E)return;po=s;const u=window.innerWidth,p=window._mobileShaderScale||1;if(u<640&&p>1){const y=1/p,w=s*y;E.scale.set(w,s,s),console.log(`%c[Globe Compensation] shaderScale: ${p}, compensation: ${y.toFixed(4)}`,"color: cyan; font-weight: bold"),console.log(`%c[Globe Compensation] Applied scale - X: ${w.toFixed(2)}, Y: ${s.toFixed(2)}, Z: ${s.toFixed(2)}`,"color: cyan"),console.log(`%c[Globe Compensation] Visual after CSS: X: ${(w*p).toFixed(2)}, Y: ${s.toFixed(2)} (should match)`,"color: lime"),D.log(`[Globe] Logical scale: ${s.toFixed(2)}, Applied X: ${w.toFixed(2)} (comp: ${y.toFixed(4)})`)}else E.scale.set(s,s,s)}function mo(){!E||po<=0||nt(po)}const Ei=t==="low"||le.isAEMEmbedded(),Mi=s=>{E=s.scene;let p=new Zo().setFromObject(E).getCenter(new Ke),_=new Lt;_.add(E),E.position.set(-p.x,-p.y,-p.z),E=_,E.visible=H.visible,E.frustumCulled=!0,E.traverse(O=>{O.isMesh&&(O.frustumCulled=!0)}),Je.add(E),E.position.set(H.positionX,H.positionY,H.positionZ),E.rotation.set(H.rotationX*Math.PI/180,H.rotationY*Math.PI/180,H.rotationZ*Math.PI/180),H.responsive?(Ge(),window.innerWidth<640&&window._mobileShaderScale>1&&setTimeout(()=>{E&&(mo(),D.log("[Globe] Reapplied scale compensation after delay"))},100)):(nt(H.scale),st());const y=ne.addFolder("Material");let w=0;E.traverse(O=>{if(O.isMesh&&O.material){const P=O.material;if(w++,P.isMeshStandardMaterial||P.isMeshPhongMaterial){P.metalness!==void 0&&y.add({metalness:P.metalness},"metalness",0,1).name(`Metalness${w>1?" "+w:""}`).onChange(R=>{P.metalness=R}),P.roughness!==void 0&&y.add({roughness:P.roughness},"roughness",0,1).name(`Roughness${w>1?" "+w:""}`).onChange(R=>{P.roughness=R}),P.shininess!==void 0&&y.add({shininess:P.shininess},"shininess",0,100).name(`Shininess${w>1?" "+w:""}`).onChange(R=>{P.shininess=R}),y.add({opacity:P.opacity},"opacity",0,1).name(`Opacity${w>1?" "+w:""}`).onChange(R=>{P.opacity=R,P.transparent=R<1});const I=P.emissive?"#"+P.emissive.getHexString():"#000000";y.addColor({color:I},"color").name(`Emissive Color${w>1?" "+w:""}`).onChange(R=>{P.emissive&&P.emissive.set(R)})}}})},go=()=>{const s=zr("globe-hd.glb",Fr);D.log("[Background Init] Loading globe model..."),un.load(s,Mi,u=>{if(u.lengthComputable){const p=u.loaded/u.total*100;p%25===0&&D.log(`[Background Init] Globe loading: ${p.toFixed(0)}%`)}},u=>{D.error("Error loading globe model:",u)})};Ei?(D.log("[Background Init] Deferring globe model load for performance"),"requestIdleCallback"in window?requestIdleCallback(()=>go(),{timeout:2e3}):setTimeout(()=>go(),1e3)):go(),window.uniforms={time:{value:0},resolution:{value:new ao(window.innerWidth,window.innerHeight)},mainSpeed:{value:12e-5},waveSpeed:{value:1},noiseSpeed:{value:.45},colorCycleSpeed:{value:2},colorCycleOffset:{value:0},color1:{value:new X("#e2e2e2")},color2:{value:new X("#515151")},colorDarkness:{value:0},colorWaveInfluence:{value:0},colorFrequencyShift:{value:0},colorAmplitudeEffect:{value:0},waveAmplitude:{value:.8},waveFrequency:{value:4},waveDepth:{value:.6},flowDirection:{value:new ao(-.7,.82)},noiseScale:{value:2.5},noiseInfluence:{value:0},layerOffset:{value:.4},yOffset:{value:.29},topEdgeSoftness:{value:1},bottomEdgeSoftness:{value:1},leftEdgeSoftness:{value:.2},rightEdgeSoftness:{value:.5},fadeWidth:{value:1},leftCornerRoundness:{value:.8},rightCornerRoundness:{value:1},edgeNoiseAmount:{value:.12},edgeNoiseScale:{value:3},edgeDepth:{value:.9},edgeContrast:{value:2},bottomWaveEnabled:{value:!0},bottomWaveDepth:{value:.117},bottomWaveWidth:{value:6.475},bottomWaveSpeed:{value:0},bottomWaveOffset:{value:-2.207},filmNoiseIntensity:{value:le.isMobile()?0:.056},filmNoiseSpeed:{value:28e-7},filmGrainSize:{value:6},filmScratchIntensity:{value:0},filmGrainEnabled:{value:!le.isMobile()},lightDirection:{value:new Ke(.5,.5,1).normalize()},ambientLight:{value:.6},directionalLight:{value:.6},specularStrength:{value:0},shininess:{value:128},displacementStrength:{value:0},displacementScale:{value:1e-4},displacementDepth:{value:0},xOffset:{value:-.104}};const f=window.uniforms,fn=()=>{typeof window.gsap<"u"&&window.gsap.ScrollTrigger?(D.log("[Background] GSAP and ScrollTrigger ready, initializing color animations"),d(window.gsap,window.gsap.ScrollTrigger)):D.warn("GSAP or ScrollTrigger not found on window object - ScrollTrigger animations may not work")};if(window.gsapReady&&window.gsap&&window.gsap.ScrollTrigger)fn();else{let s=0;const u=20,p=()=>{s++,window.gsapReady&&window.gsap&&window.gsap.ScrollTrigger?fn():s<u?setTimeout(p,100):D.error("[Background] GSAP not available after waiting - color animations disabled")};setTimeout(p,50)}le.isMobile()&&(ft.setIntensity(.06),ft.setOpacity(.8),ft.start(),le.onScrollStateChange(({isScrolling:s})=>{s?ft.pauseForScroll():ft.resumeAfterScroll()}),D.log("[Background Init] Using lightweight mobile film grain with scroll-pause optimization"));const Oi=`
    uniform float time;
    uniform float waveSpeed;
    uniform float noiseSpeed;
    uniform vec2 resolution;
    uniform float yOffset;
    uniform float xOffset;
    varying vec2 vUv;
    varying vec3 vViewPosition;
    varying vec3 vNormal;
    
    void main() {
      vUv = uv;
      
      // Apply xOffset and yOffset to the entire mesh by shifting the position
      vec3 positionWithOffset = position;
      positionWithOffset.y += yOffset * resolution.y; // Scale by resolution for pixel-based offset
      positionWithOffset.x += xOffset * resolution.x; // Scale by resolution for pixel-based offset
      
      // Pass normal and view position for lighting calculations
      vNormal = normalMatrix * normal;
      vec4 mvPosition = modelViewMatrix * vec4(positionWithOffset, 1.0);
      vViewPosition = -mvPosition.xyz;
      
      gl_Position = projectionMatrix * modelViewMatrix * vec4(positionWithOffset, 1.0);
    }
  `,ki=`
    uniform float time;
    uniform vec2 resolution;
    uniform float yOffset;
    uniform float xOffset;
    uniform float topEdgeSoftness;
    uniform float bottomEdgeSoftness;
    uniform float leftEdgeSoftness;
    uniform float rightEdgeSoftness;
    uniform float fadeWidth;
    uniform float leftCornerRoundness;
    uniform float rightCornerRoundness;
    uniform float edgeNoiseAmount;
    uniform float edgeNoiseScale;
    uniform float edgeDepth;
    uniform float edgeContrast;
    uniform vec3 color1;
    uniform vec3 color2;
    uniform float colorDarkness;
    uniform float colorWaveInfluence;
    uniform float colorFrequencyShift;
    uniform float colorAmplitudeEffect;
    uniform float noiseScale;
    uniform float waveAmplitude;
    uniform float waveFrequency;
    uniform float waveDepth;
    uniform vec2 flowDirection;
    uniform float noiseInfluence;
    uniform float layerOffset;
    uniform vec3 lightDirection;
    uniform float ambientLight;
    uniform float directionalLight;
    uniform float specularStrength;
    uniform float shininess;
    uniform float colorCycleSpeed;
    uniform float colorCycleOffset;
    uniform float noiseSpeed;
    uniform float waveSpeed;
    uniform float filmNoiseIntensity;
    uniform float filmNoiseSpeed;
    uniform float filmGrainSize;
    uniform float filmScratchIntensity;
    uniform bool filmGrainEnabled; // Flag to completely disable film grain for performance
    uniform bool bottomWaveEnabled;
    uniform float bottomWaveDepth;
    uniform float bottomWaveWidth;
    uniform float bottomWaveSpeed;
    uniform float bottomWaveOffset;
    varying vec2 vUv;
    varying vec3 vViewPosition;
    varying vec3 vNormal;
    
    // Pseudo-random function
    float random(vec2 st) {
      return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);
    }
    
    // Improved 2D noise function with smoother transitions
    float noise(vec2 st) {
      vec2 i = floor(st);
      vec2 f = fract(st);
      
      // Four corners in 2D of a tile
      float a = random(i);
      float b = random(i + vec2(1.0, 0.0));
      float c = random(i + vec2(0.0, 1.0));
      float d = random(i + vec2(1.0, 1.0));
      
      // Cubic Hermite interpolation for smoother transitions
      vec2 u = f * f * (3.0 - 2.0 * f);
      
      // Mix 4 corners with smoother interpolation
      return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
    }
    
    // Enhanced Fractal Brownian Motion (FBM) for smoother noise
    float fbm(vec2 st) {
      float value = 0.0;
      float amplitude = 0.5;
      float frequency = 1.0;
      
      // Loop of octaves with more iterations for smoother detail
      for (int i = 0; i < 6; i++) {
        value += amplitude * noise(st * frequency);
        st += st * 0.2; // Domain warping for more organic patterns
        frequency *= 2.0;
        amplitude *= 0.5;
      }
      
      return value;
    }
    
    // Smooth interpolation function
    float smoothInterpolation(float edge0, float edge1, float x) {
      // Hermite interpolation for smoother transitions
      float t = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);
      return t * t * (3.0 - 2.0 * t);
    }
    
    // Extract color intensity (brightness) from a color
    float getColorIntensity(vec3 color) {
      // Use luminance formula to get perceived brightness
      return dot(color, vec3(0.299, 0.587, 0.114));
    }
    
    // Extract color hue from RGB
    float getColorHue(vec3 color) {
      float minVal = min(min(color.r, color.g), color.b);
      float maxVal = max(max(color.r, color.g), color.b);
      float delta = maxVal - minVal;
      
      float hue = 0.0;
      if (delta > 0.0) {
        if (maxVal == color.r) {
          hue = (color.g - color.b) / delta;
          if (hue < 0.0) hue += 6.0;
        } else if (maxVal == color.g) {
          hue = 2.0 + (color.b - color.r) / delta;
        } else {
          hue = 4.0 + (color.r - color.g) / delta;
        }
        hue /= 6.0;
      }
      return hue;
    }
    
    // Function to create a wave pattern with depth effect and color influence
    float wavePattern(vec2 uv, float depth, vec3 localColor) {
      // Extract color properties to influence the wave
      float colorIntensity = getColorIntensity(localColor);
      float colorHue = getColorHue(localColor);
      
      // Create flow direction based on time, modified by color
      vec2 colorModifiedFlow = flowDirection;
      // Make flow direction respond to color hue
      colorModifiedFlow += vec2(cos(colorHue * 6.28), sin(colorHue * 6.28)) * colorWaveInfluence * 0.5;
      
      // Apply waveSpeed to the time component of the sine waves to control actual wave speed
      // Use continuous time for perfectly smooth wave motion
      float timeComponent = time * waveSpeed;
      
      // Create a depth-dependent time component for better synergy between depth and color cycling
      // This makes different depth layers cycle at slightly different rates
      float depthTimeComponent = timeComponent * (1.0 - depth * 0.3);
      
      // Reduce the flow direction influence for less translation and more morphing
      // This creates a moving coordinate system that flows in the specified direction but with less movement
      vec2 flowUv = uv + colorModifiedFlow * depthTimeComponent * 0.3;
      
      // Add time-based distortion to create organic morphing effect
      // This creates bulging and receding areas that change over time
      // Make the morphing respond to depth for better synergy
      float morphStrength = 0.05 * (1.0 - depth * 0.3);
      vec2 morphUv = flowUv;
      morphUv.x += sin(uv.y * 3.0 + depthTimeComponent * 0.7) * morphStrength;
      morphUv.y += cos(uv.x * 2.5 + depthTimeComponent * 0.6) * morphStrength;
      
      // Modify frequency based on color
      float frequencyMod = waveFrequency * (1.0 + (colorHue - 0.5) * colorFrequencyShift);
      
      // Create multiple wave layers with different frequencies for depth
      // Use color intensity to modify wave phase
      float colorPhaseShift = colorIntensity * colorWaveInfluence * 3.0;
      
      // Color cycling is now handled separately in the main function
      // Wave patterns use only regular time to prevent speed accumulation
      
      // Create pulsing amplitude effect over time for more organic movement
      // Make the pulse effect respond to depth for better synergy
      float pulseEffect = sin(depthTimeComponent * 0.2) * 0.2 + 0.8;
      
      // Generate waves with more organic variation
      // Make the waves directly respond to the depth parameter for better depth-color synergy
      float depthFactor = 1.0 - depth * 0.5; // Higher value for foreground
      
      // Use depth to influence wave frequency and phase for better synergy
      // Create wave patterns that are independent of color cycling to prevent speed accumulation
      float wave1 = sin(morphUv.x * frequencyMod * (4.0 + depth) + depthTimeComponent * depthFactor + colorPhaseShift) * 0.5 + 0.5;
      float wave2 = sin(morphUv.y * frequencyMod * (3.0 + depth * 0.5) + depthTimeComponent * 0.7 * depthFactor + colorPhaseShift * 0.8) * 0.5 + 0.5;
      float wave3 = sin((morphUv.x + morphUv.y) * frequencyMod * (2.0 + depth * 0.3) + depthTimeComponent * 1.3 * depthFactor + colorPhaseShift * 0.6) * 0.5 + 0.5;
      
      // Apply depth offset to create parallax effect
      float depthOffset = depth * layerOffset;
      
      // Combine waves with weighted averaging for a more complex pattern
      // Use color components as weights for a more direct relationship between color and wave pattern
      float rWeight = localColor.r * 0.33 + 0.22; // Weight influenced by red component
      float gWeight = localColor.g * 0.33 + 0.22; // Weight influenced by green component
      float bWeight = localColor.b * 0.33 + 0.22; // Weight influenced by blue component
      
      // Normalize weights to ensure they sum to 1.0
      float totalWeight = rWeight + gWeight + bWeight;
      rWeight /= totalWeight;
      gWeight /= totalWeight;
      bWeight /= totalWeight;
      
      float wave = wave1 * rWeight + wave2 * gWeight + wave3 * bWeight;
      
      // Apply noise influence for organic movement with more variation
      // Use a more dynamic noise pattern that changes over time
      // Make noise pattern respond to depth for better synergy
      float noiseTimeComponent = time * 0.1 * noiseSpeed * (1.0 - depth * 0.3);
      float noiseValue = fbm((uv + vec2(sin(timeComponent * 0.1), cos(timeComponent * 0.15))) * noiseScale + noiseTimeComponent);
      
      // Use color intensity to control noise mixing with more influence
      float noiseMix = noiseInfluence * depthFactor * (1.0 + colorIntensity * colorWaveInfluence);
      wave = mix(wave, noiseValue, clamp(noiseMix, 0.0, 1.0));
      
      // Apply color-based amplitude modulation with time-based pulsing
      // Make amplitude modulation respond to depth for better synergy
      float amplitudeMod = pulseEffect * (1.0 + (colorIntensity - 0.5) * colorAmplitudeEffect * depthFactor);
      wave = 0.5 + (wave - 0.5) * amplitudeMod;
      
      return clamp(wave, 0.0, 1.0);
    }
    
    // Function to calculate normal based on wave height field
    vec3 calculateNormal(vec2 uv, vec3 localColor) {
      float epsilon = 0.01;
      
      // Sample wave heights at nearby points
      float center = wavePattern(uv, 0.5, localColor);
      float right = wavePattern(uv + vec2(epsilon, 0.0), 0.5, localColor);
      float top = wavePattern(uv + vec2(0.0, epsilon), 0.5, localColor);
      
      // Calculate gradient
      // Use color intensity to affect the wave amplitude with time-based variation
      float colorIntensity = getColorIntensity(localColor);
      float timeComponent = time * waveSpeed;
      float pulseEffect = sin(timeComponent * 0.2) * 0.2 + 0.8;
      
      // Apply a more dynamic amplitude modulation for the normal calculation
      float amplitudeMod = waveAmplitude * pulseEffect * (1.0 + (colorIntensity - 0.5) * colorAmplitudeEffect);
      
      // Create more pronounced normals for a stronger 3D effect
      vec3 dx = vec3(epsilon, 0.0, (right - center) * amplitudeMod * 1.5);
      vec3 dy = vec3(0.0, epsilon, (top - center) * amplitudeMod * 1.5);
      
      // Cross product to get normal
      return normalize(cross(dx, dy));
    }
    
    // Function to calculate a non-linear edge fade with corner rounding
    float calculateEdgeFade(vec2 uv) {
      // Calculate distance from center (0.5, 0.5)
      vec2 centeredUV = uv - 0.5;
      
      // Calculate vertical distance for top/bottom fade with different handling for top vs bottom
      float verticalDist;
      if (centeredUV.y < 0.0) {
        // Bottom half - use full edgeDepth to ensure visibility
        if (bottomWaveEnabled) {
          // Create a wave pattern for the bottom edge
          float waveX = uv.x + bottomWaveOffset + time * bottomWaveSpeed * 0.1;
          float wave = sin(waveX * bottomWaveWidth) * bottomWaveDepth;
          
          // Adjust the vertical distance based on the wave pattern
          // This creates a wave-like bottom edge
          float waveOffset = wave * 0.5 * edgeDepth; // Scale the wave by edgeDepth
          verticalDist = (abs(centeredUV.y) - waveOffset) / (0.5 * edgeDepth);
          verticalDist = max(verticalDist, 0.0); // Ensure we don't go negative
        } else {
          // Standard bottom edge without wave
          verticalDist = abs(centeredUV.y) / (0.5 * edgeDepth);
        }
      } else {
        // Top half - adjust for corner roundness to prevent cutting off
        verticalDist = abs(centeredUV.y) / (0.5 * edgeDepth);
      }
      
      // Calculate horizontal distance for left/right fade
      float horizontalDist;
      if (centeredUV.x < 0.0) {
        // Left side
        horizontalDist = abs(centeredUV.x) / (0.5 * edgeDepth);
      } else {
        // Right side
        horizontalDist = abs(centeredUV.x) / (0.5 * edgeDepth);
      }
      
      // Create a radial distance for corner rounding
      // Adjust the denominator to prevent cutting off at high corner roundness values
      float radialDist = length(centeredUV) / (0.7071 * edgeDepth);
      
      // Determine if we're on the left or right side
      float cornerRoundness = (centeredUV.x < 0.0) ? leftCornerRoundness : rightCornerRoundness;
      
      // Modify corner blending based on whether we're in the top or bottom half
      float cornerBlend;
      if (centeredUV.y < 0.0) {
        // Bottom half - full corner blending
        cornerBlend = smoothstep(0.0, 1.0, pow(horizontalDist, 1.5));
      } else {
        // Top half - reduce corner blending effect as we approach the top edge
        // This prevents the top edge from being cut off with high corner roundness
        float topFactor = smoothstep(0.3, 0.5, abs(centeredUV.y) / 0.5);
        cornerBlend = smoothstep(0.0, 1.0, pow(horizontalDist, 1.5)) * (1.0 - topFactor * cornerRoundness * 0.5);
      }
      
      // Blend between vertical and radial distance
      float distanceField = mix(verticalDist, radialDist, cornerBlend * cornerRoundness);
      
      // Apply noise to the edge for a more organic, burn-in look
      float edgeNoise = fbm((uv + time * 0.01) * edgeNoiseScale) * edgeNoiseAmount;
      distanceField = distanceField + (edgeNoise - edgeNoiseAmount * 0.5) * 0.2;
      
      // Apply contrast to the edge
      distanceField = pow(distanceField, edgeContrast);
      
      return distanceField;
    }
    
    // Function to generate film grain noise (optimized)
    float filmGrain(vec2 uv, float grainTime) {
      // Single random call instead of two for better performance
      // Pre-multiply by filmGrainSize to reduce per-pixel calculations
      return random(uv * filmGrainSize + grainTime) * 2.0 - 1.0;
    }
    
    // Function to generate film scratches
    float filmScratches(vec2 uv, float time) {
      // Vertical scratches
      float scratch = 0.0;
      
      // Create a few random scratches
      for (int i = 0; i < 3; i++) {
        float seed = float(i) * 1.3;
        float xPos = fract(sin(time * 0.01 + seed) * 43758.5453);
        float height = fract(sin(time * 0.01 + seed + 1.0) * 43758.5453) * 0.5 + 0.5;
        float width = 0.002 * (sin(time * 0.1 + seed) * 0.5 + 0.5);
        
        // Check if we're within a scratch
        if (abs(uv.x - xPos) < width && random(vec2(uv.y * 100.0, time + seed)) > 0.3) {
          scratch += 1.0 - smoothstep(0.0, width, abs(uv.x - xPos));
        }
      }
      
      // Add some horizontal scratches too
      for (int i = 0; i < 2; i++) {
        float seed = float(i) * 2.7 + 10.0;
        float yPos = fract(sin(time * 0.005 + seed) * 43758.5453);
        float width = 0.001 * (sin(time * 0.2 + seed) * 0.5 + 0.5);
        
        if (abs(uv.y - yPos) < width && random(vec2(uv.x * 100.0, time + seed)) > 0.7) {
          scratch += 1.0 - smoothstep(0.0, width, abs(uv.y - yPos));
        }
      }
      
      return clamp(scratch, 0.0, 1.0);
    }
    
    // Function to apply film noise effects (optimized)
    vec3 applyFilmNoise(vec3 color, vec2 uv) {
      // Early exit if film grain is disabled or intensity is zero
      if (!filmGrainEnabled || (filmNoiseIntensity == 0.0 && filmScratchIntensity == 0.0)) {
        return color;
      }
      
      // Cache time calculation (single operation instead of multiple)
      float grainTime = time * filmNoiseSpeed * 10.0;
      
      // Apply grain only if intensity > 0
      if (filmNoiseIntensity > 0.0) {
        float grain = filmGrain(uv, grainTime);
        color += grain * filmNoiseIntensity;
      }
      
      // Apply scratches only if intensity > 0 (scratches are disabled by default)
      if (filmScratchIntensity > 0.0) {
        float scratches = filmScratches(uv, grainTime * 0.5);
        color += scratches * filmScratchIntensity;
      }
      
      return color;
    }
    
    void main() {
      vec2 uv = vUv;
      
      // Get initial color blend for feedback
      // Create a time-varying color mix for more dynamic effects
      // Make the color mix factor respond to the wave depth for better synergy
      float waveDepthFactor = waveDepth * (1.0 + sin(time * 0.3) * 0.1);
      
      // Create a more dynamic color mix that's influenced by the wave depth
      // Use separate time for color cycling to prevent wave intensity accumulation
      float colorCycleTime = time + colorCycleOffset;
      float colorCyclePhase = colorCycleTime * colorCycleSpeed;
      float colorMixFactor = sin(colorCyclePhase * 0.1) * 0.1 + 0.5;
      
      // Create initial color blend
      vec3 initialColor = mix(color1, color2, colorMixFactor);
      
      // Create multiple depth layers for parallax effect with consistent color influence
      float foregroundWave = wavePattern(uv, 0.0, initialColor); // Foreground layer
      float middleWave = wavePattern(uv, 0.5, initialColor);     // Middle layer
      float backgroundWave = wavePattern(uv, 1.0, initialColor); // Background layer
      
      // Create more dynamic depth-based color mixing
      // Use the wave patterns to create more interesting color blends
      // Make the color mixing directly respond to the wave amplitude
      
      // Create a more dynamic color transition based on wave patterns
      // This creates a more direct relationship between wave height and color
      float foregroundColorMix = mix(0.3, 0.7, foregroundWave);
      float backgroundColorMix = mix(0.7, 0.3, backgroundWave);
      
      // Apply color cycling that's synchronized with the wave patterns
      // Reduce the influence of colorCyclePhase to minimize optical motion during scrubbing
      float reducedCycleInfluence = waveDepthFactor * 0.2; // Reduced from 0.5 to 0.2
      foregroundColorMix = mix(foregroundColorMix, sin(colorCyclePhase + foregroundWave * 3.14) * 0.5 + 0.5, reducedCycleInfluence);
      backgroundColorMix = mix(backgroundColorMix, sin(colorCyclePhase + backgroundWave * 3.14 + 1.57) * 0.5 + 0.5, reducedCycleInfluence);
      
      vec3 foregroundColor = mix(color1, color2, foregroundColorMix);
      vec3 backgroundColor = mix(color2, color1, backgroundColorMix);
      
      // Add subtle color variations that are synchronized with the wave patterns
      // Reduce the intensity of color variations to minimize optical motion during scrubbing
      // Use colorCycleTime for color variations to maintain continuity
      float waveSyncFactor = sin(time * waveSpeed * 0.2) * 0.5 + 0.5;
      foregroundColor += vec3(sin(colorCycleTime * 0.5) * 0.015, cos(colorCycleTime * 0.6) * 0.015, sin(colorCycleTime * 0.7) * 0.015) * foregroundWave;
      backgroundColor += vec3(cos(colorCycleTime * 0.4) * 0.015, sin(colorCycleTime * 0.5) * 0.015, cos(colorCycleTime * 0.6) * 0.015) * backgroundWave;
      
      // Create a more dynamic depth blend that's influenced by the wave depth parameter
      // This creates a stronger connection between the depth parameter and the visual effect
      float depthBlendRange = 0.3 + waveDepthFactor * 0.4; // Dynamic blend range based on wave depth
      float depthBlendMin = 0.5 - depthBlendRange * 0.5;
      float depthBlendMax = 0.5 + depthBlendRange * 0.5;
      float depthBlend = smoothInterpolation(depthBlendMin, depthBlendMax, middleWave);
      
      // Make the depth blend more responsive to the wave pattern
      depthBlend = mix(depthBlend, middleWave, waveDepthFactor * 0.5);
      
      // Create a more dynamic color blend based on wave patterns
      vec3 baseColor = mix(backgroundColor, foregroundColor, depthBlend);
      
      // Apply a subtle color shift based on the wave pattern
      // This creates a more direct relationship between wave height and color
      float colorShiftAmount = waveDepthFactor * 0.2;
      vec3 shiftedColor = mix(baseColor, 
                             vec3(baseColor.r * (1.0 + middleWave * 0.1),
                                  baseColor.g * (1.0 + foregroundWave * 0.1),
                                  baseColor.b * (1.0 + backgroundWave * 0.1)),
                             colorShiftAmount);
      baseColor = shiftedColor;
      
      // Apply darkness to the colors with slight time variation for "breathing" effect
      // Synchronize the darkness variation with the wave pattern, reduced intensity for less optical motion
      // Keep using time for wave-related breathing effect
      float darknessVariation = colorDarkness * (1.0 + sin(time * 0.2) * 0.025 + middleWave * 0.05);
      baseColor = mix(baseColor, vec3(0.0, 0.0, 0.0), darknessVariation);
      
      // Calculate lighting based on wave normal with consistent color influence
      vec3 waveNormal = calculateNormal(uv, initialColor);
      
      // Blend between the wave normal and the surface normal for subtle effect
      // Make the normal blend more dynamic with time and directly tied to the wave depth
      // Use the wave pattern to directly influence the normal calculation
      float normalBlendFactor = waveDepthFactor * (0.5 + middleWave * 0.5);
      // Add variation to the normal based on the wave pattern
      vec3 modifiedWaveNormal = waveNormal;
      modifiedWaveNormal.xy += vec2(sin(foregroundWave * 6.28) * 0.1, cos(backgroundWave * 6.28) * 0.1) * waveDepthFactor;
      modifiedWaveNormal = normalize(modifiedWaveNormal);
      
      vec3 normal = normalize(mix(vNormal, modifiedWaveNormal, normalBlendFactor));
      
      // Lighting calculations
      vec3 viewDir = normalize(vViewPosition);
      vec3 lightDir = normalize(lightDirection);
      
      // Add subtle movement to the light direction for more dynamic lighting
      // Synchronize light movement with wave patterns for better synergy, reduced intensity
      // Make the light direction respond directly to the wave pattern (keep using time for wave-related motion)
      lightDir.x += sin(time * 0.2) * 0.025 * middleWave;
      lightDir.y += cos(time * 0.25) * 0.025 * middleWave;
      // Add a subtle rotation to the light direction based on the wave pattern
      float lightRotation = (foregroundWave - 0.5) * waveDepthFactor * 0.2;
      vec3 rotatedLightDir = vec3(
          lightDir.x * cos(lightRotation) - lightDir.y * sin(lightRotation),
          lightDir.x * sin(lightRotation) + lightDir.y * cos(lightRotation),
          lightDir.z
      );
      lightDir = normalize(rotatedLightDir);
      
      // Ambient lighting with subtle color variation
      // Make the ambient color variation respond to the wave pattern, reduced intensity
      // Create a more dynamic ambient color that's influenced by the wave pattern (keep using time for wave-related motion)
      vec3 ambientVariation = vec3(sin(time * 0.3) * 0.015, cos(time * 0.4) * 0.015, sin(time * 0.5) * 0.015) * middleWave;
      // Add color cycling to the ambient lighting
      ambientVariation += (foregroundColor - backgroundColor) * foregroundWave * 0.05 * waveDepthFactor;
      vec3 ambientColor = baseColor * (1.0 + ambientVariation);
      vec3 ambient = ambientLight * ambientColor;
      
      // Diffuse lighting with enhanced contrast
      // Make the diffuse lighting more responsive to the wave pattern
      float diff = max(dot(normal, lightDir), 0.0);
      // Add variation to the diffuse lighting based on the wave pattern
      diff = pow(diff, 1.2 + foregroundWave * 0.3); // Add contrast to the diffuse lighting
      // Enhance diffuse lighting based on wave height for better synergy
      diff *= 1.0 + middleWave * waveDepthFactor * 0.5;
      // Add a subtle color shift to the diffuse lighting based on the wave pattern
      vec3 diffuseColor = baseColor;
      diffuseColor = mix(diffuseColor, foregroundColor, foregroundWave * waveDepthFactor * 0.2);
      vec3 diffuse = directionalLight * diff * diffuseColor;
      
      // Specular lighting (Blinn-Phong) with time-based variation
      vec3 halfwayDir = normalize(lightDir + viewDir);
      // Make the specular power respond to the wave pattern
      float specPower = shininess * (1.0 + foregroundWave * waveDepthFactor * 2.0);
      float spec = pow(max(dot(normal, halfwayDir), 0.0), specPower);
      // Add time-based variation to the specular highlights
      // Synchronize specular highlights with wave patterns, reduced intensity (keep using time for wave-related motion)
      float specularVariation = 1.0 + sin(time * 0.5) * 0.1 * foregroundWave;
      // Add color to the specular highlights based on the wave pattern
      vec3 specularColor = mix(vec3(1.0), foregroundColor * 1.5, foregroundWave * waveDepthFactor * 0.3);
      vec3 specular = specularStrength * specularVariation * spec * specularColor;
      
      // Combine lighting components
      vec3 color = ambient + diffuse + specular;
      
      // Add highlights based on wave height for extra depth with more variation
      // Make highlights directly respond to the wave pattern for better synergy, reduced intensity (keep using time for wave-related motion)
      float highlightIntensity = smoothInterpolation(0.4, 0.6, foregroundWave) * waveDepthFactor * (1.0 + sin(time * 0.4) * 0.1);
      // Add color tint to highlights based on the wave pattern
      // Create a more dynamic highlight color that's influenced by the wave pattern
      vec3 highlightColor = mix(vec3(0.1, 0.1, 0.15), mix(color1, color2, foregroundWave) * 0.5, waveDepthFactor * 0.5);
      // Add variation to the highlight color based on the wave pattern
      highlightColor = mix(highlightColor, foregroundColor * 0.7, middleWave * 0.5);
      color += highlightColor * highlightIntensity;
      
      // Apply film noise effects
      color = applyFilmNoise(color, uv);
      
      // Calculate non-linear edge fade with corner rounding
      float distanceField = calculateEdgeFade(uv);
      
      // Apply different softness to all edges
      float alpha = 1.0;
      
      // Vertical edges (top/bottom)
      if (uv.y >= 0.5) {
        // Top half
        float normalizedDist = (distanceField - 0.5) / 0.5; // Normalize to 0-1 range for top half
        alpha *= 1.0 - smoothInterpolation(1.0 - topEdgeSoftness, 1.0, normalizedDist);
      } else {
        // Bottom half
        float normalizedDist = (distanceField - 0.5) / 0.5; // Normalize to 0-1 range for bottom half
        alpha *= 1.0 - smoothInterpolation(1.0 - bottomEdgeSoftness, 1.0, normalizedDist);
      }
      
      // Horizontal edges (left/right)
      if (uv.x >= 0.5) {
        // Right half
        float normalizedDist = (abs(uv.x - 0.5) / 0.5) / edgeDepth;
        alpha *= 1.0 - smoothInterpolation(1.0 - rightEdgeSoftness, 1.0, normalizedDist);
      } else {
        // Left half
        float normalizedDist = (abs(uv.x - 0.5) / 0.5) / edgeDepth;
        alpha *= 1.0 - smoothInterpolation(1.0 - leftEdgeSoftness, 1.0, normalizedDist);
      }
      
      // Add subtle noise to alpha for a more organic edge (keep using time for wave-related motion)
      float edgeNoise = fbm(uv * noiseScale * 2.0 + time * 0.05 * noiseSpeed);
      alpha *= 0.95 + edgeNoise * 0.05;

      gl_FragColor = vec4(color, alpha);
    }
  `,Pi=new et(window.innerWidth,window.innerHeight,window.innerWidth/10,window.innerHeight/10),Ri=new no({vertexShader:Oi,fragmentShader:ki,uniforms:f,transparent:!0,side:Xo}),_t=new $o(Pi,Ri);de.add(_t),window.gui=new Ys({width:300,closed:!0});const A=window.gui;A.domElement.style.position="absolute",A.domElement.style.top="10px",A.domElement.style.right="10px";const vo=A.domElement.querySelector(".close-button");vo&&(vo.innerHTML="Open Controls",vo.addEventListener("click",function(){setTimeout(()=>{this.innerHTML=A.closed?"Open Controls":"Close Controls"},50)}));const hn=A.addFolder("Camera Controls");hn.add(ye,"zoom",.1,5).name("Zoom Level").step(.001).onChange(s=>{N.zoom=s,N.updateProjectionMatrix()}),hn.close();const it=A.addFolder("Animation Speed Controls");it.add(f.mainSpeed,"value",1e-4,.1).name("Main Speed").step(1e-4).onChange(s=>{f.mainSpeed.value=s}),it.add(f.waveSpeed,"value",1e-4,5).name("Wave Speed").step(1e-4).onChange(s=>{f.waveSpeed.value=s}),it.add(f.noiseSpeed,"value",1e-4,5).name("Noise Speed").step(1e-4).onChange(s=>{f.noiseSpeed.value=s}),it.add(f.colorCycleSpeed,"value",1e-6,5).name("Color Cycle Speed").step(1e-6).onChange(s=>{f.colorCycleSpeed.value=s}),it.add(f.colorCycleOffset,"value",0,6.28).name("Color Cycle Offset").step(.01).onChange(s=>{f.colorCycleOffset.value=s}),it.open();const Ze=A.addFolder("Color Controls"),Li="#"+f.color1.value.getHexString(),Fi="#"+f.color2.value.getHexString();Ze.addColor({color:Li},"color").name("Color 1").onChange(s=>{typeof s=="string"?f.color1.value.set(s):f.color1.value.setRGB(s.r/255,s.g/255,s.b/255)}),Ze.addColor({color:Fi},"color").name("Color 2").onChange(s=>{typeof s=="string"?f.color2.value.set(s):f.color2.value.setRGB(s.r/255,s.g/255,s.b/255)}),Ze.add(f.colorDarkness,"value",0,2).name("Color Darkness").step(.001).onChange(s=>{f.colorDarkness.value=s}),Ze.add(f.colorWaveInfluence,"value",0,1).name("Color  Wave Influence").onChange(s=>{f.colorWaveInfluence.value=s}),Ze.add(f.colorFrequencyShift,"value",0,1).name("Color  Frequency Effect").onChange(s=>{f.colorFrequencyShift.value=s}),Ze.add(f.colorAmplitudeEffect,"value",0,1).name("Color  Amplitude Effect").onChange(s=>{f.colorAmplitudeEffect.value=s}),Ze.open();const Qe=A.addFolder("Wave Controls");Qe.add(f.waveAmplitude,"value",0,12).step(1e-4).name("Wave Amplitude").onChange(s=>{f.waveAmplitude.value=s}),Qe.add(f.waveFrequency,"value",.1,5).name("Wave Frequency").onChange(s=>{f.waveFrequency.value=s}),Qe.add(f.waveDepth,"value",0,1).name("Wave Depth Effect").onChange(s=>{f.waveDepth.value=s}),Qe.add(f.noiseScale,"value",0,5).name("Noise Scale").onChange(s=>{f.noiseScale.value=s}),Qe.add(f.noiseInfluence,"value",0,1).name("Noise Influence").onChange(s=>{f.noiseInfluence.value=s}),Qe.add(f.layerOffset,"value",0,1).name("Layer Depth Offset").onChange(s=>{f.layerOffset.value=s});const pn=Qe.addFolder("Flow Direction");pn.add(f.flowDirection.value,"x",-2,2).name("Horizontal Flow").onChange(s=>{f.flowDirection.value.x=s}),pn.add(f.flowDirection.value,"y",-2,2).name("Vertical Flow").onChange(s=>{f.flowDirection.value.y=s});const be=A.addFolder("Appearance Controls"),Nt=A.addFolder("Film Noise Controls");Nt.add(f.filmNoiseIntensity,"value",0,1).name("Noise Intensity").onChange(s=>{f.filmNoiseIntensity.value=s}),Nt.add({speed:f.filmNoiseSpeed.value*1e6},"speed",1,8).name("Noise Speed (1e-6)").step(.1).onChange(s=>{f.filmNoiseSpeed.value=s*1e-6}),Nt.add(f.filmGrainSize,"value",.5,50).name("Grain Size").onChange(s=>{f.filmGrainSize.value=s}),Nt.add(f.filmScratchIntensity,"value",0,.1).name("Scratch Intensity").onChange(s=>{f.filmScratchIntensity.value=s}),be.add(f.xOffset,"value",-1,1).step(.001).name("X Position").onChange(s=>{f.xOffset.value=s}),be.add(f.yOffset,"value",-1,1).step(.001).name("Y Position").onChange(s=>{f.yOffset.value=s}),be.add(f.fadeWidth,"value",.1,1).name("Visible Area Size").onChange(s=>{f.fadeWidth.value=s}),be.add(f.topEdgeSoftness,"value",0,1).name("Top Edge Softness").onChange(s=>{f.topEdgeSoftness.value=s}),be.add(f.bottomEdgeSoftness,"value",0,1).name("Bottom Edge Softness").onChange(s=>{f.bottomEdgeSoftness.value=s}),be.add(f.leftEdgeSoftness,"value",0,1).name("Left Edge Softness").onChange(s=>{f.leftEdgeSoftness.value=s}),be.add(f.rightEdgeSoftness,"value",0,1).name("Right Edge Softness").onChange(s=>{f.rightEdgeSoftness.value=s}),be.add(f.leftCornerRoundness,"value",0,1).name("Left Corner Roundness").onChange(s=>{f.leftCornerRoundness.value=s}),be.add(f.rightCornerRoundness,"value",0,1).name("Right Corner Roundness").onChange(s=>{f.rightCornerRoundness.value=s}),be.add(f.edgeDepth,"value",.1,3).name("Edge Burn-in Depth").onChange(s=>{f.edgeDepth.value=s}),be.add(f.edgeContrast,"value",.5,3).name("Edge Contrast").onChange(s=>{f.edgeContrast.value=s}),be.add(f.edgeNoiseAmount,"value",0,1).name("Edge Noise Amount").onChange(s=>{f.edgeNoiseAmount.value=s}),be.add(f.edgeNoiseScale,"value",.5,10).name("Edge Noise Scale").onChange(s=>{f.edgeNoiseScale.value=s});const wt=A.addFolder("Bottom Wave Edge Controls");wt.add(f.bottomWaveEnabled,"value").name("Enable Bottom Wave").onChange(s=>{f.bottomWaveEnabled.value=s,E&&H.responsive&&st()}),wt.add(f.bottomWaveDepth,"value",0,.5).name("Wave Depth").step(.001).onChange(s=>{f.bottomWaveDepth.value=s,E&&H.responsive&&st()}),wt.add(f.bottomWaveWidth,"value",1,20).name("Wave Width").step(.001).onChange(s=>{f.bottomWaveWidth.value=s}),wt.add(f.bottomWaveSpeed,"value",0,5).name("Wave Speed").step(.001).onChange(s=>{f.bottomWaveSpeed.value=s}),wt.add(f.bottomWaveOffset,"value",-5,5).name("Wave Offset").step(.001).onChange(s=>{f.bottomWaveOffset.value=s});const yt=A.addFolder("Lighting Controls");yt.add(f.ambientLight,"value",0,1).name("Ambient Light").onChange(s=>{f.ambientLight.value=s}),yt.add(f.directionalLight,"value",0,1).name("Directional Light").step(.001).onChange(s=>{f.directionalLight.value=s}),yt.add(f.specularStrength,"value",0,1).step(.001).name("Specular Strength").onChange(s=>{f.specularStrength.value=s}),yt.add(f.shininess,"value",1,128).name("Shininess").onChange(s=>{f.shininess.value=s});const _o=yt.addFolder("Light Direction");_o.add(f.lightDirection.value,"x",-1,1).name("X").onChange(()=>{f.lightDirection.value.normalize()}),_o.add(f.lightDirection.value,"y",-1,1).name("Y").onChange(()=>{f.lightDirection.value.normalize()}),_o.add(f.lightDirection.value,"z",0,1).name("Z").onChange(()=>{f.lightDirection.value.normalize()});const ne=A.addFolder("Globe Model Controls"),zt=new ai(16777215,10);zt.position.set(1,1,1),de.add(zt);const wo=new Es(16777215,.5);de.add(wo);const mn=ne.addFolder("Lighting");mn.add({intensity:3},"intensity",0,5).name("Direct Light").onChange(s=>{zt.intensity=s}),zt.intensity=3,mn.add({intensity:wo.intensity},"intensity",0,5).name("Ambient Light").onChange(s=>{wo.intensity=s}),ne.add(H,"visible").name("Show Globe").onChange(s=>{E&&(E.visible=s)}),ne.add(H,"scale",.1,50).name("Size").step(.1).onChange(s=>{E&&(H.baseScale=s,nt(s))}),ne.add(H,"responsive").name("Responsive Size").onChange(s=>{!s&&E?nt(H.baseScale):s&&Ge()}),ne.add({resizeGlobe:function(){E&&Ge()}},"resizeGlobe").name("Force Resize"),ne.add({positionBehindWave:function(){E&&st()}},"positionBehindWave").name("Position Behind Wave");function st(){if(!E)return;const s=window.innerWidth;if(s<=768){E.position.y=0,E.position.z=-10;for(let _=0;_<Ee.__controllers.length;_++){const y=Ee.__controllers[_];y.property==="positionY"?y.setValue(0):y.property==="positionZ"&&y.setValue(-10)}return}if(s>768&&s<=1024){E.position.y=192,E.position.z=-10;for(let y=0;y<Ee.__controllers.length;y++){const w=Ee.__controllers[y];w.property==="positionY"?w.setValue(192):w.property==="positionZ"&&w.setValue(-10)}return}const u=-40,p=-10;E.position.y=u,E.position.z=p;for(let _=0;_<Ee.__controllers.length;_++){const y=Ee.__controllers[_];y.property==="positionY"?y.setValue(u):y.property==="positionZ"&&y.setValue(p)}}function Ge(){if(!E||!H.responsive)return;const s=window.innerWidth;if(s>1024){nt(40);for(let y=0;y<ne.__controllers.length;y++)if(ne.__controllers[y].property==="scale"){ne.__controllers[y].setValue(40);break}st();return}let u;s<=768?u=s*1.2:u=s*.9;const p={x:E.scale.x,y:E.scale.y,z:E.scale.z};try{E.scale.set(1,1,1),E.updateMatrixWorld(!0);const _=new Zo().setFromObject(E),y=_.max.x-_.min.x;E.scale.set(p.x,p.y,p.z);const O=(N.right-N.left)/N.zoom/s,I=u*O/y;nt(I);for(let R=0;R<ne.__controllers.length;R++)if(ne.__controllers[R].property==="scale"){ne.__controllers[R].setValue(I);break}st()}catch(_){D.error("Error updating globe size:",_),E.scale.set(p.x,p.y,p.z)}}const Ee=ne.addFolder("Position");Ee.add(H,"positionX",-500,500).name("X Position").step(1).onChange(s=>{E&&(E.position.x=s)}),Ee.add(H,"positionY",-500,500).name("Y Position").step(1).onChange(s=>{E&&(E.position.y=s)}),Ee.add(H,"positionZ",-500,500).name("Z Position").step(1).onChange(s=>{E&&(E.position.z=s)});const yo=ne.addFolder("Rotation");yo.add(H,"rotationX",0,360).name("X Rotation").step(1).onChange(s=>{E&&(E.rotation.x=s*Math.PI/180)}),yo.add(H,"rotationY",0,360).name("Y Rotation").step(1).onChange(s=>{E&&(E.rotation.y=s*Math.PI/180)}),yo.add(H,"rotationZ",0,360).name("Z Rotation").step(1).onChange(s=>{E&&(E.rotation.z=s*Math.PI/180)}),ne.add(H,"autoRotate").name("Auto Rotate").onChange(s=>{H.autoRotate=s}),ne.add(H,"baseRotateSpeed",.05,1).name("Base Rotation Speed").step(.01).onChange(s=>{H.baseRotateSpeed=s}),ne.add(H,"scrollRotateSpeed",.05,1).name("Scroll Rotation Speed").step(.01).onChange(s=>{H.scrollRotateSpeed=s}),ne.open();const ze=A.addFolder("Gradient Overlay Controls");ze.add(Z,"enabled").name("Show Overlay").onChange(s=>{G&&(G.visible=s)});const Di=ze.add(Z,"startOpacity",0,1).name("Top Opacity").step(.01).onChange(s=>{$&&($.uniforms.startOpacity.value=s)});Di.__li.querySelector(".property-name").innerHTML="Top Opacity (Top Edge)";const Ii=ze.add(Z,"endOpacity",0,1).name("Bottom Opacity").step(.01).onChange(s=>{$&&($.uniforms.endOpacity.value=s)});Ii.__li.querySelector(".property-name").innerHTML="Bottom Opacity (Bottom Edge)",ze.add(Z,"yOffset",-2,2).name("Vertical Position (moves only)").step(.01).onChange(s=>{G&&vt()}),ze.add(Z,"offsetY",-1,1).name("Gradient Shift").step(.01).onChange(s=>{$&&($.uniforms.offsetY.value=s)}),ze.add(Z,"height",.1,5).name("Gradient Distribution (not size)").step(.1).onChange(s=>{$&&($.uniforms.heightMultiplier.value=s)}),ze.addColor(Z,"color").name("Color").onChange(s=>{$&&$.uniforms.overlayColor.value.set(s)}),ze.add({debugOverlay:function(){if($){const s=$.uniforms.startOpacity.value,u=$.uniforms.endOpacity.value;$.uniforms.startOpacity.value=1,$.uniforms.endOpacity.value=1,$.uniforms.overlayColor.value.set("#FF00FF"),setTimeout(()=>{$.uniforms.startOpacity.value=s,$.uniforms.endOpacity.value=u,$.uniforms.overlayColor.value.set(Z.color)},2e3)}}},"debugOverlay").name("Debug Visibility"),ze.open();let ee=n.particleCount;D.log("[Background Init] Using particle count:",ee);let Pe=new Float32Array(ee*3),xe=new Float32Array(ee*3),se=new Float32Array(ee*3),bo=0,Co=0;const k={scrollSpeed:.005,verticalSpread:1,horizontalSpread:.56,damping:.95,depthRange:1e3,sizeMin:1.1,sizeMax:4,floatSpeed:.8,verticalOffset:0};let Te=window.innerHeight*k.verticalSpread,Re=window.innerWidth*k.horizontalSpread;function rt(){const s=new Float32Array(ee),u=new X(Ht.color);for(let p=0;p<ee;p++){const _=p*3,y=Math.random(),w=k.sizeMin+y*(k.sizeMax-k.sizeMin);s[p]=w/V.uniforms.baseSize.value;const O=.8+y*.6;se[_]=u.r*O,se[_+1]=u.g*O,se[_+2]=u.b*O}K.setAttribute("size",new ge(s,1)),K.attributes.position.needsUpdate=!0,K.attributes.color.needsUpdate=!0,K.attributes.size.needsUpdate=!0}for(let s=0;s<ee;s++){const u=s*3;Pe[u]=(Math.random()-.5)*Re,Pe[u+1]=(Math.random()-.5)*Te+k.verticalOffset,Pe[u+2]=Math.random()*500-250,xe[u]=(Math.random()-.5)*.5,xe[u+1]=(Math.random()-.5)*.5,xe[u+2]=(Math.random()-.5)*.2;const p=new X("#25e5ff");se[u]=p.r,se[u+1]=p.g,se[u+2]=p.b}const K=new co;K.setAttribute("position",new ge(Pe,3)),K.setAttribute("color",new ge(se,3)),Ot.track(K,"geometry");const So=Ni();Ot.track(So,"texture");function Ni(){const s=document.createElement("canvas");s.width=256,s.height=256;const u=s.getContext("2d"),p=u.createRadialGradient(s.width/2,s.height/2,0,s.width/2,s.height/2,s.width/2);p.addColorStop(0,"rgba(255, 255, 255, 1.0)"),p.addColorStop(.05,"rgba(255, 255, 255, 1.0)"),p.addColorStop(.2,"rgba(255, 255, 255, 0.9)"),p.addColorStop(.4,"rgba(255, 255, 255, 0.5)"),p.addColorStop(.6,"rgba(255, 255, 255, 0.3)"),p.addColorStop(.8,"rgba(255, 255, 255, 0.1)"),p.addColorStop(1,"rgba(255, 255, 255, 0)"),u.fillStyle=p,u.fillRect(0,0,s.width,s.height),u.beginPath(),u.moveTo(s.width/2,s.width*.3),u.lineTo(s.width/2,s.width*.7),u.moveTo(s.width*.3,s.height/2),u.lineTo(s.width*.7,s.height/2),u.moveTo(s.width*.35,s.height*.35),u.lineTo(s.width*.65,s.height*.65),u.moveTo(s.width*.65,s.height*.35),u.lineTo(s.width*.35,s.height*.65),u.strokeStyle="rgba(255, 255, 255, 1.0)",u.lineWidth=4,u.stroke();const _=u.createRadialGradient(s.width/2,s.height/2,s.width*.2,s.width/2,s.height/2,s.width*.7);_.addColorStop(0,"rgba(255, 255, 255, 0.3)"),_.addColorStop(.5,"rgba(255, 255, 255, 0.1)"),_.addColorStop(1,"rgba(255, 255, 255, 0)"),u.globalCompositeOperation="lighter",u.fillStyle=_,u.fillRect(0,0,s.width,s.height);const y=new Yo(s);return y.needsUpdate=!0,y}const gn=window.innerWidth<640&&window._mobileShaderScale>1?1/window._mobileShaderScale:1,V=new no({uniforms:{baseSize:{value:6},opacity:{value:0},map:{value:So},brightness:{value:1.4},haloStrength:{value:1.4},haloSize:{value:1.3},aspectCompensation:{value:gn}},vertexShader:`
      attribute vec3 color;
      attribute float size;
      uniform float baseSize;
      uniform float haloSize;
      
      varying vec3 vColor;
      varying float vSize;
      
      void main() {
        vColor = color;
        vSize = size;
        
        // Calculate position in clip space
        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
        gl_Position = projectionMatrix * mvPosition;
        
        // Apply individual size attribute without attenuation
        // Multiply by haloSize to make room for the glow effect
        gl_PointSize = size * baseSize * haloSize;
      }
    `,fragmentShader:`
      uniform sampler2D map;
      uniform float opacity;
      uniform float brightness;
      uniform float haloStrength;
      uniform float aspectCompensation; // 1.0 = no compensation, < 1.0 = squish X to counteract CSS stretch
      
      varying vec3 vColor;
      varying float vSize;
      
      void main() {
        // Compensate for CSS scaleX stretch by squishing UV coordinates in X
        // When CSS applies scaleX(1.5), we need to use aspectCompensation = 0.667
        // This makes the particle appear circular despite the stretched canvas
        vec2 compensatedUV = gl_PointCoord - 0.5;
        compensatedUV.x *= (1.0 / aspectCompensation); // Stretch X in UV space to counteract CSS squish
        
        // Calculate distance from center using compensated coordinates
        float dist = length(compensatedUV) * 2.0; // 0 at center, 1 at edge
        
        // Sample the texture with compensated UVs
        vec2 texUV = compensatedUV + 0.5;
        vec4 texColor = texture2D(map, texUV);
        
        // Discard pixels outside the circular area (important for stretched particles)
        if (dist > 1.0) discard;
        
        // Apply color, opacity and brightness
        vec3 brightColor = vColor * brightness;
        
        // Create a halo effect by boosting brightness near the center
        // and adding a subtle color shift toward white for the halo
        float haloFactor = max(0.0, 1.0 - dist);
        haloFactor = pow(haloFactor, 1.5); // Adjust power for halo shape
        
        // Boost the core brightness
        float coreBrightness = 1.0 + haloFactor * haloStrength;
        
        // Blend toward white for the halo (subtle color shift)
        vec3 haloColor = mix(brightColor, vec3(1.0, 1.0, 1.0), haloFactor * 0.3);
        
        // Apply the halo effect
        vec3 finalColor = haloColor * coreBrightness;
        
        // Apply color and opacity with enhanced brightness and halo
        gl_FragColor = vec4(finalColor, texColor.a * opacity);
        
        // Discard transparent pixels
        if (gl_FragColor.a < 0.05) discard;
      }
    `,transparent:!0,blending:Un,depthWrite:!1,depthTest:!1}),Bt=new qo(K,V);Bt.frustumCulled=!0,Se.add(Bt);function xo(){const s=window.innerWidth,u=window._mobileShaderScale||1;if(s<640&&u>1){const _=1/u;Bt.scale.set(_,1,1),V.uniforms.aspectCompensation.value=_,console.log(`%c[Particles] Applied compensation: scale=${_.toFixed(4)}, shader=${_.toFixed(4)}`,"color: cyan")}else Bt.scale.set(1,1,1),V.uniforms.aspectCompensation.value=1}xo();const re=A.addFolder("Particle System"),zi={count:ee};re.add(zi,"count",100,1e3,10).name("Particle Count").onChange(s=>{ee=Math.floor(s);const u=new Float32Array(ee*3),p=new Float32Array(ee*3),_=new Float32Array(ee*3);for(let y=0;y<ee;y++){const w=y*3;if(y<Pe.length/3)u[w]=Pe[w],u[w+1]=Pe[w+1],u[w+2]=Pe[w+2],p[w]=xe[w],p[w+1]=xe[w+1],p[w+2]=xe[w+2],_[w]=se[w],_[w+1]=se[w+1],_[w+2]=se[w+2];else{u[w]=(Math.random()-.5)*Re,u[w+1]=(Math.random()-.5)*Te+k.verticalOffset,u[w+2]=Math.random()*500-250,p[w]=(Math.random()-.5)*.5,p[w+1]=(Math.random()-.5)*.5,p[w+2]=(Math.random()-.5)*.2;const O=new X(Ht.color);_[w]=O.r,_[w+1]=O.g,_[w+2]=O.b}}Pe=u,xe=p,se=_,K.attributes.position&&(K.attributes.position.array=null),K.attributes.color&&(K.attributes.color.array=null),K.setAttribute("position",new ge(Pe,3)),K.setAttribute("color",new ge(se,3)),K.attributes.position.needsUpdate=!0,K.attributes.color.needsUpdate=!0,rt()});const Ht={color:"#25e5ff"};re.addColor(Ht,"color").name("Particle Color").onChange(s=>{const u=new X(s);for(let p=0;p<ee;p++){const _=p*3;se[_]=u.r,se[_+1]=u.g,se[_+2]=u.b}K.attributes.color?(K.attributes.color.array.set(se),K.attributes.color.needsUpdate=!0):K.setAttribute("color",new ge(se,3))}),re.add(V.uniforms.baseSize,"value",2,15,.5).name("Base Particle Size").onChange(s=>{rt()}),re.add(V.uniforms.opacity,"value",0,1,.1).name("Opacity"),re.add(V.uniforms.brightness,"value",1,3,.1).name("Brightness").onChange(s=>{V.uniforms.brightness.value=s});const Bi={intensity:1.5};re.add(Bi,"intensity",.1,3,.1).name("Sparkle Intensity").onChange(s=>{V.uniforms.opacity.value=s});const Hi={enabled:!1},Ui=re.add(Hi,"enabled").name("Size Attenuation").onChange(s=>{s?V.vertexShader=`
          attribute vec3 color;
          attribute float size;
          uniform float baseSize;
          
          varying vec3 vColor;
          
          void main() {
            vColor = color;
            
            // Calculate position in clip space
            vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
            gl_Position = projectionMatrix * mvPosition;
            
            // Apply size attenuation based on distance
            float distance = length(mvPosition.xyz);
            gl_PointSize = size * baseSize * (300.0 / distance);
          }
        `:V.vertexShader=`
          attribute vec3 color;
          attribute float size;
          uniform float baseSize;
          
          varying vec3 vColor;
          
          void main() {
            vColor = color;
            
            // Calculate position in clip space
            vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
            gl_Position = projectionMatrix * mvPosition;
            
            // Apply individual size attribute without attenuation
            gl_PointSize = size * baseSize;
          }
        `,V.needsUpdate=!0,rt()}),pe=document.createElement("div");pe.className="gui-tooltip",pe.textContent="When enabled, particles appear smaller as they move further away",pe.style.position="absolute",pe.style.backgroundColor="rgba(0,0,0,0.8)",pe.style.color="#fff",pe.style.padding="5px",pe.style.borderRadius="3px",pe.style.fontSize="11px",pe.style.zIndex="10000",pe.style.display="none",document.body.appendChild(pe);const To=Ui.domElement;To.addEventListener("mouseenter",s=>{const u=To.getBoundingClientRect();pe.style.left=u.right+"px",pe.style.top=u.top+"px",pe.style.display="block"}),To.addEventListener("mouseleave",()=>{pe.style.display="none"});let vn=0;window.addEventListener("scroll",()=>{bo=window.scrollY});let ue=[],ve={x:0,y:0},Ut={x:0,y:0},_n=0,at=0,We=!1,Gt=250,_e=[],wn=10,Be,He=!1,Ue=[];const M={enabled:!1,mobileDisabled:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||window.matchMedia&&window.matchMedia("(hover: none)").matches||"ontouchstart"in window||!n.mouseParticles,spawnRate:t==="high"?.52:t==="medium"?.35:0,maxParticles:t==="high"?150:t==="medium"?75:0,baseSize:1.9,fadeInSpeed:.62,fadeOutSpeed:.88,trailLength:5e-4,speedVariation:.2,jitterAmount:.08,spawnOffsetMin:.08,spawnOffsetMax:.8,minLifetime:1.5,maxLifetime:3.5,drawnLife:12};Be=M.spawnOffsetMin,window.enableMouseParticles=function(){M.mobileDisabled||(M.enabled=!0)};const Q=new co;Ot.track(Q,"geometry");const Wt=new no({uniforms:{baseSize:{value:M.baseSize},map:{value:So},brightness:{value:1.4},haloStrength:{value:1.4},haloSize:{value:1.3},aspectCompensation:{value:gn}},vertexShader:`
      attribute vec3 color;
      attribute float size;
      attribute float opacity;
      uniform float baseSize;
      uniform float haloSize;
      
      varying vec3 vColor;
      varying float vOpacity;
      varying float vSize;
      
      void main() {
        vColor = color;
        vOpacity = opacity;
        vSize = size;
        
        // Convert mouse coordinates to world coordinates
        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
        gl_Position = projectionMatrix * mvPosition;
        
        // Apply size with opacity influence for fading effect
        gl_PointSize = size * baseSize * haloSize;
      }
    `,fragmentShader:`
      uniform sampler2D map;
      uniform float brightness;
      uniform float haloStrength;
      uniform float aspectCompensation;
      
      varying vec3 vColor;
      varying float vOpacity;
      
      void main() {
        // Compensate for CSS scaleX stretch by adjusting UV coordinates
        vec2 compensatedUV = gl_PointCoord - 0.5;
        compensatedUV.x *= (1.0 / aspectCompensation);
        
        // Calculate distance using compensated coordinates
        float dist = length(compensatedUV) * 2.0;
        
        // Sample the texture with compensated UVs
        vec2 texUV = compensatedUV + 0.5;
        vec4 texColor = texture2D(map, texUV);
        
        // Discard pixels outside the circular area
        if (dist > 1.0) discard;
        
        // Apply color and brightness
        vec3 brightColor = vColor * brightness;
        
        // Create halo effect
        float haloFactor = max(0.0, 1.0 - dist);
        haloFactor = pow(haloFactor, 1.5);
        
        // Boost core brightness
        float coreBrightness = 1.0 + haloFactor * haloStrength;
        
        // Blend toward white for halo
        vec3 haloColor = mix(brightColor, vec3(1.0, 1.0, 1.0), haloFactor * 0.3);
        
        // Apply the halo effect
        vec3 finalColor = haloColor * coreBrightness;
        
        // Apply opacity and texture alpha
        float finalOpacity = texColor.a * vOpacity;
        gl_FragColor = vec4(finalColor, finalOpacity);
        
        // Discard transparent pixels
        if (gl_FragColor.a < 0.01) discard;
      }
    `,transparent:!0,blending:Un,depthWrite:!1,depthTest:!1}),Ao=new qo(Q,Wt);Se.add(Ao);function Eo(){const s=window.innerWidth,u=window._mobileShaderScale||1;if(s<640&&u>1){const _=1/u;Ao.scale.set(_,1,1),Wt.uniforms.aspectCompensation.value=_}else Ao.scale.set(1,1,1),Wt.uniforms.aspectCompensation.value=1}Eo();function bt(s,u){const p=s/window.innerWidth*2-1,_=-(u/window.innerHeight)*2+1,y=p*(N.right-N.left)/2/N.zoom,w=_*(N.top-N.bottom)/2/N.zoom;return{x:y,y:w}}function yn(s,u){return{id:_n++,position:{x:s,y:u,z:Math.random()*100-50},targetPosition:{x:s,y:u},velocity:{x:0,y:0},size:.8+Math.random()*.4,opacity:0,targetOpacity:1,life:0,maxLife:M.minLifetime+Math.random()*(M.maxLifetime-M.minLifetime),color:{r:.145,g:.898,b:1},trailSpeed:.05+Math.random()*.03,fadePhase:"in"}}function bn(s,u){return{id:_n++,position:{x:s,y:u,z:Math.random()*100-50},originalPosition:{x:s,y:u},targetPosition:{x:s,y:u},velocity:{x:0,y:0},size:.8+Math.random()*.4,opacity:0,baseOpacity:0,targetOpacity:1,life:0,maxLife:M.drawnLife,color:{r:1,g:.647,b:0},trailSpeed:0,fadePhase:"in",isDrawn:!0,twinklePhase:Math.random()*Math.PI*2,twinkleSpeed:.8+Math.random()*.4,twinkleRadius:2+Math.random()*3}}let Vt=0;function jt(){const s=[...ue,...Ue],u=s.length;if(u===0){if(Vt===0)return;Q.deleteAttribute("position"),Q.deleteAttribute("color"),Q.deleteAttribute("size"),Q.deleteAttribute("opacity"),Vt=0;return}const p=new Float32Array(u*3),_=new Float32Array(u*3),y=new Float32Array(u),w=new Float32Array(u);for(let P=0;P<u;P++){const I=s[P],R=P*3;p[R]=I.position.x,p[R+1]=I.position.y,p[R+2]=I.position.z,_[R]=I.color.r,_[R+1]=I.color.g,_[R+2]=I.color.b,y[P]=I.size,w[P]=I.opacity}u!==Vt?(Q.attributes.position&&(Q.deleteAttribute("position"),Q.deleteAttribute("color"),Q.deleteAttribute("size"),Q.deleteAttribute("opacity")),Q.setAttribute("position",new ge(p,3)),Q.setAttribute("color",new ge(_,3)),Q.setAttribute("size",new ge(y,1)),Q.setAttribute("opacity",new ge(w,1)),Vt=u):(Q.attributes.position.array.set(p),Q.attributes.color.array.set(_),Q.attributes.size.array.set(y),Q.attributes.opacity.array.set(w),Q.attributes.position.needsUpdate=!0,Q.attributes.color.needsUpdate=!0,Q.attributes.size.needsUpdate=!0,Q.attributes.opacity.needsUpdate=!0)}window.addEventListener("mousemove",s=>{if(!M.enabled||M.mobileDisabled)return;Ut.x=ve.x,Ut.y=ve.y,ve.x=s.clientX,ve.y=s.clientY;const u=ve.x-Ut.x,p=ve.y-Ut.y,_=Math.sqrt(u*u+p*p);if(We||(at+=_,at>=Gt&&(We=!0)),_e.push(_),_e.length>wn&&_e.shift(),_e.length>0){const y=_e.reduce((P,I)=>P+I,0)/_e.length,O=Math.min(y/20,1);Be=M.spawnOffsetMin+(M.spawnOffsetMax-M.spawnOffsetMin)*O}if(We&&_>1&&ue.length<M.maxParticles&&Math.random()<M.spawnRate){const y=bt(ve.x,ve.y),w=Be*50,O=Math.random()*Math.PI*2,P=Math.cos(O)*w*Math.random(),I=Math.sin(O)*w*Math.random(),R=yn(y.x+P,y.y+I);ue.push(R)}if(He&&ue.length<M.maxParticles&&Math.random()<.8){const y=bt(ve.x,ve.y),w=10,O=Math.random()*Math.PI*2,P=Math.cos(O)*w*Math.random(),I=Math.sin(O)*w*Math.random(),R=bn(y.x+P,y.y+I);Ue.push(R)}}),window.addEventListener("mousedown",s=>{!M.enabled||M.mobileDisabled||s.button===0&&(He=!0)}),window.addEventListener("mouseup",s=>{s.button===0&&(He=!1)});let lt={x:0,y:0},fe={x:0,y:0},Kt=!1;window.addEventListener("touchstart",s=>{if(!M.enabled||M.mobileDisabled)return;const u=s.target;u.tagName==="BUTTON"||u.tagName==="A"||u.closest("button")||u.closest("a")||u.closest("header")||u.closest("nav")||s.preventDefault();const _=s.touches[0];fe.x=_.clientX,fe.y=_.clientY,lt.x=fe.x,lt.y=fe.y,Kt=!0,He=!0},{passive:!1}),window.addEventListener("touchmove",s=>{if(!M.enabled||M.mobileDisabled||!Kt)return;const u=s.target;u.tagName==="BUTTON"||u.tagName==="A"||u.closest("button")||u.closest("a")||u.closest("header")||u.closest("nav")||s.preventDefault();const _=s.touches[0];lt.x=fe.x,lt.y=fe.y,fe.x=_.clientX,fe.y=_.clientY,ve.x=fe.x,ve.y=fe.y;const y=fe.x-lt.x,w=fe.y-lt.y,O=Math.sqrt(y*y+w*w);if(We||(at+=O,at>=Gt&&(We=!0)),_e.push(O),_e.length>wn&&_e.shift(),_e.length>0){const P=_e.reduce((Me,Ce)=>Me+Ce,0)/_e.length,R=Math.min(P/20,1);Be=M.spawnOffsetMin+(M.spawnOffsetMax-M.spawnOffsetMin)*R}if(We&&O>1&&ue.length<M.maxParticles&&Math.random()<M.spawnRate){const P=bt(fe.x,fe.y),I=Be*50,R=Math.random()*Math.PI*2,Me=Math.cos(R)*I*Math.random(),Ce=Math.sin(R)*I*Math.random(),we=yn(P.x+Me,P.y+Ce);ue.push(we)}if(He&&ue.length<M.maxParticles&&Math.random()<.8){const P=bt(fe.x,fe.y),I=10,R=Math.random()*Math.PI*2,Me=Math.cos(R)*I*Math.random(),Ce=Math.sin(R)*I*Math.random(),we=bn(P.x+Me,P.y+Ce);Ue.push(we)}},{passive:!1}),window.addEventListener("touchend",s=>{Kt=!1,He=!1}),window.addEventListener("touchcancel",s=>{Kt=!1,He=!1});function Gi(){if(ue.length===0&&Ue.length===0||M.mobileDisabled)return;const s=bt(ve.x,ve.y);for(let u=ue.length-1;u>=0;u--){const p=ue[u];if(p.life+=.016,!p.isDrawn){p.targetPosition.x=s.x,p.targetPosition.y=s.y;const y=p.trailSpeed*M.trailLength;p.position.x+=(p.targetPosition.x-p.position.x)*y,p.position.y+=(p.targetPosition.y-p.position.y)*y,p.position.x+=(Math.random()-.5)*2*M.jitterAmount,p.position.y+=(Math.random()-.5)*2*M.jitterAmount}const _=p.life/p.maxLife;if(_<.15){p.fadePhase="in";const y=_/.15,w=1-Math.pow(1-y,2);p.opacity=w*M.fadeInSpeed}else if(_<.65)p.fadePhase="hold",p.opacity=M.fadeInSpeed;else{p.fadePhase="out";const y=(_-.65)/.35,w=Math.pow(1-y,2);p.opacity=w*M.fadeInSpeed*M.fadeOutSpeed}(p.life>=p.maxLife||p.opacity<=0)&&ue.splice(u,1)}for(let u=Ue.length-1;u>=0;u--){const p=Ue[u];p.life+=.016,p.twinklePhase+=.016*p.twinkleSpeed;const _=Math.sin(p.twinklePhase)*p.twinkleRadius*.4,y=Math.cos(p.twinklePhase*1.05)*p.twinkleRadius*.4;p.position.x=p.originalPosition.x+_,p.position.y=p.originalPosition.y+y;const w=p.life/p.maxLife;if(w<.15){p.fadePhase="in";const P=w/.15,I=1-Math.pow(1-P,2);p.baseOpacity=I*M.fadeInSpeed}else if(w<.85)p.fadePhase="hold",p.baseOpacity=M.fadeInSpeed;else{p.fadePhase="out";const P=(w-.85)/.15,I=Math.pow(1-P,2);p.baseOpacity=I*M.fadeInSpeed*M.fadeOutSpeed}const O=.7+.3*Math.sin(p.twinklePhase*2);p.opacity=p.baseOpacity*O,(p.life>=p.maxLife||p.opacity<=0)&&Ue.splice(u,1)}jt(),Cn.currentOffset=Be}const ae=A.addFolder("Mouse Follow Particles");ae.add({mobileDetected:M.mobileDisabled},"mobileDetected").name("Mobile Detected (Disabled)").listen(),ae.add(M,"enabled").name("Enable Mouse Particles").onChange(s=>{s||(ue=[],Ue=[],jt(),We=!1,at=0,_e=[],Be=M.spawnOffsetMin,He=!1)}),ae.add(M,"spawnRate",.1,1,.1).name("Spawn Rate").onChange(s=>{M.spawnRate=s}),ae.add(M,"maxParticles",10,50,1).name("Max Particles").onChange(s=>{for(M.maxParticles=s;ue.length>s;)ue.pop();jt()}),ae.add(M,"baseSize",2,10,.5).name("Particle Size").onChange(s=>{Wt.uniforms.baseSize.value=s}),ae.add(M,"trailLength",.1,1,.1).name("Trail Length").onChange(s=>{M.trailLength=s}),ae.add(M,"speedVariation",0,1,.1).name("Speed Variation").onChange(s=>{M.speedVariation=s}),ae.add(M,"jitterAmount",0,1,.05).name("Jitter Amount").onChange(s=>{M.jitterAmount=s}),ae.add(M,"spawnOffsetMin",0,1,.05).name("Spawn Offset Min").onChange(s=>{M.spawnOffsetMin=s}),ae.add(M,"spawnOffsetMax",0,1,.05).name("Spawn Offset Max").onChange(s=>{M.spawnOffsetMax=s});const Cn={currentOffset:Be};ae.add(Cn,"currentOffset",0,1).name("Current Offset (Dynamic)").listen(),ae.add(M,"fadeInSpeed",.1,1,.01).name("Max Opacity").onChange(s=>{M.fadeInSpeed=s}),ae.add(M,"fadeOutSpeed",.1,1,.01).name("Fade Strength").onChange(s=>{M.fadeOutSpeed=s}),ae.add(M,"drawnLife",1,10,.1).name("Drawn Particle Life").onChange(s=>{M.drawnLife=s}),ae.add({movementThreshold:Gt},"movementThreshold",100,400,10).name("Initial Movement Needed").onChange(s=>{Gt=s}),ae.add({resetActivation:function(){We=!1,at=0,_e=[],Be=M.spawnOffsetMin,ue=[],Ue=[],He=!1,jt()}},"resetActivation").name("Reset Activation"),ae.close();function Wi(){const s=K.attributes.position.array,u=k.previousOffset||0,p=k.verticalOffset-u;k.previousOffset=k.verticalOffset;for(let _=0;_<ee;_++){const y=_*3;s[y+1]+=p;const w=s[y+1]-k.verticalOffset,O=Te/2;w>O?s[y+1]=-O+k.verticalOffset:w<-O&&(s[y+1]=O+k.verticalOffset)}K.attributes.position.needsUpdate=!0}const Xt=new X,ct=le.isMobile();let Mo=!1;const Sn=ct?30:60,Vi=ct?20:30;let Oo=1e3/Sn,xn=0,ko=0;const ji=ct?3:1;le.onScrollStateChange(({isScrolling:s})=>{Mo=s,Oo=1e3/(s&&ct?Vi:Sn)});function Tn(){requestAnimationFrame(Tn);const s=performance.now(),u=s-xn;if(u<Oo||document.hidden||window.backgroundPaused)return;xn=s-u%Oo;const p=K.attributes.position.array,_=K.attributes.color.array,y=K.attributes.size?K.attributes.size.array:null;vn+=.01;const w=(bo-Co)*k.scrollSpeed;Co=bo*(1-k.damping)+Co*k.damping;const O=ct&&Mo&&n.skipParticleUpdatesOnScroll;if(!window.particlesMovementPaused){for(let I=0;I<ee;I++){const R=I*3,Me=y?(y[I]-k.sizeMin)/(k.sizeMax-k.sizeMin):.5;if(!O){const St=k.floatSpeed*(.5+Me*.5);p[R]+=xe[R]*St,p[R+1]+=xe[R+1]*St,p[R+2]+=xe[R+2]*St}p[R+1]+=w*(.5+Me*.5),Math.abs(p[R])>Re/2&&(xe[R]*=-1);const Ce=p[R+1]-k.verticalOffset,we=Te/2;Ce>we?p[R+1]=-we+k.verticalOffset:Ce<-we&&(p[R+1]=we+k.verticalOffset),Math.abs(p[R+2])>250&&(xe[R+2]*=-1)}K.attributes.position.needsUpdate=!0}if(ko++,!Mo||!ct||ko>=ji){ko=0,Xt.set(Ht.color);for(let I=0;I<ee;I++){const R=I*3,Me=y?(y[I]-k.sizeMin)/(k.sizeMax-k.sizeMin):.5,Ce=.2*Math.sin(vn+I*.1)+.9,we=.8+Me*.6;_[R]=Xt.r*Ce*we,_[R+1]=Xt.g*Ce*we,_[R+2]=Xt.b*Ce*we}K.attributes.color.needsUpdate=!0}}Tn();const dt=le.isMobile();let ut=!1;dt&&le.onScrollStateChange(({isScrolling:s})=>{ut=s});function Ki(s){if(window.backgroundPaused)return;const u=dt?ut?5e-5:5e-4:.001;if(f.time.value+=u,r()&&Date.now()-o>i){const w=f.time.value+f.colorCycleOffset.value;f.colorCycleOffset.value=w,f.time.value=0,o=Date.now()}dt&&ut||Gi(),dt&&ut||(!window.particlesFullyHidden&&V.uniforms.opacity.value<he&&(V.uniforms.opacity.value+=.001,V.uniforms.opacity.value>he&&(V.uniforms.opacity.value=he)),window.particlesFullyHidden&&V.uniforms.opacity.value>0&&(V.uniforms.opacity.value=0));const _=dt&&ut;if(E&&H.autoRotate&&!H.rotationPaused&&!_){const y=H.baseRotateSpeed;E.rotation.y+=y*.01}G&&!(dt&&ut)&&(G.rotation.set(0,0,0),vt()),Y.autoClear=!0,Y.render(de,N),(!window.particlesFullyHidden||ue.length>0&&M.enabled)&&(Y.autoClear=!1,Y.render(Se,N))}const $t=new Ir;window.shaderBackgroundPerfMonitor=$t,new URLSearchParams(window.location.search).has("debugPerf")&&($t.createDebugOverlay(),D.log("[Background Init] Full performance monitoring enabled")),$t.setWarningCallback(s=>{D.warn("[Performance Warning]",s)});const qt=new Dr(s=>{Ki(),$t.update(Y)},n.targetFPS);qt.start(),window.shaderBackgroundRenderer=qt,Object.defineProperty(window,"backgroundPaused",{get(){return this._backgroundPaused||!1},set(s){this._backgroundPaused=s,qt&&qt.setPausedByTimeline(s)}}),window.addEventListener("timeline:backgroundPaused",s=>{f&&f.filmGrainEnabled&&(f.filmGrainEnabled.value=!s.detail.paused)}),document.addEventListener("veryEarlyParticleFade",()=>{he=.3,V&&V.uniforms&&V.uniforms.opacity&&V.uniforms.opacity.value<.1&&(V.uniforms.opacity.value=.05)}),document.addEventListener("particleFadeStart",()=>{he=.3}),document.addEventListener("heroAnimationComplete",()=>{he=.5});function Yt(){if(G){const s=window.innerHeight,u=N.right-N.left,_=(N.top-N.bottom)/s,y=u,w=s*.66*_;G.geometry.dispose(),G.geometry=new et(y,w),G.rotation.set(0,0,0),vt()}}let Jt,Le;const Po=1.5;function Ct(){const s=window.innerWidth,u=x();l.style.width=`${s}px`,l.style.height=`${u}px`;const p=s<640,_=window._mobileShaderScale&&window._mobileShaderScale>1,y=window._isSafariBrowser;if(p&&!_&&!y?(l.style.transform=`translateZ(0) scaleX(${Po})`,l.style.transformOrigin="center center",window._mobileShaderScale=Po,D.log(`[Background Resize] Mobile shader widening enabled: ${Po}x width`),mo(),xo(),Eo()):!p&&_&&(l.style.transform="translateZ(0)",window._mobileShaderScale=1,D.log("[Background Resize] Mobile shader widening disabled"),mo(),xo(),Eo()),Y.setSize(s,u),N.left=-s/2,N.right=s/2,N.top=u/2,N.bottom=-u/2,N.updateProjectionMatrix(),f.resolution.value.set(s,u),_t.geometry.dispose(),_t.geometry=new et(s,u,s/10,u/10),Te=u*k.verticalSpread,Re=s*k.horizontalSpread,typeof A<"u"&&A&&A.__folders["Particle System"]){const w=A.__folders["Particle System"];if(w&&w.__controllers){for(let O=0;O<w.__controllers.length;O++)if(w.__controllers[O].property==="verticalOffset"){w.__controllers[O].min(-u*3),w.__controllers[O].max(u*2);break}}}if(E&&H.responsive){clearTimeout(Le),Le=setTimeout(()=>{Ge()},150);for(let w=0;w<Ee.__controllers.length;w++){const O=Ee.__controllers[w];O.property==="positionX"?(O.min(-s/2),O.max(s/2)):O.property==="positionY"&&(O.min(-u/2),O.max(u/2))}}Yt()}window.addEventListener("resize",()=>{clearTimeout(Jt),clearTimeout(Le),E&&H.responsive&&(Le=setTimeout(()=>{Ge()},150)),Jt=setTimeout(Ct,150)}),window.addEventListener("orientationchange",()=>{clearTimeout(Jt),clearTimeout(Le),E&&H.responsive&&(Le=setTimeout(()=>{Ge()},300)),Jt=setTimeout(Ct,300)}),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){clearTimeout(Le);const s=window.innerWidth,u=x();window.lastKnownDimensions||(window.lastKnownDimensions={width:s,height:u});const p=Math.abs(s-window.lastKnownDimensions.width)/window.lastKnownDimensions.width,_=Math.abs(u-window.lastKnownDimensions.height)/window.lastKnownDimensions.height;(p>.05||_>.05)&&(window.lastKnownDimensions.width=s,window.lastKnownDimensions.height=u,E&&H.responsive&&(Le=setTimeout(()=>{Ge()},150)),setTimeout(Ct,100))}else window.lastKnownDimensions={width:window.innerWidth,height:x()}});let An=x();function En(){const s=x();Math.abs(s-An)>50&&(Ct(),An=s),requestAnimationFrame(En)}En(),window.addEventListener("keydown",s=>{if((s.key==="+"||s.key==="=")&&(ye.zoom=Math.min(ye.zoom+.1,5),N.zoom=ye.zoom,N.updateProjectionMatrix(),typeof A<"u"&&A&&A.__folders["Camera Controls"])){const u=A.__folders["Camera Controls"];if(u&&u.__controllers){for(let p=0;p<u.__controllers.length;p++)if(u.__controllers[p].property==="zoom"){u.__controllers[p].updateDisplay();break}}}if((s.key==="-"||s.key==="_")&&(ye.zoom=Math.max(ye.zoom-.1,.1),N.zoom=ye.zoom,N.updateProjectionMatrix(),typeof A<"u"&&A&&A.__folders["Camera Controls"])){const u=A.__folders["Camera Controls"];if(u&&u.__controllers){for(let p=0;p<u.__controllers.length;p++)if(u.__controllers[p].property==="zoom"){u.__controllers[p].updateDisplay();break}}}}),re.add(k,"scrollSpeed",.001,.05,.018).name("Scroll Sensitivity").step(.001).onChange(s=>{k.scrollSpeed=s}),re.add(k,"damping",.8,.99,.01).name("Scroll Damping").onChange(s=>{k.damping=s}),re.add(k,"verticalSpread",1,5,.5).name("Vertical Spread").onChange(s=>{const u=Te;Te=window.innerHeight*s;const p=Te/u,_=K.attributes.position.array;for(let y=0;y<ee;y++){const w=y*3,P=(_[w+1]-k.verticalOffset)*p;_[w+1]=P+k.verticalOffset,Math.abs(P)>Te/2&&(_[w+1]=(Math.random()-.5)*Te+k.verticalOffset)}K.attributes.position.needsUpdate=!0}),re.add(k,"horizontalSpread",.02,5,.01).name("Horizontal Spread").onChange(s=>{const u=Re;Re=window.innerWidth*s;const p=Re/u,_=K.attributes.position.array;for(let y=0;y<ee;y++){const w=y*3,P=_[w]*p;_[w]=P,Math.abs(P)>Re/2&&(_[w]=(Math.random()-.5)*Re)}K.attributes.position.needsUpdate=!0}),re.add(k,"verticalOffset",-window.innerHeight*3,window.innerHeight*2,10).name("Vertical Position").onChange(s=>{k.previousOffset===void 0&&(k.previousOffset=0),k.verticalOffset=s,Wi()}),re.add(k,"sizeMin",1,5,.01).name("Min Particle Size").onChange(s=>{if(k.sizeMin=s,k.sizeMin>=k.sizeMax&&(k.sizeMax=k.sizeMin+1,typeof A<"u"&&A&&A.__folders["Particle System"])){const u=A.__folders["Particle System"];if(u&&u.__controllers){for(let p=0;p<u.__controllers.length;p++)if(u.__controllers[p].property==="sizeMax"){u.__controllers[p].updateDisplay();break}}}rt()}),re.add(k,"sizeMax",5,10,.01).name("Max Particle Size").onChange(s=>{if(k.sizeMax=s,k.sizeMax<=k.sizeMin&&(k.sizeMin=k.sizeMax-1,typeof A<"u"&&A&&A.__folders["Particle System"])){const u=A.__folders["Particle System"];if(u&&u.__controllers){for(let p=0;p<u.__controllers.length;p++)if(u.__controllers[p].property==="sizeMin"){u.__controllers[p].updateDisplay();break}}}rt()}),re.add(k,"floatSpeed",.1,3,.1).name("Float Speed").onChange(s=>{k.floatSpeed=s}),rt();const Xi=K.attributes.position.array;for(let s=0;s<ee;s++){const u=s*3;Xi[u+1]=(Math.random()-.5)*Te+k.verticalOffset}K.attributes.position.needsUpdate=!0,re.add(V.uniforms.haloStrength,"value",0,2,.1).name("Halo Intensity").onChange(s=>{V.uniforms.haloStrength.value=s}),re.add(V.uniforms.haloSize,"value",1,2,.1).name("Halo Size").onChange(s=>{V.uniforms.haloSize.value=s});let Ro;window.addEventListener("scroll",()=>{Ro&&clearTimeout(Ro),Ro=setTimeout(()=>{},150)})}function Go(){const a=window.gui,e=window.uniforms;if(typeof a>"u"||!a||!a.__folders||!a.__folders["Lighting Controls"])return;const t=a.__folders["Lighting Controls"];for(let n=0;n<t.__controllers.length;n++){const o=t.__controllers[n];o.property==="value"&&o.object===e.ambientLight&&o.setValue(e.ambientLight.value),o.property==="value"&&o.object===e.directionalLight&&o.setValue(e.directionalLight.value)}}function Wo(){const a=window.gui,e=window.uniforms;if(a.__folders["Animation Speed Controls"]){const t=a.__folders["Animation Speed Controls"];for(let n=0;n<t.__controllers.length;n++){const o=t.__controllers[n];if(o.property==="value"&&o.object===e.waveSpeed){o.setValue(e.waveSpeed.value);break}}}if(a.__folders["Wave Controls"]){const t=a.__folders["Wave Controls"];for(let n=0;n<t.__controllers.length;n++){const o=t.__controllers[n];o.property==="value"&&o.object===e.waveAmplitude&&o.setValue(e.waveAmplitude.value),o.property==="value"&&o.object===e.waveFrequency&&o.setValue(e.waveFrequency.value)}}}export{Br as initShaderBackground};
