import{g as H}from"./index-Bvtry3m3.js";import{l as t}from"./logger-2Ii2FPkr.js";const z=document.querySelector('script[src*="/content/dam/acsorg/150/"]')!==null,F=window.location.hostname.includes("github.io")||window.location.pathname.startsWith("/150-lab/"),D=z?"/content/dam/acsorg/150/assets":F?"/150-lab/assets":"",$=`${D}/audio/ui-click.mp3`,W=`${D}/audio/chemistry-3-final.mp3`;let o=null,u=!1,n=!1,V=!1,B=!1,S=!1,p=!1,v=0;const w=25;let g=null,A=!1,b=null,U=0;const G=50;let P=null,Y=null;const _=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);function J(){if(!Y)try{const e=window.AudioContext||window.webkitAudioContext;e&&(Y=new e,t.log("[audio.js] Created shared AudioContext"))}catch(e){t.warn("[audio.js] Could not create AudioContext:",e)}return Y}async function L(){const e=J();if(e&&e.state==="suspended")try{await e.resume(),t.log("[audio.js] AudioContext resumed, state:",e.state)}catch(i){t.warn("[audio.js] Could not resume AudioContext:",i)}return e}function O(){b||(b=new Audio($),b.volume=.35,b.preload="auto")}function I(){P&&(cancelAnimationFrame(P),P=null)}function h(e,i=1e3,d=null){if(!o)return;I();const c=o.volume,a=performance.now(),s=r=>{const k=r-a,y=Math.min(k/i,1),f=y*y;o.volume=c+(e-c)*f,y<1?P=requestAnimationFrame(s):(P=null,d&&d())};P=requestAnimationFrame(s)}const m=()=>{if(n)return;const e=Date.now();if(!(e-U<G)){U=e;try{b||O();const i=b.cloneNode();i.volume=.35,i.play().catch(d=>{t.warn("UI click sound play was prevented:",d)})}catch(i){t.error("Error playing UI click sound:",i)}}};async function x(){if(t.log("[audio.js] resumeBackgroundAudio called"),!o||n){t.log("[audio.js] Cannot resume: instance missing or muted");return}I(),await L(),o.volume<.01&&(o.volume=.001),_&&o.paused&&o.currentTime>0&&t.log("[audio.js] Safari: Audio was paused, ensuring good state");try{await o.play(),t.log("[audio.js] Audio play confirmed, fading in to 0.22"),h(.22,1e3)}catch(e){t.warn("[audio.js] Audio play blocked:",e);const i=async()=>{if(t.log("[audio.js] User interacted, retrying audio resume"),o&&!n)try{await L(),await o.play(),h(.22,1e3)}catch(d){t.error("[audio.js] Retry failed:",d)}document.removeEventListener("click",i),document.removeEventListener("touchend",i)};document.addEventListener("click",i,{once:!0}),document.addEventListener("touchend",i,{once:!0,passive:!0})}}window.playUIClickSound=m;window.cancelActiveFade=I;window.fadeBackgroundAudio=h;window.resumeBackgroundAudio=x;function q(e){n&&(e.volume=0,e.muted=!0),e.addEventListener("play",()=>{const i=document.querySelector(".sound-toggle");i&&i.classList.contains("muted")&&(e.volume=0,e.muted=!0)})}function K(){return window.YT&&window.YT.Player?Promise.resolve():new Promise(e=>{if(window.onYouTubeIframeAPIReady){const c=window.onYouTubeIframeAPIReady;window.onYouTubeIframeAPIReady=()=>{c(),e()};return}window.onYouTubeIframeAPIReady=()=>{e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api";const d=document.getElementsByTagName("script")[0];d.parentNode.insertBefore(i,d)})}function N(e){if(e.dataset.clickHandlerAdded)return;e.dataset.clickHandlerAdded="true",e.id||(e.id="youtube-iframe-"+Date.now()+"-"+Math.random().toString(36).substr(2,9));const i=e.src;if(i&&(i.includes("youtube.com")||i.includes("youtu.be"))&&!i.includes("enablejsapi=1")){const y=i.includes("?")?"&":"?",f=i+y+"enablejsapi=1";t.log("[audio.js] Adding enablejsapi to iframe:",e.id,"- will need to wait for reload"),e.src=f}const d=e.parentElement;if(d?d.querySelector(".video-start-overlay"):null){t.log("[audio.js] Custom video overlay detected, skipping Player creation for:",e.id,"(video.js will manage this)");return}if(e.hasAttribute("data-player-managed")||window.mainYouTubePlayerManaged){t.log("[audio.js] Player already managed by video.js, skipping for:",e.id);return}if(e.id==="youtube-video-iframe"){t.log("[audio.js] Main YouTube video detected, skipping Player creation (video.js manages this)");return}let a=null,s=!1;K().then(()=>{setTimeout(()=>{if(e.hasAttribute("data-player-managed")||e.hasAttribute("data-yt-player-initialized")||window.mainYouTubePlayerManaged||e.id==="youtube-video-iframe"){t.log("[audio.js] Player was initialized by video.js during delay, skipping for:",e.id);return}try{t.log("[audio.js] Setting up YouTube Player API for iframe:",e.id),a=new window.YT.Player(e.id,{events:{onReady:f=>{t.log("[audio.js] YouTube Player ready for iframe:",e.id),s=!0},onStateChange:f=>{t.log("YouTube Player state changed:",f.data,"for iframe:",e.id),f.data===1?(t.log("Video playing, pausing background audio"),I(),o&&h(.001,1e3,()=>{t.log("Background audio ducked (vol 0.001)")})):(f.data===0||f.data===2)&&(t.log("[audio.js] Video paused/ended, calling resumeBackgroundAudio"),x())}}});const y=e.closest(".preview-video-wrapper")||e.parentElement;y&&(new IntersectionObserver(l=>{l.forEach(E=>{if(!E.isIntersecting){t.log("[audio.js] Video",e.id,"scrolled out of view, attempting to pause");let T=!1;try{s&&a&&typeof a.getPlayerState=="function"&&a.getPlayerState()===1&&(T=!0,a.pauseVideo(),t.log("[audio.js] Video paused successfully"))}catch(M){t.warn("[audio.js] Could not pause video:",M)}(k||T)&&(t.log("[audio.js] Video left viewport after being played, resuming background audio as fallback"),setTimeout(()=>{!(window.isMainVideoPlaying?window.isMainVideoPlaying():!1)&&!n&&x()},300))}})},{threshold:.25}).observe(y),t.log("[audio.js] IntersectionObserver set up for iframe:",e.id))}catch(y){t.error("Could not initialize YouTube Player API for iframe:",e.id,y),s=!1}},200)}).catch(y=>{t.error("Could not load YouTube API:",y)});const r=document.createElement("div");r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.zIndex="10",r.style.cursor="pointer",r.style.pointerEvents="auto",r.style.backgroundColor="transparent",d&&getComputedStyle(d).position==="static"&&(d.style.position="relative"),d&&d.insertBefore(r,e);let k=!1;r.addEventListener("click",y=>{y.stopPropagation(),n||m(),r.style.pointerEvents="none",k=!0,setTimeout(()=>{I(),o&&!o.paused&&h(.001,1e3,()=>{t.log("[audio.js] Background audio ducked (vol 0.001) via overlay click")})},100),t.log("[audio.js] Overlay clicked for iframe:",e.id,"| Player ready:",s,"| Player exists:",!!a),(()=>{if(s&&a&&typeof a.playVideo=="function"){t.log("[audio.js] Using ready Player API to play video");try{a.playVideo();return}catch(l){t.warn("[audio.js] Player API failed, trying fallback:",l)}}t.log("[audio.js] Using postMessage API as primary method");try{e.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}',"*")}catch(l){t.warn("[audio.js] postMessage failed:",l)}if(a&&typeof a.playVideo=="function"){t.log("[audio.js] Attempting Player API as backup");try{a.playVideo()}catch(l){t.warn("[audio.js] Backup Player API call failed:",l)}}if(!a&&window.YT&&window.YT.Player){t.log("[audio.js] Player instance missing, creating new Player");try{a=new window.YT.Player(e.id,{events:{onReady:l=>{t.log("[audio.js] New player ready, playing immediately"),s=!0,l.target.playVideo()},onStateChange:l=>{l.data===1?(I(),o&&!o.paused&&h(.001,1e3,()=>{t.log("Background audio ducked (vol 0.001)")})):(l.data===0||l.data===2)&&x()}}})}catch(l){t.error("[audio.js] Failed to create new player:",l)}}if(!s){t.log("[audio.js] Player not ready, setting up retry mechanism");let l=0;const E=setInterval(()=>{if(l++,s&&a&&typeof a.playVideo=="function"){clearInterval(E),t.log("[audio.js] Player became ready after",l*100,"ms, playing video");try{a.playVideo()}catch(T){t.warn("[audio.js] Delayed play attempt failed:",T)}}l>30&&(clearInterval(E),t.warn("[audio.js] Player never became ready after 3 seconds"))},100)}})()})}function R(e){e.dataset.clickSoundHandlerAdded||(e.dataset.clickSoundHandlerAdded="true",e.addEventListener("click",i=>{e.paused&&(n||m())}),e.addEventListener("play",()=>{o&&!o.paused&&o.pause()}),e.addEventListener("pause",()=>{o&&u&&!n&&e.ended&&o.play().catch(i=>{t.warn("Could not resume background audio:",i)})}),e.addEventListener("ended",()=>{o&&u&&!n&&o.play().catch(i=>{t.warn("Could not resume background audio:",i)})}))}function Q(){new MutationObserver(a=>{a.forEach(s=>{s.type==="childList"&&s.addedNodes.forEach(r=>{r.nodeName==="AUDIO"||r.nodeName==="VIDEO"?(q(r),r.nodeName==="VIDEO"&&R(r)):r.querySelectorAll&&(r.querySelectorAll("audio, video").forEach(f=>{q(f),f.nodeName==="VIDEO"&&R(f)}),r.querySelectorAll('iframe[src*="youtube.com"], iframe[src*="youtu.be"]').forEach(f=>{N(f)}))})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll('iframe[src*="youtube.com"], iframe[src*="youtu.be"]').forEach(a=>{N(a)}),document.querySelectorAll("video").forEach(a=>{R(a)});let c;window.addEventListener("scroll",()=>{c&&clearTimeout(c),c=setTimeout(()=>{const a=window.isMainVideoPlaying?window.isMainVideoPlaying():!1,s=window.isSecondVideoPlaying?window.isSecondVideoPlaying():!1;!a&&!s&&o&&!o.paused&&o.volume<.05&&!n&&(t.log("[audio.js] Scroll fallback: No videos playing, resuming ducked audio"),h(.22,1e3))},200)})}function j(e=!1){if(!(u||n)){if(v++,window.audioRetryCount=v,window.maxAudioRetries=w,v>=w){t.warn(`Exceeded maximum audio retry attempts (${w}). Stopping retries.`);return}try{o.volume=.22,e&&L().catch(i=>{t.warn("Could not resume audio context:",i)}),o.play().then(()=>{u=!0,window.audioInitialized=!0;const i=document.querySelector(".sound-toggle");i&&i.classList.add("active"),v=0,window.audioRetryCount=0}).catch(i=>{t.error("Audio play was prevented:",i),u=!1,(e||p)&&v<w&&setTimeout(()=>{!u&&!n&&j(!0)},500)})}catch(i){t.error("Error playing audio:",i),u=!1,(e||p)&&v<w&&setTimeout(()=>{!u&&!n&&j(!0)},500)}}}const X=()=>{document.hidden?o&&!o.paused&&u&&(A=!0,o.pause()):o&&A&&u&&!n&&(A=!1,o.play().catch(e=>{t.warn("Could not resume background audio:",e),u=!1,p&&setTimeout(()=>{C(!0)},100)}))};function Z(){document.addEventListener("visibilitychange",X),window.addEventListener("blur",()=>{o&&!o.paused&&u&&(A=!0,o.pause())}),window.addEventListener("focus",()=>{o&&A&&u&&!n&&(A=!1,o.play().catch(e=>{t.warn("Could not resume background audio on focus:",e),u=!1,p&&setTimeout(()=>{C(!0)},100)}))})}const C=(e=!1)=>{if(!n&&(e&&(p=!0,window.enterButtonClicked=!0),!!p&&!u)){if(v>=w){t.warn(`Exceeded maximum audio retry attempts (${w}). Stopping retries.`),g&&(clearInterval(g),g=null);return}if(e){setTimeout(()=>{if(!n)if(S||o&&o.readyState>=3)j(!0);else try{o.load()}catch(i){t.warn("Error reloading background audio:",i)}},2e3);return}if(S||o&&o.readyState>=3)j(e);else if(e)try{o.load()}catch(i){t.warn("Error reloading background audio:",i)}}};function oe(){const e=new Audio;e.addEventListener("canplaythrough",()=>{S=!0,p&&!u&&!n&&j(!0)}),e.addEventListener("error",i=>{t.error("Audio loading error:",i),t.error("Audio src:",e.src),(window.location.hostname==="localhost"||window.location.hostname.includes("127.0.0.1"))&&t.warn("Audio failed to load in dev mode. Ensure audio files are in 150-lab/public/audio/ directory.")}),e.loop=!0,e.volume=0,e.preload="auto",e.src=W;try{e.load()}catch(i){t.error("Error loading background audio:",i)}o=e,window.backgroundAudioInstance=e,window.backgroundAudio=e,u=!1,n=!1,V=!1,B=!1,S=!1,p=!1,v=0,window.audioInitialized=!1,window.audioMuted=!1,window.userInteracted=!1,window.heroAnimationComplete=!1,window.enterButtonClicked=!1,window.audioRetryCount=0,window.maxAudioRetries=w,window.audioRetryTimer=null,Z()}const ie=()=>{O(),document.querySelectorAll('a, button, input[type="button"], input[type="submit"], input[type="reset"], input[type="checkbox"], input[type="radio"], .marker, .minor-node').forEach(d=>{d.addEventListener("click",c=>{if(d.classList.contains("enter-experience")){d.dataset.clickSoundPlayed||(n||m(),d.dataset.clickSoundPlayed="true");return}n||m()})}),new MutationObserver(d=>{d.forEach(c=>{c.type==="childList"&&c.addedNodes.forEach(a=>{a.nodeType===1&&(a.matches('a, button, input[type="button"], input[type="submit"], input[type="reset"], input[type="checkbox"], input[type="radio"], .marker, .minor-node')&&a.addEventListener("click",r=>{if(a.classList.contains("enter-experience")){a.dataset.clickSoundPlayed||(n||m(),a.dataset.clickSoundPlayed="true");return}n||m()}),a.querySelectorAll('a, button, input[type="button"], input[type="submit"], input[type="reset"], input[type="checkbox"], input[type="radio"], .marker, .minor-node').forEach(r=>{r.addEventListener("click",k=>{if(r.classList.contains("enter-experience")){r.dataset.clickSoundPlayed||(n||m(),r.dataset.clickSoundPlayed="true");return}n||m()})}))})})}).observe(document.body,{childList:!0,subtree:!0}),Q()},ae=e=>{V=!0,p&&!u&&B&&!n&&C(!0)};function ne(){const e=document.querySelector(".sound-toggle");if(e){const i=document.getElementById("waveGroup");i&&(window.waveAnimation=H.to(i,{x:"-=100",ease:"linear",duration:2,repeat:-1})),e.addEventListener("click",()=>{const d=n;if(e.classList.toggle("muted"),n=e.classList.contains("muted"),window.audioMuted=n,d)try{b||O();const a=b.cloneNode();a.volume=.38,a.play().catch(s=>{t.warn("UI click sound play was prevented:",s)})}catch(a){t.error("Error playing UI click sound:",a)}else m();const c=window.waveAnimation;if(n)c&&c.pause(),o&&(o.volume=0,g&&(clearInterval(g),g=null));else{c&&c.resume();const a=document.getElementById("anniversary-video");a&&!a.paused&&!a.ended||(!u&&p&&o?(C(!0),g||(g=setInterval(()=>{u?(clearInterval(g),g=null):!n&&p&&(v<w?C(!0):(t.warn(`Exceeded maximum audio retry attempts (${w}). Stopping retries.`),clearInterval(g),g=null))},500))):u&&o&&(L().then(()=>{t.log("[audio.js] AudioContext resumed on unmute")}).catch(r=>{t.warn("[audio.js] Error resuming AudioContext on unmute:",r)}),o.volume=.22,t.log("[audio.js] Unmuting - attempting to play audio"),(async()=>{try{await o.play(),t.log("[audio.js] Audio resumed successfully on unmute")}catch(r){t.warn("Audio play was prevented on unmute:",r),u=!1,p&&C(!0)}})()))}})}}const re=()=>({audioInitialized:u,audioMuted:n,userInteracted:V,heroAnimationComplete:B,backgroundAudioLoaded:S,enterButtonClicked:p,backgroundAudioInstance:o});function de(e){B=e,window.heroAnimationComplete=e}function ue(e){p=e,window.enterButtonClicked=e}function se(e){V=e,window.userInteracted=e}function le(){n=!n;const e=document.querySelector(".sound-toggle");e&&(n?e.classList.add("muted"):e.classList.remove("muted")),o&&(o.volume=n?0:.22)}export{ae as enableAudioOnInteraction,re as getAudioState,q as handleNewAudioElement,C as playBackgroundAudio,oe as preloadBackgroundAudio,ue as setEnterButtonClicked,de as setHeroAnimationComplete,se as setUserInteracted,ne as setupSoundToggle,ie as setupUIClickSounds,le as toggleMute};
