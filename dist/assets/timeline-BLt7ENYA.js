import{g as r,S as Z}from"./index-_NEl4d3Y.js";import Bt from"./index-BbrXr4yz.js";import{ac as Ie,af as ft,W as ht,ad as yt,ah as vt,C as $e,al as _t,E as qt,am as bt,K as Ot,z as $t,an as Nt,aj as Wt,ae as Oe}from"./mobileFilmGrain-CmB6Tq7x.js";import{l as o}from"./logger-2Ii2FPkr.js";function Yt(){const d=document.querySelector("#timeline-cover-canvas");if(!d){o.warn("Cover orb canvas not found");return}if(window.coverOrbInitialized)return o.warn("Cover orb already initialized, skipping duplicate call"),window.coverOrbControls;window.coverOrbInitialized=!0;const g=Ie.isMobile(),f=new ft,e=new ht(45,d.clientWidth/d.clientHeight,.1,100);e.position.z=3.5;const i=new yt({canvas:d,alpha:!0,antialias:!g,powerPreference:g?"low-power":"default"});i.setSize(d.clientWidth,d.clientHeight),i.setPixelRatio(Math.min(window.devicePixelRatio,g?1.25:2));const l={noiseStrength:.13,noiseSpeed:.11,noiseDensity:.73,colorDeep:"#9b7bff",colorLight:"#0063d8",colorHighlight:"#00a4af",fresnelPower:1.3,fresnelIntensity:.33,pulseSpeed:.68,pulseIntensity:.14,rotationSpeed:.24,glitterStrength:.078,glitterDensity:70,specularStrength:1.2,glossiness:28},N=`
    uniform float uTime;
    uniform float uNoiseStrength;
    uniform float uNoiseSpeed;
    uniform float uNoiseDensity;
    
    varying vec2 vUv;
    varying vec3 vNormal;
    varying float vDisplacement;
    varying vec3 vPosition;
    varying vec3 vViewPosition;

    // Simplex 3D Noise 
    // by Ian McEwan, Ashima Arts
    vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}
    vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}

    float snoise(vec3 v){ 
      const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
      const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);

      // First corner
      vec3 i  = floor(v + dot(v, C.yyy) );
      vec3 x0 = v - i + dot(i, C.xxx) ;

      // Other corners
      vec3 g = step(x0.yzx, x0.xyz);
      vec3 l = 1.0 - g;
      vec3 i1 = min( g.xyz, l.zxy );
      vec3 i2 = max( g.xyz, l.zxy );

      //  x0 = x0 - 0.0 + 0.0 * C 
      vec3 x1 = x0 - i1 + 1.0 * C.xxx;
      vec3 x2 = x0 - i2 + 2.0 * C.xxx;
      vec3 x3 = x0 - 1.0 + 3.0 * C.xxx;

      // Permutations
      i = mod(i, 289.0 ); 
      vec4 p = permute( permute( permute( 
                 i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
               + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
               + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));

      // Gradients
      // ( N*N points uniformly over a square, mapped onto an octahedron.)
      float n_ = 1.0/7.0; // N=7
      vec3  ns = n_ * D.wyz - D.xzx;

      vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)

      vec4 x_ = floor(j * ns.z);
      vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)

      vec4 x = x_ *ns.x + ns.yyyy;
      vec4 y = y_ *ns.x + ns.yyyy;
      vec4 h = 1.0 - abs(x) - abs(y);

      vec4 b0 = vec4( x.xy, y.xy );
      vec4 b1 = vec4( x.zw, y.zw );

      vec4 s0 = floor(b0)*2.0 + 1.0;
      vec4 s1 = floor(b1)*2.0 + 1.0;
      vec4 sh = -step(h, vec4(0.0));

      vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
      vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;

      vec3 p0 = vec3(a0.xy,h.x);
      vec3 p1 = vec3(a0.zw,h.y);
      vec3 p2 = vec3(a1.xy,h.z);
      vec3 p3 = vec3(a1.zw,h.w);

      //Normalise gradients
      vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
      p0 *= norm.x;
      p1 *= norm.y;
      p2 *= norm.z;
      p3 *= norm.w;

      // Mix final noise value
      vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
      m = m * m;
      return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), 
                                    dot(p2,x2), dot(p3,x3) ) );
    }

    void main() {
      vUv = uv;
      vNormal = normal;
      
      // Calculate noise based displacement
      float noiseVal = snoise(position * uNoiseDensity + uTime * uNoiseSpeed);
      vDisplacement = noiseVal;
      
      // Displace position along normal
      vec3 newPosition = position + normal * (noiseVal * uNoiseStrength);
      vPosition = newPosition;
      
      vec4 mvPosition = modelViewMatrix * vec4(newPosition, 1.0);
      vViewPosition = -mvPosition.xyz;
      
      gl_Position = projectionMatrix * mvPosition;
    }
  `,T=`
    uniform float uTime;
    uniform vec3 uColorDeep;
    uniform vec3 uColorLight;
    uniform vec3 uColorHighlight;
    uniform float uFresnelPower;
    uniform float uFresnelIntensity;
    uniform float uPulseSpeed;
    uniform float uPulseIntensity;
    uniform float uGlitterStrength;
    uniform float uGlitterDensity;
    uniform float uSpecularStrength;
    uniform float uGlossiness;
    
    varying vec2 vUv;
    varying vec3 vNormal;
    varying float vDisplacement;
    varying vec3 vPosition;
    varying vec3 vViewPosition;

    // Simple pseudo-random function
    float random(vec2 st) {
        return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123);
    }

    void main() {
      // Mix colors based on displacement/noise
      float mixFactor = smoothstep(-0.5, 0.5, vDisplacement);
      vec3 baseColor = mix(uColorDeep, uColorLight, mixFactor);
      
      vec3 viewDirection = normalize(vViewPosition);
      vec3 normal = normalize(vNormal);
      
      // Fresnel effect for metallic look
      float fresnel = pow(1.0 - dot(viewDirection, normal), uFresnelPower);
      
      // Specular Reflection (Blinn-Phong)
      vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0)); // Directional light from top-right-front
      vec3 halfDir = normalize(lightDir + viewDirection);
      float specAngle = max(dot(normal, halfDir), 0.0);
      float specular = pow(specAngle, uGlossiness);
      
      // Glitter Effect
      // Use normal direction for sparkles so they move naturally with rotation
      // Add very slow time component for subtle life
      float glitterNoise = random(vNormal.xy * uGlitterDensity + uTime * 0.05);
      
      // Use smoothstep for softer, more blended sparkles instead of harsh static
      // High threshold (0.95) ensures only peaks sparkle
      float glitter = smoothstep(0.95, 1.0, glitterNoise) * uGlitterStrength * (fresnel + specular);
      
      // Combine
      vec3 finalColor = baseColor;
      finalColor += uColorHighlight * fresnel * uFresnelIntensity; // Rim light
      finalColor += uColorHighlight * specular * uSpecularStrength; // Glossy highlight
      finalColor += vec3(1.0) * glitter; // White sparkles
      
      // Add subtle pulse to alpha/brightness
      float pulse = 1.0 - uPulseIntensity + uPulseIntensity * sin(uTime * uPulseSpeed);
      
      gl_FragColor = vec4(finalColor * pulse, 1.0);
    }
  `,b=new vt({vertexShader:N,fragmentShader:T,uniforms:{uTime:{value:0},uNoiseStrength:{value:l.noiseStrength},uNoiseSpeed:{value:l.noiseSpeed},uNoiseDensity:{value:l.noiseDensity},uColorDeep:{value:new $e(l.colorDeep)},uColorLight:{value:new $e(l.colorLight)},uColorHighlight:{value:new $e(l.colorHighlight)},uFresnelPower:{value:l.fresnelPower},uFresnelIntensity:{value:l.fresnelIntensity},uPulseSpeed:{value:l.pulseSpeed},uPulseIntensity:{value:l.pulseIntensity},uGlitterStrength:{value:l.glitterStrength},uGlitterDensity:{value:l.glitterDensity},uSpecularStrength:{value:l.specularStrength},uGlossiness:{value:l.glossiness}},transparent:!0}),W=g?64:128,q=new _t(1,W,W),D=new qt(q,b);f.add(D),window.coverOrbParams=l,window.coverOrbUniforms=b.uniforms,window.coverOrbMaterial=b,window.coverOrbOrb=D;const S=()=>{if(window.gui){if(window.gui.__folders&&window.gui.__folders["Cover Orb"])return;const P=window.gui.addFolder("Cover Orb");P.add(l,"noiseStrength",0,2).name("Noise Strength"),P.add(l,"noiseSpeed",0,2).name("Noise Speed"),P.add(l,"noiseDensity",0,5).name("Noise Density"),P.addColor(l,"colorDeep").name("Color Deep"),P.addColor(l,"colorLight").name("Color Light"),P.addColor(l,"colorHighlight").name("Color Highlight"),P.add(l,"fresnelPower",0,5).name("Fresnel Power"),P.add(l,"fresnelIntensity",0,5).name("Fresnel Intensity"),P.add(l,"specularStrength",0,2).name("Spec Strength"),P.add(l,"glossiness",1,100).name("Glossiness"),P.add(l,"glitterStrength",0,2).name("Glitter Str"),P.add(l,"glitterDensity",1,200).name("Glitter Dens"),P.add(l,"pulseSpeed",0,5).name("Pulse Speed"),P.add(l,"pulseIntensity",0,1).name("Pulse Intensity"),P.add(l,"rotationSpeed",0,1).name("Rotation Speed"),P.open()}else setTimeout(S,1500)};setTimeout(S,1500);const C=new bt;let O,H=!1;const ie=g?45:60,J=g?30:45;let ne=ie,U=1e3/ne,ce=0;Ie.onScrollStateChange(({isScrolling:P})=>{ne=P?J:ie,U=1e3/ne});const Q=()=>{if(H)return;O=requestAnimationFrame(Q);const P=performance.now(),ee=P-ce;if(ee<U||document.hidden)return;ce=P-ee%U;const oe=C.getElapsedTime();b.uniforms.uTime.value=oe,b.uniforms.uNoiseStrength.value=l.noiseStrength,b.uniforms.uNoiseSpeed.value=l.noiseSpeed,b.uniforms.uNoiseDensity.value=l.noiseDensity,b.uniforms.uColorDeep.value.set(l.colorDeep),b.uniforms.uColorLight.value.set(l.colorLight),b.uniforms.uColorHighlight.value.set(l.colorHighlight),b.uniforms.uFresnelPower.value=l.fresnelPower,b.uniforms.uFresnelIntensity.value=l.fresnelIntensity,b.uniforms.uPulseSpeed.value=l.pulseSpeed,b.uniforms.uPulseIntensity.value=l.pulseIntensity,b.uniforms.uGlitterStrength.value=l.glitterStrength,b.uniforms.uGlitterDensity.value=l.glitterDensity,b.uniforms.uSpecularStrength.value=l.specularStrength,b.uniforms.uGlossiness.value=l.glossiness,D.rotation.y=oe*l.rotationSpeed,D.rotation.z=oe*(l.rotationSpeed*.5),i.render(f,e)};Q();const de=()=>{if(!d)return;const P=d.clientWidth,ee=d.clientHeight,oe=P/ee;e.aspect=oe,e.updateProjectionMatrix();const v=3.5,B=2.7/oe;e.position.z=Math.max(v,B),i.setSize(P,ee),i.setPixelRatio(Math.min(window.devicePixelRatio,2))};window.addEventListener("resize",de),de();const pe={pause:()=>{H=!0,O&&cancelAnimationFrame(O)},resume:()=>{H&&(H=!1,Q())},cleanup:()=>{H=!0,O&&cancelAnimationFrame(O),window.removeEventListener("resize",de),i.dispose(),q.dispose(),b.dispose(),window.coverOrbInitialized=!1}};return window.coverOrbControls=pe,pe}function Ht(){const d=document.querySelector("#timeline-shader-bg");if(!d){o.warn("Timeline Shader: Canvas #timeline-shader-bg not found");return}const g=Ie.getSettings(),f=Ie.isMobile(),e=g.timelineShaderDotCount||{x:62,y:36},i={dotCountX:e.x,dotCountY:e.y,spacing:.8,dotSize:f?8:10,waveSpeed:.32,waveFrequencyX:.16,waveFrequencyY:.32,waveAmplitude:1.9,color:"#4fb3d9",opacity:.58,rotationX:-1.7,rotationY:0,rotationZ:.26,cameraZ:60,bobbingAmplitude:1.4,bobbingSpeed:.22,positionX:-2,positionY:-30,positionZ:-16,fadeIntensity:.86};window.timelineShaderParams=i,i.scale=(window.innerWidth>1440,3.4),setTimeout(()=>{if(window.gui){let v=window.gui.__folders["Timeline Shader"];v||(v=window.gui.addFolder("Timeline Shader")),v.add(i,"waveSpeed",0,2).name("Wave Speed"),v.add(i,"waveAmplitude",0,10).name("Amplitude"),v.add(i,"waveFrequencyX",0,1).name("Freq X"),v.add(i,"waveFrequencyY",0,1).name("Freq Y"),v.add(i,"bobbingAmplitude",0,20).name("Bob Amplitude"),v.add(i,"bobbingSpeed",0,2).name("Bob Speed"),v.add(i,"fadeIntensity",0,1).name("Fade Intensity").onChange(G=>{S&&S.uniforms&&(S.uniforms.uFadeIntensity.value=G)}),v.add(i,"dotSize",.1,10).name("Dot Size").onChange(G=>{S&&S.uniforms&&(S.uniforms.uSize.value=G*T.getPixelRatio())}),v.addColor(i,"color").name("Dot Color").onChange(G=>{S&&S.uniforms&&S.uniforms.uColor.value.set(G)}),v.add(i,"opacity",0,1).name("Opacity").onChange(G=>{S&&S.uniforms&&(S.uniforms.uOpacity.value=G)}),v.add(i,"scale",.1,5).name("Scale").onChange(G=>{C&&C.scale.set(G,G,G)});const B=v.addFolder("Position");B.add(i,"positionX",-200,200).name("Pos X"),B.add(i,"positionY",-200,200).name("Pos Y"),B.add(i,"positionZ",-200,200).name("Pos Z");const re=v.addFolder("Rotation");re.add(i,"rotationX",-Math.PI,Math.PI).name("Rot X"),re.add(i,"rotationY",-Math.PI,Math.PI).name("Rot Y"),re.add(i,"rotationZ",-Math.PI,Math.PI).name("Rot Z")}},1e3);const l=new ft,N=new ht(75,window.innerWidth/window.innerHeight,.1,1e3);N.position.z=i.cameraZ;const T=new yt({canvas:d,alpha:!0,antialias:!1,powerPreference:f?"low-power":"default"});T.setSize(window.innerWidth,window.innerHeight),T.setPixelRatio(Math.min(window.devicePixelRatio,f?.75:1.25)),d.style.width=`${window.innerWidth}px`,d.style.height=`${window.innerHeight}px`;const b=new $t,W=[],q=-(i.dotCountX*i.spacing)/2,D=-(i.dotCountY*i.spacing)/2;for(let v=0;v<i.dotCountX;v++)for(let B=0;B<i.dotCountY;B++){const re=q+v*i.spacing,G=D+B*i.spacing;W.push(re,G,0)}b.setAttribute("position",new Nt(W,3));const S=new vt({uniforms:{uTime:{value:0},uColor:{value:new $e(i.color)},uOpacity:{value:i.opacity},uSize:{value:i.dotSize*T.getPixelRatio()},uFrequencyX:{value:i.waveFrequencyX},uFrequencyY:{value:i.waveFrequencyY},uAmplitude:{value:i.waveAmplitude},uFadeIntensity:{value:i.fadeIntensity}},vertexShader:`
      uniform float uTime;
      uniform float uSize;
      uniform float uFrequencyX;
      uniform float uFrequencyY;
      uniform float uAmplitude;
      
      varying float vDepth;
      
      void main() {
        vec3 pos = position;
        
        // Calculate wave displacement
        // Combine sine waves for organic movement
        float wave1 = sin(pos.x * uFrequencyX + uTime) * uAmplitude;
        float wave2 = cos(pos.y * uFrequencyY + uTime * 0.8) * uAmplitude * 0.5;
        
        pos.z += wave1 + wave2;
        
        vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
        gl_Position = projectionMatrix * mvPosition;
        
        // Pass depth to fragment shader for fade effect
        vDepth = -mvPosition.z;
        
        // Size attenuation based on depth
        gl_PointSize = uSize * (30.0 / vDepth);
      }
    `,fragmentShader:`
      uniform vec3 uColor;
      uniform float uOpacity;
      uniform float uFadeIntensity;
      
      varying float vDepth;
      
      void main() {
        // Circular dot shape
        vec2 center = gl_PointCoord - vec2(0.5);
        float dist = length(center);
        
        if (dist > 0.5) discard;
        
        // Soft edge
        float alpha = 1.0 - smoothstep(0.3, 0.5, dist);
        
        // Apply fog-like fade based on depth
        // Normalize depth to 0-1 range (adjust these values for fade distance)
        float depthFade = 1.0 - smoothstep(30.0, 100.0, vDepth);
        depthFade = mix(1.0, depthFade, uFadeIntensity);
        
        gl_FragColor = vec4(uColor, uOpacity * alpha * depthFade);
      }
    `,transparent:!0,depthWrite:!1,blending:Wt}),C=new Ot(b,S);C.rotation.x=i.rotationX,C.rotation.y=i.rotationY,C.rotation.z=i.rotationZ,C.scale.set(i.scale,i.scale,i.scale),C.position.set(i.positionX,i.positionY,i.positionZ),l.add(C);const O=new bt;let H,ie=!1,J=!0,ne=!1;const U=f?30:60,ce=f?20:45;let Q=U,de=1e3/Q,pe=0;Ie.onScrollStateChange(({isScrolling:v})=>{ne=v,Q=v?U:ce,de=1e3/Q});const P=new IntersectionObserver(v=>{v.forEach(B=>{J=B.isIntersecting})},{threshold:.1,rootMargin:"50px"});P.observe(d);function ee(){if(ie)return;H=requestAnimationFrame(ee);const v=performance.now(),B=v-pe;if(B<de||!J||document.hidden)return;pe=v-B%de;const re=O.getElapsedTime();if(f&&ne?S.uniforms.uTime.value+=.008:S.uniforms.uTime.value=re*i.waveSpeed,(!f||!ne)&&(S.uniforms.uFrequencyX.value=i.waveFrequencyX,S.uniforms.uFrequencyY.value=i.waveFrequencyY,S.uniforms.uAmplitude.value=i.waveAmplitude,S.uniforms.uColor.value.set(i.color),S.uniforms.uFadeIntensity.value=i.fadeIntensity),S.uniforms.uOpacity.value=i.opacity,!f){const G=Math.sin(re*i.bobbingSpeed)*i.bobbingAmplitude;C.position.set(i.positionX,i.positionY+G,i.positionZ),C.rotation.x=i.rotationX,C.rotation.y=i.rotationY,C.rotation.z=i.rotationZ,C.scale.set(i.scale,i.scale,i.scale)}T.render(l,N)}function oe(){N.aspect=window.innerWidth/window.innerHeight,N.updateProjectionMatrix(),T.setSize(window.innerWidth,window.innerHeight),S.uniforms.uSize.value=i.dotSize*T.getPixelRatio(),d.style.width=`${window.innerWidth}px`,d.style.height=`${window.innerHeight}px`,i.scale=(window.innerWidth>1440,3.4),C.scale.set(i.scale,i.scale,i.scale)}return window.addEventListener("resize",oe),requestAnimationFrame(ee),{stop:()=>{ie=!0,cancelAnimationFrame(H),window.removeEventListener("resize",oe),P.disconnect()},resume:()=>{ie&&(ie=!1,window.addEventListener("resize",oe),f||oe(),O.start(),pe=performance.now(),requestAnimationFrame(ee))},updateParams:v=>{Object.assign(i,v)},setTargetFPS:v=>{Q=v,de=1e3/v}}}r.ticker.lagSmoothing(0);Ie.onFpsCapChange(d=>{o.log(`[Timeline] Applying GSAP ticker fps cap: ${d.cap}fps (${d.reason})`),r.ticker.fps(d.cap)});let Ke=0;const Xt=window.matchMedia("(max-width: 1024px)").matches?250:150;function ii(){const d={timestamp:Date.now(),elements:{},shaderInit:!1,orbInit:!1,positionCaptured:!1,attempts:0,errors:[]};window._isTimelineDismissed=!1,window._isDismissing=!1;const g=document.querySelector("#acs-timeline"),f=document.querySelector("#timeline-window-start"),e=document.querySelector("#timeline-window-bg"),i=document.querySelector(".get-involved-message");if(d.elements.timeline=!!g,d.elements.windowStart=!!f,d.elements.windowBg=!!e,d.elements.getInvolvedMessage=!!i,document.querySelector("#timeline-shader-bg")&&!window.timelineShaderControls)try{window.timelineShaderControls=Ht(),d.shaderInit=!!window.timelineShaderControls,window.timelineShaderControls&&window.timelineShaderControls.stop&&window.timelineShaderControls.stop()}catch(t){o.warn("[Timeline] Shader initialization failed:",t.message),d.errors.push({type:"shader",message:t.message})}if(document.querySelector("#timeline-cover-canvas")&&!window.coverOrbControls)try{window.coverOrbControls=Yt(),d.orbInit=!!window.coverOrbControls,window.coverOrbControls&&window.coverOrbControls.pause&&window.coverOrbControls.pause()}catch(t){o.warn("[Timeline] Cover orb initialization failed:",t.message),d.errors.push({type:"coverOrb",message:t.message})}if(!g||!f||!e||!i){o.warn("Timeline: Required elements not found. Skipping timeline initialization.",d.elements),window.dispatchEvent(new CustomEvent("timeline:init-failed",{detail:{reason:"missing-elements",state:d}}));return}const l=g.querySelector(".timeline-container"),N=g.querySelector(".timeline-track");if(!l||!N){o.warn("Timeline: Container or track not found. Skipping timeline initialization.");return}typeof window.backgroundPaused>"u"&&(window.backgroundPaused=!1);let T=null,b=null,W=!0;const q=(t,n,s)=>t+(n-t)*s,D=()=>{if(!f)return o.warn("[Timeline] getSpanPosition: timelineWindowStart element is null"),null;const t=f.getBoundingClientRect();if(t.width===0||t.height===0){try{const n=window.getComputedStyle(f);o.warn("[Timeline] Zero-dimension element detected:",{width:t.width,height:t.height,top:t.top,left:t.left,display:n.display,visibility:n.visibility,opacity:n.opacity,position:n.position,parentVisible:f.parentElement?window.getComputedStyle(f.parentElement).display:"no-parent"})}catch(n){o.warn("[Timeline] Zero-dimension element - could not get computed style:",n.message)}return null}return{top:t.top-2,left:t.left-6,width:t.width+12,height:t.height+4}},S=()=>{const t=D();return!t||!e?!1:(T={...t},b={...t},R={...t},e.style.position="fixed",e.style.top=`${t.top}px`,e.style.left=`${t.left}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`,e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.borderRadius="4px",e.style.zIndex="0",!0)},C=()=>{if(!f||!e||!W)return;const t=f.getBoundingClientRect();if(t.width===0||t.height===0)return;const n=.1,s=.5,m=.5;b||(b={top:0,left:0,width:0,height:0}),!(!(Math.abs(t.top-b.top)>n||Math.abs(t.left-b.left)>s||Math.abs(t.width-b.width)>m||Math.abs(t.height-b.height)>m)&&b.top!==0)&&(b={top:t.top,left:t.left,width:t.width,height:t.height},T?T={top:q(T.top,t.top,.6),left:q(T.left,t.left,.6),width:q(T.width,t.width,.6),height:q(T.height,t.height,.6)}:T={top:t.top,left:t.left,width:t.width,height:t.height},e.style.position="fixed",e.style.top=`${T.top}px`,e.style.left=`${T.left}px`,e.style.width=`${T.width}px`,e.style.height=`${T.height}px`,e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.zIndex="0",e.style.borderRadius="4px")};r.set(e,{opacity:0,visibility:"hidden"});const O=document.createElement("style");O.id="timeline-window-start-bg-style",O.textContent=`
    #timeline-window-start::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -6px;
      right: -6px;
      bottom: -2px;
      background: linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164));
      border-radius: 4px;
      opacity: 0;
      z-index: -1;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
  `,document.head.appendChild(O),f.style.position="relative",f.style.zIndex="1";let H=0;const ie=6,J=()=>{H++;const t=D();return t?(T={...t},b={...t},R={...t},e.style.position="fixed",e.style.top=`${t.top}px`,e.style.left=`${t.left}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`,e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.borderRadius="4px",o.log(`[Timeline] Background position captured on attempt ${H}:`,t),!0):!1};requestAnimationFrame(()=>{J()||setTimeout(()=>{J()||setTimeout(()=>{J()||setTimeout(()=>{J()||setTimeout(()=>{J()||setTimeout(()=>{J()||(o.warn(`[Timeline] Failed to capture background position after ${ie} attempts over 1050ms`),window.dispatchEvent(new CustomEvent("timeline:init-failed",{detail:{reason:"position-capture-failed",attempts:H,elementExists:!!f}})))},400)},300)},200)},100)},50)});const ne=new ResizeObserver(()=>{W&&!document.body.classList.contains("in-timeline")&&S()});ne.observe(document.body);let U=null,ce=!1,Q=0;const de=window.matchMedia("(max-width: 1024px)").matches?5:3,pe=()=>{if(ce)return;ce=!0,Q=0;const t=()=>{ce&&(Q++,Q%de===0&&C(),U=requestAnimationFrame(t))};t()},P=()=>{ce&&(ce=!1,U!==null&&(cancelAnimationFrame(U),U=null),Q=0)},ee=Z.create({trigger:i,start:"top bottom",end:"bottom top",onEnter:()=>{try{if(V||window._isTimelineDismissed)return;S(),pe()}catch(t){o.warn("[Timeline] Error in tracking onEnter:",t.message)}},onLeave:()=>{},onEnterBack:()=>{try{if(V||window._isTimelineDismissed){o.log("[Tracking] onEnterBack blocked - timeline is dismissed");return}S(),pe()}catch(t){o.warn("[Timeline] Error in tracking onEnterBack:",t.message)}},onLeaveBack:()=>{try{P()}catch(t){o.warn("[Timeline] Error in tracking onLeaveBack:",t.message)}}});if(ee||o.warn("[Timeline] Failed to create tracking ScrollTrigger"),window.matchMedia("(max-width: 1024px)").matches&&g){const t=()=>{Oe.hide(),Oe.setOpacity(0);const s=document.getElementById("mobile-film-grain");s&&(s.style.opacity="0",s.style.display="none",s.style.visibility="hidden")},n=()=>{Oe.setOpacity(.25),Oe.show();const s=document.getElementById("mobile-film-grain");s&&(s.style.visibility="visible",s.style.display="block",s.style.opacity="0.25")};Z.create({trigger:g,start:"top 80%",end:"bottom 20%",onEnter:()=>{V||window._isTimelineDismissed||(o.log("[Timeline] Mobile: Pausing background elements for performance"),window.backgroundPaused=!0,t())},onLeave:()=>{V||window._isTimelineDismissed||(o.log("[Timeline] Mobile: Resuming background elements"),window.backgroundPaused=!1,n())},onEnterBack:()=>{if(V||window._isTimelineDismissed){o.log("[Timeline] Mobile onEnterBack blocked - timeline is dismissed");return}o.log("[Timeline] Mobile: Pausing background elements (scrolled back)"),window.backgroundPaused=!0,t()},onLeaveBack:()=>{V||window._isTimelineDismissed||(o.log("[Timeline] Mobile: Resuming background elements (scrolled back up)"),window.backgroundPaused=!1,n())}})}const v=r.utils.toArray(".timeline-event"),B=r.utils.toArray(".timeline-decade"),re=v.length-1,G=()=>{const t=window.innerWidth;return t<1025?t:t>=1280?Math.min(1324,t*.92):t*.5},ue=()=>window.matchMedia("(max-width: 1024px)").matches,St=()=>window.innerHeight*1,Je=()=>window.innerHeight*(ue()?.7:.88),Qe=()=>St()+re*Je();Je(),Qe();const j=ue()?.6:.88,he=.08,Ne=j+he,We=.09+he,xt=re*Ne,ze=We+xt;let I={isLocked:!1,targetIndex:-1,unlockTimer:null,reason:""},Ye=0,z=null,A=null,Fe=null,ge=!1,He=0,x;const et=(t,n,s=0)=>{if(!t||!x)return;const m=[],h=t.querySelector(".event-year"),c=t.querySelector(".event-description"),w=t.querySelector(".event-image");h&&m.push(h),c&&m.push(c),w&&m.push(w),m.length&&x.fromTo(m,{opacity:0},{opacity:1,duration:Math.max(.25,j*.65),ease:"power2.out",stagger:.08,force3D:!0},n?`${n}+=${s}`:s)},tt=t=>{if(z||(z=document.querySelector("#current-timeline-year")),!z){ge=!1;return}r.set(z,{opacity:1}),z.textContent=t,Fe=t,A=new Bt(z,{types:"chars",charClass:"split-char"}),A.chars&&A.chars.length>0?(r.set(A.chars,{opacity:0,y:20,display:"inline-block",force3D:!0}),r.to(A.chars,{opacity:1,y:0,duration:.27,stagger:.02,ease:"power2.out",overwrite:!0,force3D:!0,onComplete:()=>{ge=!1}})):ge=!1},kt=t=>{if(!(!t||t===Fe||ge)){if(ge=!0,z||(z=document.querySelector("#current-timeline-year")),!z){ge=!1;return}A&&A.chars&&A.chars.length>0?r.to(A.chars,{opacity:0,y:-20,duration:.17,stagger:.01,ease:"power2.in",force3D:!0,onComplete:()=>{A&&typeof A.revert=="function"&&A.revert(),tt(t)}}):tt(t)}},it=()=>{z||(z=document.querySelector("#current-timeline-year")),z&&r.to(z,{opacity:0,duration:.3,ease:"power2.out",force3D:!0,onComplete:()=>{A&&typeof A.revert=="function"&&A.revert(),z.textContent="",Fe=null,ge=!1}})};function nt(){o.log("[Re-entry] Starting timeline re-entry"),xe=!0,o.log("[Re-entry] Set isReEntering flag to TRUE - scroll positioning disabled"),V=!1,Pe=!1,window._isTimelineDismissed=!1,window._isDismissing=!1,r.set(i,{opacity:1}),g.classList.contains("closed")||o.warn("[Re-entry] Timeline was not collapsed, should have been"),r.killTweensOf(e),e.style.cssText="";const t=D(),n=t?t.top:window.innerHeight/2-20,s=t?t.left:window.innerWidth/2-100,m=t?t.width:200,h=t?t.height:40;t&&(R={...t}),e.style.position="fixed",e.style.top=`${n}px`,e.style.left=`${s}px`,e.style.width=`${m}px`,e.style.height=`${h}px`,e.style.zIndex="9999",e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.pointerEvents="none",e.style.visibility="visible",e.style.display="block",e.style.borderRadius="4px",e.style.opacity="0.5",o.log("[Re-entry] Background positioned to match timeline-window-start:",{top:n,left:s,width:m,height:h,posValid:!!t});function c(){o.log("[Re-entry] Starting background expansion animation"),e.style.setProperty("--decal-opacity","0"),o.log("[Re-entry] Set shader background (--decal-opacity) to 0");const p=document.getElementById("timeline-window-start-bg-style");p&&(p.textContent=`
          #timeline-window-start::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -6px;
            right: -6px;
            bottom: -2px;
            background: linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164));
            border-radius: 4px;
            opacity: 0 !important;
            z-index: -1;
            pointer-events: none;
            transition: none !important;
          }
        `);const y=r.timeline({onComplete:()=>{o.log("[Re-entry] Expansion complete, now locking background"),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.opacity="1",e.style.visibility="visible",e.style.display="block",e.style.borderRadius="0px",e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.zIndex="9999",ye=!0,o.log("[Re-entry] Background locked at fullscreen - isBgLockedFullscreen = TRUE");function M(){if(!ye)return;const L=e.getBoundingClientRect(),Y=e.style.top!=="0px"||e.style.left!=="0px"||e.style.width!=="100vw"||e.style.height!=="100vh",_=Math.abs(L.top)>2||Math.abs(L.left)>2||Math.abs(L.width-window.innerWidth)>5||Math.abs(L.height-window.innerHeight)>5;(Y||_)&&(o.warn("[Re-entry] AGGRESSIVE LOCK: Background moved! Inline styles:",{top:e.style.top,left:e.style.left,width:e.style.width,height:e.style.height},"Computed position:",{top:L.top,left:L.left,width:L.width,height:L.height}),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.opacity="1",e.style.visibility="visible",e.style.display="block",e.style.zIndex="9999",e.style.transform="none",e.style.margin="0",e.style.padding="0"),requestAnimationFrame(M)}M(),o.log("[Re-entry] Started aggressive fullscreen protection loop"),document.body.classList.add("in-timeline"),o.log("[Re-entry] Added .in-timeline class for protection"),o.log("[Re-entry] Background locked at fullscreen, now restoring timeline content"),w()}});y.to(e,{top:0,left:0,width:"100vw",height:"100vh",borderRadius:"0px",opacity:1,duration:.6,ease:"power2.inOut",onStart:()=>{o.log("[Re-entry] Background expansion started"),e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.visibility="visible",e.style.display="block",e.style.zIndex="9999"},onUpdate:function(){const M=this.progress();e.style.visibility="visible",e.style.display="block",e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",(M===0||M===.5||M===1)&&o.log(`[Re-entry] Expansion progress: ${(M*100).toFixed(0)}%, opacity: ${e.style.opacity}, size: ${e.style.width} x ${e.style.height}`)},onComplete:()=>{o.log("[Re-entry] Background expansion animation complete"),e.style.opacity="1",e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))"}},0),y.fromTo(e,{opacity:.5},{opacity:1,duration:.6,ease:"none"},0),y.to(i,{opacity:0,duration:.4,ease:"power2.in"},.2);const a=document.querySelector("#background-canvas");a&&y.to(a,{opacity:0,duration:.5,ease:"power2.inOut"},0);const E=document.documentElement;E.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",o.log("[Re-entry] Starting expansion timeline, duration:",y.duration()),y.play()}function w(){o.log("[Re-entry] Restoring timeline content and structure"),g.style.pointerEvents="",g.style.display="",g.classList.remove("closed"),g.style.opacity="0",l.style.opacity="0",De.forEach(a=>{a&&a.enable&&a.enable()}),Z.getAll().forEach(a=>{(a.vars.trigger===g||a.vars.trigger===i||a.vars.pin===l)&&a.enable()}),r.utils.toArray(".timeline-event").forEach(a=>{r.set(a,{opacity:0})});const y=document.querySelector(".timeline-track");y&&r.set(y,{x:0,y:0}),requestAnimationFrame(()=>{Z.refresh(),requestAnimationFrame(()=>{o.log("[Re-entry] Content restored, now scrolling to timeline"),u()})})}function u(){let p;if(x&&x.scrollTrigger){const y=window.innerHeight*.35;p=x.scrollTrigger.start+y}else p=g.getBoundingClientRect().top+window.scrollY;o.log("[Re-entry] Scrolling to timeline position:",p),document.body.classList.add("in-timeline"),window.backgroundPaused||(window.backgroundPaused=!0,window.dispatchEvent(new CustomEvent("timeline:backgroundPaused",{detail:{paused:!0}}))),window.shaderBackgroundRenderer&&window.shaderBackgroundRenderer.setInTimeline&&window.shaderBackgroundRenderer.setInTimeline(!0),window.coverOrbControls&&window.coverOrbControls.resume&&window.coverOrbControls.resume(),window.timelineShaderControls&&window.timelineShaderControls.resume&&window.timelineShaderControls.resume(),x&&x.scrollTrigger&&x.progress(0),window.lenis?window.lenis.scrollTo(p,{duration:.8,easing:y=>Math.min(1,1.001-Math.pow(2,-10*y)),onComplete:()=>{o.log("[Re-entry] Scroll complete, fading in timeline"),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.opacity="1",e.style.visibility="visible",e.style.display="block",e.style.borderRadius="0px",e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",o.log("[Re-entry] Locked background at fullscreen state"),xe=!1,ye=!1,o.log("[Re-entry] Cleared isReEntering and isBgLockedFullscreen flags to FALSE - scroll positioning re-enabled"),e.style.zIndex="5",r.to(g,{opacity:1,duration:.3,ease:"power2.out"}),r.to(l,{opacity:1,duration:.3,ease:"power2.out"}),r.to(e,{"--decal-opacity":1,duration:.5,ease:"power2.out",onUpdate:function(){const y=r.getProperty(e,"--decal-opacity")||0;e.style.setProperty("--decal-opacity",y)}}),o.log("[Re-entry] Fading in shader background (--decal-opacity)")}}):(window.scrollTo({top:p,behavior:"smooth"}),setTimeout(()=>{o.log("[Re-entry] Scroll complete, fading in timeline"),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.opacity="1",e.style.visibility="visible",e.style.display="block",e.style.borderRadius="0px",e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",o.log("[Re-entry] Locked background at fullscreen state (fallback)"),xe=!1,ye=!1,o.log("[Re-entry] Cleared isReEntering and isBgLockedFullscreen flags to FALSE - scroll positioning re-enabled"),e.style.zIndex="5",r.to(g,{opacity:1,duration:.3,ease:"power2.out"}),r.to(l,{opacity:1,duration:.3,ease:"power2.out"}),r.to(e,{"--decal-opacity":1,duration:.5,ease:"power2.out",onUpdate:function(){const y=r.getProperty(e,"--decal-opacity")||0;e.style.setProperty("--decal-opacity",y)}}),o.log("[Re-entry] Fading in shader background (--decal-opacity) - fallback")},800))}c()}if(f){const t=n=>{(V||window._isTimelineDismissed)&&(n.preventDefault(),n.stopPropagation(),nt())};f.addEventListener("click",t,{capture:!0}),f.addEventListener("touchend",t,{passive:!1,capture:!0}),f.style.pointerEvents="auto"}const Ae=document.querySelector(".re-enter-timeline");if(Ae){const t=n=>{(V||window._isTimelineDismissed)&&(window.playUIClickSound&&!window.audioMuted&&window.playUIClickSound(),n.preventDefault(),n.stopPropagation(),Ae.classList.remove("active"),nt())};Ae.addEventListener("click",t,{capture:!0}),Ae.addEventListener("touchend",t,{passive:!1,capture:!0})}let Xe=!1,ot=-1,st=0;const Tt=ue()?.003:.001,Ct=ue()?2:1,Ce=t=>{Math.abs(t-ot)<Tt||(st++,st%Ct===0&&(ot=t,!Xe&&(Xe=!0,requestAnimationFrame(()=>{Xe=!1,Pt()}))))};let Ge=null,Ve=null,Ze=null,Be=null,_e=null;const Pt=t=>{Ge||(Ge=document.querySelector(".scrubber-progress")),Ve||(Ve=r.utils.toArray(".marker")),Ze||(Ze=r.utils.toArray(".minor-node"));const n=Ge,s=Ve,m=Ze;if(!n||!B.length)return;const h=s.length;let c=0,w=0,u=-1;if(I.isLocked&&I.targetIndex>=0)c=I.targetIndex,w=(2*c+1)/(2*h);else{const p=window.matchMedia("(max-width: 1024px)").matches,y=p?window.innerHeight/2:window.innerWidth/2;let a=null,E=1/0,M=-1;if(v.forEach((L,Y)=>{const _=L.getBoundingClientRect(),me=p?_.top+_.height/2:_.left+_.width/2,le=Math.abs(me-y);le<E&&(E=le,a=L,M=Y)}),M!==-1&&(He=M),a&&a.classList.contains("timeline-cover"))c=0,u=0,w=1/(2*h),it();else if(a){u=M-1,u=Math.max(0,Math.min(u,m.length-1));const L=a.getAttribute("data-year");if(L&&kt(L),u>=0&&m.length>0){const Y=m[u];if(Y){const _=parseInt(Y.getAttribute("data-decade-index")||"0");c=Math.min(_,h-1)}else c=0}else c=0}else c=0,u=0,w=1/(2*h),it()}if(u>=0&&m.length>0){const p=m[u];if(p)if(Be||(Be=document.querySelector(".scrubber-line")),_e||(_e=document.querySelector(".scrubber-content")),Be&&_e){const y=Be.getBoundingClientRect(),a=p.getBoundingClientRect();_e.getBoundingClientRect();const E=a.left+a.width/2-y.left,M=y.width;w=Math.max(0,Math.min(1,E/M))}else w=(2*c+1)/(2*h);else w=(2*c+1)/(2*h)}else w=(2*c+1)/(2*h);if(r.to(n,{scaleX:w,transformOrigin:"left",duration:.3,ease:"power2.out",force3D:!0,overwrite:"auto"}),s.length>0&&s.forEach((p,y)=>{p.classList.remove("active","complete"),y===c?p.classList.add("active"):y<c&&p.classList.add("complete")}),m.length>0&&m.forEach((p,y)=>{p.classList.remove("active","complete");const a=parseInt(p.getAttribute("data-minor-index")||y);a===u?p.classList.add("active"):a<u&&p.classList.add("complete")}),window.scrubberAutoScroll&&!I.isLocked){const p=c>Ye?1:c<Ye?-1:0;window.scrubberAutoScroll(c,p),Ye=c}};window._updateScrubber=Ce;const Et=t=>{if(t===0)return(.09+he*.5)/ze;let n=0;for(let w=0;w<t&&w<B.length;w++){const u=r.utils.toArray(".timeline-event",B[w]);n+=u.length}const s=B[t];if(r.utils.toArray(".timeline-event",s).length===0)return o.warn(`Decade ${t} has no events`),0;const h=n-1,c=We+h*Ne+j+he*.5;return Math.min(c/ze,.99)},Se=(t,n=!1)=>{const s=document.getElementById("timeline-window-start-bg-style");if(!s)return o.warn("[Timeline] Pseudo-element style element not found"),!1;try{return s.textContent=`
        #timeline-window-start::before {
          content: '';
          position: absolute;
          top: -2px;
          left: -6px;
          right: -6px;
          bottom: -2px;
          background: linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164));
          border-radius: 4px;
          opacity: ${t};
          z-index: -1;
          pointer-events: none;
          ${n?"transition: opacity 0.3s ease;":"transition: none !important;"}
        }
      `,!0}catch(m){return o.warn("[Timeline] Failed to update pseudo-element style:",m.message),!1}},Me=r.timeline({scrollTrigger:{trigger:f,start:"top 90%",end:"top 70%",scrub:1,onLeaveBack:()=>{Se(0,!1)}}}).to({},{duration:1,ease:"power2.out",onUpdate:function(){try{const n=this.progress()*.5;Se(n)}catch(t){o.warn("[Timeline] Error updating pseudo-element style:",t.message)}}});let R=null;const De=[];let V=!1,Pe=!1,xe=!1,ye=!1;function Rt(){r.to(l,{opacity:0,duration:.44,ease:"power2.out",onComplete:()=>{Lt()}})}function Lt(){Pe=!0,window._isDismissing=!0,V=!0,window._isTimelineDismissed=!0,document.body.classList.remove("in-timeline");const t=document.querySelector("#current-timeline-year");t&&r.to(t,{opacity:0,duration:.44,ease:"power2.out"});const n=document.getElementById("timeline-window-start-bg-style");n&&(n.textContent=`
        #timeline-window-start::before {
          content: '';
          position: absolute;
          top: -2px;
          left: -6px;
          right: -6px;
          bottom: -2px;
          background: linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164));
          border-radius: 4px;
          opacity: 0.5;
          z-index: -1;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }
      `),r.to(i,{opacity:1,duration:.3,ease:"power2.out"}),De.forEach(u=>{u&&u.disable&&u.disable()}),Z.getAll().forEach(u=>{(u.vars.trigger===g||u.vars.trigger===i||u.vars.pin===l)&&u.disable()});const s=i.getBoundingClientRect(),m=s.top+window.scrollY,h=window.innerHeight;m-h/2+s.height/2,window.backgroundPaused&&(window.backgroundPaused=!1,window.dispatchEvent(new CustomEvent("timeline:backgroundPaused",{detail:{paused:!1}}))),window.shaderBackgroundRenderer&&window.shaderBackgroundRenderer.setInTimeline&&window.shaderBackgroundRenderer.setInTimeline(!1);const c=document.querySelector("#background-canvas");c&&r.set(c,{opacity:1});const w=document.documentElement;w.style.background="",e.style.cssText=`
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      opacity: 1 !important;
      z-index: 5 !important; /* Behind container (z-index 10) but above other content */
      background: linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164)) !important;
      pointer-events: none !important;
      visibility: visible !important;
      transform: none !important;
      transition: none !important;
    `,g.style.opacity="1",g.style.transition="none",r.to(g,{opacity:0,duration:.44,ease:"power2.inOut",onComplete:()=>{e.style.zIndex="9999",window.lenis?window.lenis.scrollTo(0,{immediate:!0,force:!0,lock:!0}):window.scrollTo(0,0),g.classList.add("closed"),Z.refresh();const u=i.getBoundingClientRect(),p=u.top+window.scrollY,y=window.innerHeight,a=p-y/2+u.height/2;window.lenis?(window.lenis.scrollTo(a,{immediate:!0,force:!0,lock:!0}),window.lenis.resize(),window.lenis.raf(Date.now())):window.scrollTo(0,a),setTimeout(()=>{window.lenis&&window.lenis.resize(),r.to(e,{opacity:0,duration:.44,ease:"power2.inOut",onComplete:()=>{e.style.cssText="",e.style.position="",e.style.top="",e.style.left="",e.style.width="",e.style.height="",e.style.zIndex="",e.style.opacity="",e.style.visibility="",e.style.background="",e.style.pointerEvents="",e.style.transform="",e.style.transition="",e.style.borderRadius="",g.style.pointerEvents="none",document.body.classList.remove("in-timeline"),Pe=!1,window._isDismissing=!1;const E=document.querySelector(".re-enter-timeline");E&&E.classList.add("active")}})},100)}})}const rt=window.innerHeight*.33,at=rt+600,ae=rt/at,ke=r.timeline({scrollTrigger:{trigger:i,start:"center center",end:`+=${at}`,pin:!0,scrub:ue()?1.5:1,anticipatePin:1,invalidateOnRefresh:!0,onRefresh:t=>{if(V||window._isTimelineDismissed){o.log("[Expansion] onRefresh blocked - timeline is dismissed");return}if(xe){o.log("[Re-entry] onRefresh blocked by isReEntering flag");return}if(ye){o.log("[Re-entry] onRefresh blocked by isBgLockedFullscreen flag");return}if(document.body.classList.contains("in-timeline")){o.log("[Re-entry] onRefresh blocked - already in timeline");return}R=null;const n=ae+.01*(1-ae),s=D();t.progress>0&&t.progress<n?s&&(e.style.position="fixed",e.style.top=`${s.top}px`,e.style.left=`${s.left}px`,e.style.width=`${s.width}px`,e.style.height=`${s.height}px`,e.style.opacity="0",e.style.visibility="hidden",R={...s}):t.progress>=n&&t.progress<1&&s&&(R={...s})},onUpdate:t=>{if(V||window._isTimelineDismissed||Pe||window._isDismissing||xe)return;if(ye){(e.style.top!=="0px"||e.style.left!=="0px"||e.style.width!=="100vw"||e.style.height!=="100vh"||e.style.opacity!=="1")&&(o.log("[Timeline] FULLSCREEN LOCK: Re-locking background at fullscreen"),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.opacity="1",e.style.visibility="visible",e.style.display="block");return}if(document.body.classList.contains("in-timeline")){(e.style.opacity!=="1"||e.style.visibility!=="visible")&&(o.log("[Timeline] onUpdate safety: Forcing background visible (in-timeline)"),e.style.opacity="1",e.style.visibility="visible",e.style.display="block");return}const n=t.progress,s=ae+.01*(1-ae);if(Math.abs(n-s)<.03){if(!R||R.width===0||R.height===0){const w=D();w?(R={...w},o.log("[Timeline] Critical handoff: Captured fresh position")):o.warn("[Timeline] Critical handoff: Could not get fresh position")}n>=s&&n<s+.02&&((e.style.visibility==="hidden"||e.style.opacity==="0")&&(e.style.visibility="visible",e.style.opacity="0.5",o.log("[Timeline] Critical handoff: Forced BG visible")),Se(0,!1))}const h=Math.max(0,(n-ae)/(1-ae));n>=ae&&h<.1&&(window.timelineShaderControls&&window.timelineShaderControls.resume?(window.timelineShaderControls.resume(),t._loggedShaderResume||(t._loggedShaderResume=!0)):t._loggedShaderMissing||(t._loggedShaderMissing=!0,o.warn("[Timeline] Timeline shader controls not available at progress:",n.toFixed(4))),window.coverOrbControls&&window.coverOrbControls.resume?(window.coverOrbControls.resume(),t._loggedOrbResume||(t._loggedOrbResume=!0)):t._loggedOrbMissing||(t._loggedOrbMissing=!0,o.warn("[Timeline] Cover orb controls not available at progress:",n.toFixed(4)))),document.getElementById("timeline-window-start-bg-style");const c=performance.now();if(c-Ke>=Xt){Ke=c;const w=e.getBoundingClientRect();if(Math.abs(w.width-window.innerWidth)<10&&Math.abs(w.height-window.innerHeight)<10&&Math.abs(w.top)<10&&Math.abs(w.left)<10){const a=parseFloat(e.style.opacity||"0");Math.abs(a-1)>.01&&(o.log("[Timeline] SAFETY CHECK: Forcing BG to opacity 1 (was",a,")"),e.style.opacity="1",e.style.visibility="visible");return}const p=window.getComputedStyle(f,"::before");parseFloat(p.opacity||"0")>0&&parseFloat(e.style.opacity||"1")>0&&(e.style.opacity="0",e.style.visibility="hidden")}if(n<s){if(document.body.classList.contains("in-timeline"))return;if(c-Ke<50){const u=D();u&&(e.style.position="fixed",e.style.top=`${u.top}px`,e.style.left=`${u.left}px`,e.style.width=`${u.width}px`,e.style.height=`${u.height}px`,e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.borderRadius="4px",e.style.opacity="0",e.style.visibility="hidden",R={...u}),Se(.5,!1)}}else document.body.classList.contains("in-timeline")&&e.style.opacity!=="1"&&(e.style.opacity="1",e.style.visibility="visible",o.log("[Timeline] Forcing background to opacity 1 - already in timeline")),Se(0,!1),e.style.visibility!=="visible"&&(e.style.visibility="visible")},onEnter:()=>{W=!1,P(),Me&&Me.kill(),Se(.5,!1);const t=D();t?(e.style.position="fixed",e.style.top=`${t.top}px`,e.style.left=`${t.left}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`,e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",e.style.borderRadius="4px",e.style.zIndex="0",e.style.opacity="0",e.style.visibility="hidden",R={...t}):o.warn("[Timeline] onEnter: Could not get valid span position")},onLeaveBack:()=>{W=!0,S(),C(),e.style.opacity="0",e.style.visibility="hidden",Se(.5,!0)}}});if(De.push(ke.scrollTrigger),ke.fromTo(e,()=>{if(e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))",R&&R.width>0&&R.height>0)return{top:`${R.top}px`,left:`${R.left}px`,width:`${R.width}px`,height:`${R.height}px`};const t=D();if(t)return R={...t},{top:`${t.top}px`,left:`${t.left}px`,width:`${t.width}px`,height:`${t.height}px`};o.warn("[Timeline] No valid position for expansion animation - using viewport center fallback"),window.dispatchEvent(new CustomEvent("timeline:init-failed",{detail:{reason:"expansion-fallback-used",capturedPosition:R,elementExists:!!f,elementDimensions:f?{width:f.offsetWidth,height:f.offsetHeight,display:window.getComputedStyle(f).display}:null,timestamp:Date.now()}}));const n=200,s=40;return{top:`${(window.innerHeight-s)/2}px`,left:`${(window.innerWidth-n)/2}px`,width:`${n}px`,height:`${s}px`}},{top:0,left:0,width:"100vw",height:"100vh",borderRadius:"0px",ease:"power2.inOut",duration:.7,immediateRender:!1,onStart:()=>{const t=D();if(t&&R){const n=Math.abs(t.top-R.top)+Math.abs(t.left-R.left)+Math.abs(t.width-R.width)+Math.abs(t.height-R.height);n>5&&(o.log("[Timeline] Position drift detected on expansion start, syncing:",n.toFixed(1),"px"),e.style.top=`${t.top}px`,e.style.left=`${t.left}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`,R={...t})}},onUpdate:()=>{e.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))"},onReverseComplete:()=>{e.style.opacity="0"}},ae),ke.fromTo(e,{opacity:.5},{opacity:1,duration:.7,ease:"none"},ae),document.fonts&&document.fonts.ready){let t=!1;const n=()=>{t||(t=!0,Z.refresh())};document.fonts.ready.then(n).catch(s=>{o.warn("[Timeline] Font loading failed, refreshing ScrollTrigger anyway:",s),n()}),setTimeout(()=>{t||(o.warn("[Timeline] Font loading timeout after 3s, forcing ScrollTrigger refresh"),n())},3e3)}else setTimeout(()=>Z.refresh(),500);const It=ae+.4*(1-ae);ke.to(i,{opacity:0,ease:"power2.in",duration:.6},It);const F={waveSpeed:.26,waveAmplitude:1.9,waveFrequencyX:.16,waveFrequencyY:.32,bobbingAmplitude:1.4,bobbingSpeed:.22,fadeIntensity:.86,opacity:.58,scale:3.4,rotationX:-1.7,rotationZ:.26,positionY:-30,positionZ:-16},te={waveSpeed:.18,waveAmplitude:5,waveFrequencyX:.6,waveFrequencyY:1,bobbingAmplitude:2.2,bobbingSpeed:.24,fadeIntensity:.39,opacity:1,scale:5,rotationX:-1.6,rotationZ:-1.44,positionY:-20,positionZ:-20},K={};let lt=0;const Ft=ue()?2:1;let ct=-1;if(x=r.timeline({scrollTrigger:{trigger:g,start:"top top",end:()=>`+=${Qe()}`,pin:l,scrub:ue()?1:.2,anticipatePin:1,invalidateOnRefresh:!0,onRefresh:t=>{if(V||window._isTimelineDismissed){o.log("[Timeline] Timeline onRefresh blocked - timeline is dismissed");return}if(!(Pe||window._isDismissing||xe)){if(ye){o.log("[Timeline] Timeline onRefresh blocked by isBgLockedFullscreen flag"),t.animation&&Ce(t.animation.progress());return}if(document.body.classList.contains("in-timeline")){o.log("[Timeline] Timeline onRefresh - in timeline, skipping background updates"),t.animation&&Ce(t.animation.progress());return}t.animation&&(Ce(t.animation.progress()),Ce(t.animation.progress()))}},onUpdate:t=>{if(V||window._isTimelineDismissed||Pe||window._isDismissing||xe||ye)return;const n=t.animation.progress();Ce(n);const s=.75;if(!ue()&&n>s&&window.timelineShaderControls&&window.timelineShaderControls.updateParams){lt++;const m=Math.abs(n-ct);if(!(lt%Ft===0||m>.01))return;ct=n;let c=(n-s)/(1-s);c=Math.max(0,Math.min(1,c)),K.waveSpeed=F.waveSpeed+(te.waveSpeed-F.waveSpeed)*c,K.waveAmplitude=F.waveAmplitude+(te.waveAmplitude-F.waveAmplitude)*c,K.waveFrequencyX=F.waveFrequencyX+(te.waveFrequencyX-F.waveFrequencyX)*c,K.waveFrequencyY=F.waveFrequencyY+(te.waveFrequencyY-F.waveFrequencyY)*c,K.bobbingAmplitude=F.bobbingAmplitude+(te.bobbingAmplitude-F.bobbingAmplitude)*c,K.bobbingSpeed=F.bobbingSpeed+(te.bobbingSpeed-F.bobbingSpeed)*c,K.fadeIntensity=F.fadeIntensity+(te.fadeIntensity-F.fadeIntensity)*c,K.opacity=F.opacity+(te.opacity-F.opacity)*c,K.scale=F.scale+(te.scale-F.scale)*c,K.rotationX=F.rotationX+(te.rotationX-F.rotationX)*c,K.rotationZ=F.rotationZ+(te.rotationZ-F.rotationZ)*c,K.positionY=F.positionY+(te.positionY-F.positionY)*c,K.positionZ=F.positionZ+(te.positionZ-F.positionZ)*c,window.timelineShaderControls.updateParams(K)}},onEnter:()=>{if(V||window._isTimelineDismissed){o.log("[Timeline] onEnter blocked - timeline is dismissed");return}document.body.classList.add("in-timeline");const t=document.querySelector('meta[name="theme-color"]');t&&t.setAttribute("content","#000000"),window.backgroundPaused||(window.backgroundPaused=!0,window.dispatchEvent(new CustomEvent("timeline:backgroundPaused",{detail:{paused:!0}}))),window.shaderBackgroundRenderer&&window.shaderBackgroundRenderer.setInTimeline&&window.shaderBackgroundRenderer.setInTimeline(!0),window.coverOrbControls&&window.coverOrbControls.resume&&window.coverOrbControls.resume(),window.timelineShaderControls&&window.timelineShaderControls.resume&&window.timelineShaderControls.resume(),window._timelinePauseTimeout&&(clearTimeout(window._timelinePauseTimeout),window._timelinePauseTimeout=null),r.set(l,{opacity:1,display:"block",pointerEvents:"auto",visibility:"visible"}),N&&r.set(N,{opacity:1,visibility:"visible",clearProps:ue()?"x":"y"}),r.utils.toArray(".timeline-event").forEach(p=>{r.set(p,{visibility:"visible",display:"flex"})});const s=document.querySelector(".timeline-event.timeline-cover");s&&r.set(s,{opacity:1,scale:1,visibility:"visible"}),e.style.zIndex="0",r.to(e,{opacity:1,duration:.2,ease:"none",overwrite:"auto"});const m=document.querySelector("#background-canvas");m&&r.to(m,{opacity:0,duration:.5,ease:"power2.inOut"});const h=document.documentElement;h.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))";const c=r.utils.toArray(".minor-node"),w=r.utils.toArray(".marker"),u=document.querySelector(".scrubber-progress");if(c.length>0&&u){const p=c[0];c.forEach(a=>{a.classList.remove("active","complete")}),p.classList.add("active"),w.length>0&&(w.forEach(a=>{a.classList.remove("active","complete")}),w[0].classList.add("active"));const y=document.querySelector(".scrubber-line");if(y){const a=y.getBoundingClientRect(),E=p.getBoundingClientRect(),M=E.left+E.width/2-a.left,L=a.width,Y=Math.max(0,Math.min(1,M/L));r.set(u,{scaleX:Y,transformOrigin:"left"})}}z||(z=document.querySelector("#current-timeline-year")),z&&(r.set(z,{opacity:0}),z.textContent="",A&&typeof A.revert=="function"&&(A.revert(),A=null),Fe=null,ge=!1)},onLeave:()=>{document.body.classList.remove("in-timeline"),window.backgroundPaused&&(window.backgroundPaused=!1,window.dispatchEvent(new CustomEvent("timeline:backgroundPaused",{detail:{paused:!1}}))),window.shaderBackgroundRenderer&&window.shaderBackgroundRenderer.setInTimeline&&window.shaderBackgroundRenderer.setInTimeline(!1);const t=document.querySelector("#background-canvas");t&&r.to(t,{opacity:1,duration:.5,ease:"power2.inOut"});const n=document.documentElement;r.to(n,{duration:.5,ease:"power2.inOut",onComplete:function(){n.style.background=""}})},onLeaveBack:()=>{document.body.classList.remove("in-timeline"),window.backgroundPaused&&(window.backgroundPaused=!1,window.dispatchEvent(new CustomEvent("timeline:backgroundPaused",{detail:{paused:!1}}))),window.shaderBackgroundRenderer&&window.shaderBackgroundRenderer.setInTimeline&&window.shaderBackgroundRenderer.setInTimeline(!1);const t=setTimeout(()=>{document.body.classList.contains("in-timeline")||(window.coverOrbControls&&window.coverOrbControls.pause&&window.coverOrbControls.pause(),window.timelineShaderControls&&window.timelineShaderControls.stop&&window.timelineShaderControls.stop())},1e3);window._timelinePauseTimeout=t,z||(z=document.querySelector("#current-timeline-year")),z&&(r.set(z,{opacity:0}),z.textContent="",A&&typeof A.revert=="function"&&(A.revert(),A=null),Fe=null,ge=!1)},onEnterBack:()=>{if(V||window._isTimelineDismissed){o.log("[Timeline] onEnterBack blocked - timeline is dismissed");return}document.body.classList.add("in-timeline"),window.backgroundPaused||(window.backgroundPaused=!0,window.dispatchEvent(new CustomEvent("timeline:backgroundPaused",{detail:{paused:!0}}))),window.shaderBackgroundRenderer&&window.shaderBackgroundRenderer.setInTimeline&&window.shaderBackgroundRenderer.setInTimeline(!0),window.coverOrbControls&&window.coverOrbControls.resume&&window.coverOrbControls.resume(),window.timelineShaderControls&&window.timelineShaderControls.resume&&window.timelineShaderControls.resume(),window._timelinePauseTimeout&&(clearTimeout(window._timelinePauseTimeout),window._timelinePauseTimeout=null),r.set(l,{opacity:1,display:"block",pointerEvents:"auto",visibility:"visible"}),N&&r.set(N,{opacity:1,visibility:"visible"}),r.utils.toArray(".timeline-event").forEach(m=>{r.set(m,{visibility:"visible",display:"flex"})}),e.style.zIndex="0",r.to(e,{opacity:1,duration:.2,ease:"none",overwrite:"auto"});const n=document.querySelector("#background-canvas");n&&r.to(n,{opacity:0,duration:.5,ease:"power2.inOut"});const s=document.documentElement;s.style.background="linear-gradient(rgb(4, 147, 171), rgb(6, 87, 164))"}}}),De.push(x.scrollTrigger),x.fromTo(".timeline-scrubber",{opacity:0,y:30},{opacity:1,y:0,duration:.05,ease:"power2.out",force3D:!0},0),x.to(".scrubber-nav",{opacity:1,duration:.05,ease:"power2.out",force3D:!0},0),x.to(e,{"--decal-opacity":1,duration:.5,ease:"power2.out",onUpdate:function(){const t=r.getProperty(e,"--decal-opacity")||0;e.style.setProperty("--decal-opacity",t)}},.01),v.length>0){const t=v[0],n=v.slice(1),s="first-event";x.add(s,0),x.fromTo(t,{opacity:0,scale:.95},{opacity:1,scale:1,duration:.25,ease:"power2.out",force3D:!0},s),et(t,s,j*.05),x.to({},{duration:he},">"),n.forEach((m,h)=>{const c=()=>window.matchMedia("(max-width: 1024px)").matches,w=()=>{if(c())return 0;const a=G(),E=window.innerWidth,M=window.innerWidth*.5,L=E+h*a+a*.5;return M-L},u=()=>c()?`${-(h+1)*100}vh`:0,p=`event-${h}`;x.to(N,{x:w,y:u,duration:j,ease:"power1.inOut",force3D:!0},p);const y=h===0?t:n[h-1];x.to(y,{opacity:0,scale:.94,duration:j*.28,ease:"power1.in",force3D:!0},`${p}+=${j*.34}`),x.fromTo(m,{opacity:0,scale:.9},{opacity:1,scale:1,duration:j*1.15,ease:"power2.out",force3D:!0},`${p}+=${j*.1}`),et(m,p,j*.12),h===0&&x.fromTo(".timeline-close",{opacity:0},{opacity:1,duration:j*.5,ease:"power2.out",force3D:!0},`${p}+=${j*.3}`),x.to({},{duration:he})})}const dt=g.querySelector(".timeline-close");dt&&dt.addEventListener("click",()=>{Rt()});function ut(){const t=r.utils.toArray(".marker");if(!t.length||!B.length){o.warn("Timeline: Markers or decades not found");return}let n=0,s=0;B.forEach((m,h)=>{const c=m.getAttribute("data-decade"),w=r.utils.toArray(".timeline-event",m),u=t.find(a=>a.getAttribute("data-decade")===c);if(!u){o.warn(`Timeline: No marker found for decade ${c}`);return}const p=u.querySelector(".marker-minor-nodes");if(!p){o.warn(`Timeline: No minor nodes container found for decade ${c}`);return}p.innerHTML="";const y=parseInt(c)||0;w.forEach((a,E)=>{if(a.classList.contains("timeline-cover")){n++;return}const L=n===0?(.09+he*.5)/ze:(We+(n-1)*Ne+j+he*.5)/ze,Y=a.getAttribute("data-year")||"";let _=0;const me=Y.match(/\d{4}/);me&&(_=parseInt(me[0]));let le=0;_>0&&y>0&&(le=(_-y)/10,le=Math.max(0,Math.min(.95,le)));const $=document.createElement("div");$.className="minor-node",$.setAttribute("data-event-index",n),$.setAttribute("data-minor-index",s),$.setAttribute("data-decade-index",h),$.setAttribute("data-local-index",E),$.setAttribute("data-year",Y),$.setAttribute("data-year-numeric",_.toString()),$.setAttribute("data-year-position",le.toFixed(3));const Ee=document.createElement("div");if(Ee.className="minor-node-dot",$.appendChild(Ee),Y){const we=document.createElement("div");we.className="minor-node-label",we.textContent=Y,$.appendChild(we)}requestAnimationFrame(()=>{const we=u.getBoundingClientRect(),fe=r.utils.toArray(".marker"),Ue=h+1;if(Ue<fe.length){const Te=fe[Ue].getBoundingClientRect(),Re=we.right,Le=Te.left-Re,be=30,X=20,se=Le-be-X,qe=be+X+se*le;$.style.left=`${qe}px`}else{const ve=window.innerWidth,Te=ve>768?120:100,Re=ve>768?5:ve<640?2:4,je=(ve-Te)/Re,Le=30,be=20,X=je-Le-be,se=Le+be+X*le;$.style.left=`${se}px`}}),$.addEventListener("click",we=>{we.stopPropagation(),I.isLocked=!0,I.reason="minor-node-click",I.unlockTimer&&clearTimeout(I.unlockTimer),r.utils.toArray(".minor-node").forEach(X=>{X.classList.remove("active","complete");const se=parseInt(X.getAttribute("data-minor-index")||"0");se<s?X.classList.add("complete"):se===s&&X.classList.add("active")}),r.utils.toArray(".marker").forEach((X,se)=>{X.classList.remove("active","complete"),se===h?X.classList.add("active"):se<h&&X.classList.add("complete")});const ve=document.querySelector(".scrubber-progress");if(ve){const X=document.querySelector(".scrubber-line");if(X){const se=X.getBoundingClientRect(),qe=$.getBoundingClientRect(),Dt=qe.left+qe.width/2-se.left,zt=se.width,At=Math.max(0,Math.min(1,Dt/zt));r.to(ve,{scaleX:At,transformOrigin:"left",duration:.3,ease:"power2.out"})}}const Te=x.scrollTrigger;if(!Te)return;const Re=Te.start,Le=Te.end-Re,be=Re+Le*L;window.lenis?window.lenis.scrollTo(be,{duration:1,easing:X=>Math.min(1,1.001-Math.pow(2,-10*X)),onComplete:()=>{I.unlockTimer=setTimeout(()=>{I.isLocked=!1,I.targetIndex=-1,I.reason=""},500)}}):(window.scrollTo({top:be,behavior:"smooth"}),I.unlockTimer=setTimeout(()=>{I.isLocked=!1,I.targetIndex=-1,I.reason=""},1500))}),p.appendChild($),n++,s++}),w.filter(a=>!a.classList.contains("timeline-cover")).length})}ut(),window._generateMinorNodes=ut;function Mt(){const t=document.querySelector(".scrubber-scroll-wrapper"),n=document.querySelector(".scrubber-nav-prev"),s=document.querySelector(".scrubber-nav-next"),m=r.utils.toArray(".marker");if(!t||!n||!s){o.warn("Timeline: Scrubber scroll elements not found");return}function h(){const a=t.scrollLeft,E=t.scrollWidth-t.clientWidth;a<=10?n.classList.add("disabled"):n.classList.remove("disabled"),a>=E-10?s.classList.add("disabled"):s.classList.remove("disabled")}function c(a){if(a<0||a>=m.length)return;const E=m[a],M=E.getBoundingClientRect();t.getBoundingClientRect();const L=E.offsetLeft+M.width/2,Y=t.clientWidth/2,_=L-Y;t.scrollTo({left:Math.max(0,_),behavior:"smooth"})}function w(a){const E=window.innerWidth,M=E>768?120:100,L=E>768?5:E<640?2:4,_=((E-M)/L+60)*3,me=t.scrollLeft+_*a;t.scrollTo({left:Math.max(0,me),behavior:"smooth"})}n.addEventListener("click",()=>{w(-1)}),s.addEventListener("click",()=>{w(1)}),t.addEventListener("scroll",h),h();let u=!1,p,y;t.style.cursor="",t.style.userSelect="none",t.addEventListener("mousedown",a=>{u=!0,t.classList.add("active"),t.style.cursor="grabbing",p=a.pageX-t.offsetLeft,y=t.scrollLeft}),t.addEventListener("mouseleave",()=>{u=!1,t.classList.remove("active"),t.style.cursor=""}),t.addEventListener("mouseup",()=>{u=!1,t.classList.remove("active"),t.style.cursor=""}),t.addEventListener("mousemove",a=>{if(!u)return;a.preventDefault();const M=(a.pageX-t.offsetLeft-p)*1.5;t.scrollLeft=y-M}),window.scrubberAutoScroll=(a,E=0)=>{if(a<0||a>=m.length)return;const L=m[a].getBoundingClientRect(),Y=t.getBoundingClientRect(),_=Y.left+100,me=Y.right-100,le=L.left>=_&&L.right<=me;let $=!1,Ee=a;if(!le)$=!0;else if(E>0){if(a+1<m.length){const fe=m[a+1].getBoundingClientRect();(fe.right>me||fe.left>me)&&($=!0,Ee=a+1)}}else if(E<0&&a-1>=0){const fe=m[a-1].getBoundingClientRect();(fe.left<_||fe.right<_)&&($=!0,Ee=a-1)}$&&c(Ee)}}return Mt(),r.utils.toArray(".marker").forEach((t,n)=>{t.addEventListener("click",()=>{I.isLocked=!0,I.targetIndex=n,I.reason="click",I.unlockTimer&&clearTimeout(I.unlockTimer),I.unlockTimer=setTimeout(()=>{I.isLocked=!1,I.targetIndex=-1,I.reason=""},100);const s=Et(n),m=x.scrollTrigger;if(!m)return;const h=m.start,w=m.end-h,u=h+w*s;window.lenis?window.lenis.scrollTo(u,{duration:1.2,easing:p=>Math.min(1,1.001-Math.pow(2,-10*p))}):window.scrollTo({top:u,behavior:"smooth"})}),t.style.cursor="pointer"}),r.timeline({scrollTrigger:{trigger:g,start:"bottom bottom",end:"bottom 80%",scrub:1,onEnterBack:()=>{r.to([e,g],{opacity:1,duration:.3})},onLeave:()=>{}}}).to([e,g],{opacity:0,ease:"power2.in"}),Z.addEventListener("refreshInit",()=>{}),Z.addEventListener("refresh",()=>{if(He>0){const n=`event-${He-1}`;if(x.labels[n]!==void 0){const h=(x.labels[n]+j)/x.duration(),c=x.scrollTrigger;if(c){const w=c.start+h*(c.end-c.start);window.scrollTo(0,w)}}}}),window._timelineCleanup={rafId:U,resizeObserver:ne,stopTracking:P},window._timelineScrollTriggers=De.slice(),ee&&window._timelineScrollTriggers.push(ee),Me&&Me.scrollTrigger&&window._timelineScrollTriggers.push(Me.scrollTrigger),ke&&ke.scrollTrigger&&window._timelineScrollTriggers.push(ke.scrollTrigger),x&&x.scrollTrigger&&window._timelineScrollTriggers.push(x.scrollTrigger),window._timelinePositioning={positionBgToSpan:C,syncBgToSpanImmediate:S,resetCapturedPosition:()=>{R=null,T={top:0,left:0,width:0,height:0},b={top:0,left:0,width:0,height:0}},setTrackingSpan:t=>{W=t},getTrackingSpan:()=>W},x.scrollTrigger&&(k.timelineScrollTrigger=x.scrollTrigger),k.markerLockRef=I,requestAnimationFrame(()=>{Z.refresh()}),x}let k={isResizing:!1,savedProgress:null,timelineScrollTrigger:null,markerLockRef:null};function Gt(){const d=typeof k<"u"&&k?k.timelineScrollTrigger:null;if(!d||!d.isActive)return null;const g=d.progress,f=r.utils.toArray(".timeline-event"),e=r.utils.toArray(".timeline-decade"),i=r.utils.toArray(".marker");let l=0,N=0,T=-1;i.forEach((W,q)=>{W.classList.contains("active")&&(T=q)});const b=f.length;if(b>0&&g>0){l=Math.min(Math.floor(g*b),b-1);let W=0;for(let q=0;q<e.length;q++){const D=r.utils.toArray(".timeline-event",e[q]);if(l<W+D.length){N=q;break}W+=D.length}}return T>=0&&(N=T),{progress:g,activeEventIndex:l,activeDecadeIndex:N,activeMarkerIndex:T,scrollPosition:window.pageYOffset||document.documentElement.scrollTop}}let mt=null,pt=null,gt=window.innerWidth,wt=window.innerHeight;function Vt(){k.isResizing||(k.isResizing=!0,k.savedProgress=Gt(),document.body.classList.add("timeline-resizing"))}function Zt(){const d=window.innerWidth,g=window.innerHeight,f=Math.abs(d-gt),e=Math.abs(g-wt),i=f<5&&e>40&&e<200;return gt=d,wt=g,i}function Ut(){const d=Zt(),g=document.querySelector("#timeline-shader-bg");g&&(g.style.width=`${window.innerWidth}px`,g.style.height=`${window.innerHeight}px`),window._generateMinorNodes&&!d&&window._generateMinorNodes();const f=document.querySelector("#acs-timeline");if(f&&window._timelinePositioning){const e=document.body.classList.contains("in-timeline"),l=f.getBoundingClientRect().top>window.innerHeight*.3;!e&&l?(o.log("[Resize] Before timeline - resetting background position"),window._timelinePositioning.resetCapturedPosition(),window._timelinePositioning.setTrackingSpan&&window._timelinePositioning.setTrackingSpan(!0),requestAnimationFrame(()=>{window._timelinePositioning.syncBgToSpanImmediate&&window._timelinePositioning.syncBgToSpanImmediate()})):e||requestAnimationFrame(()=>{window._timelinePositioning.syncBgToSpanImmediate&&window._timelinePositioning.syncBgToSpanImmediate()})}if(d){o.log("[Resize] Mobile address bar change detected - lightweight refresh"),Z.update(),requestAnimationFrame(()=>{window._timelinePositioning&&window._timelinePositioning.syncBgToSpanImmediate&&window._timelinePositioning.syncBgToSpanImmediate(),document.body.classList.remove("timeline-resizing"),k.isResizing=!1,k.savedProgress=null});return}Z.refresh(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(Z.update(),f&&window._timelinePositioning){const e=document.body.classList.contains("in-timeline"),l=f.getBoundingClientRect().top>window.innerHeight*.3;!e&&l&&(o.log("[Resize] Post-refresh: Re-syncing background position"),window._timelinePositioning.syncBgToSpanImmediate&&window._timelinePositioning.syncBgToSpanImmediate())}if(k.savedProgress&&k.timelineScrollTrigger){const e=k.timelineScrollTrigger,i=e.start,N=e.end-i,T=i+N*k.savedProgress.progress;if(window.lenis?window.lenis.scrollTo(T,{immediate:!0,force:!0}):window.scrollTo({top:T,behavior:"auto"}),k.savedProgress.activeMarkerIndex>=0&&k.markerLockRef){k.markerLockRef.isLocked=!0,k.markerLockRef.targetIndex=k.savedProgress.activeMarkerIndex,k.markerLockRef.reason="resize",r.utils.toArray(".marker").forEach((C,O)=>{C.classList.remove("active","complete"),O===k.savedProgress.activeMarkerIndex?C.classList.add("active"):O<k.savedProgress.activeMarkerIndex&&C.classList.add("complete")});const W=k.savedProgress.activeEventIndex,q=r.utils.toArray(".minor-node"),D=W-1;q.forEach((C,O)=>{C.classList.remove("active","complete");const H=parseInt(C.getAttribute("data-minor-index")||O);H===D?C.classList.add("active"):H<D&&C.classList.add("complete")});const S=document.querySelector(".scrubber-progress");if(S&&D>=0&&q[D]){const C=q[D],O=document.querySelector(".scrubber-line");O&&C&&requestAnimationFrame(()=>{const H=O.getBoundingClientRect(),ie=C.getBoundingClientRect(),J=ie.left+ie.width/2-H.left,ne=H.width,U=Math.max(0,Math.min(1,J/ne));r.set(S,{scaleX:U,transformOrigin:"left"})})}}setTimeout(()=>{Z.update(),e.animation&&(e.animation.invalidate(),e.animation.progress(e.animation.progress())),window.dispatchEvent(new Event("scroll")),e.animation&&window._updateScrubber&&requestAnimationFrame(()=>{window._updateScrubber(e.animation.progress())}),setTimeout(()=>{k.markerLockRef&&k.markerLockRef.reason==="resize"&&(k.markerLockRef.isLocked=!1,k.markerLockRef.targetIndex=-1,k.markerLockRef.reason="")},500),document.body.classList.remove("timeline-resizing"),k.isResizing=!1,k.savedProgress=null},150)}else document.body.classList.remove("timeline-resizing"),k.isResizing=!1,k.savedProgress=null})})}window.addEventListener("resize",()=>{clearTimeout(pt),clearTimeout(mt),pt=setTimeout(Vt,10),mt=setTimeout(Ut,300)});if(window.visualViewport){let d=null;window.visualViewport.addEventListener("resize",()=>{clearTimeout(d),d=setTimeout(()=>{!k.isResizing&&window._timelinePositioning&&(document.body.classList.contains("in-timeline")||(o.log("[VisualViewport] Address bar change - syncing background"),window._timelinePositioning.setTrackingSpan&&window._timelinePositioning.setTrackingSpan(!0),window._timelinePositioning.syncBgToSpanImmediate&&window._timelinePositioning.syncBgToSpanImmediate()))},100)})}function ni(){try{if(window._timelineCleanup){if(window._timelineCleanup.rafId&&cancelAnimationFrame(window._timelineCleanup.rafId),window._timelineCleanup.resizeObserver)try{window._timelineCleanup.resizeObserver.disconnect()}catch(d){o.warn("[Timeline] Error disconnecting resize observer:",d.message)}if(window._timelineCleanup.lenisCallback&&window.lenis)try{window.lenis.off("scroll",window._timelineCleanup.lenisCallback)}catch(d){o.warn("[Timeline] Error removing lenis listener:",d.message)}if(window._timelineCleanup.scrollCallback&&window.removeEventListener("scroll",window._timelineCleanup.scrollCallback),window._timelineCleanup.stopTracking)try{window._timelineCleanup.stopTracking()}catch(d){o.warn("[Timeline] Error stopping tracking:",d.message)}window._timelineCleanup=null}if(window._timelineScrollTriggers&&(window._timelineScrollTriggers.forEach(d=>{try{d&&d.kill&&d.kill()}catch(g){o.warn("[Timeline] Error killing ScrollTrigger:",g.message)}}),window._timelineScrollTriggers=null),window.timelineShaderControls){try{window.timelineShaderControls.stop&&window.timelineShaderControls.stop(),window.timelineShaderControls.dispose&&window.timelineShaderControls.dispose()}catch(d){o.warn("[Timeline] Error disposing shader:",d.message)}window.timelineShaderControls=null}if(window.coverOrbControls){try{window.coverOrbControls.dispose&&window.coverOrbControls.dispose()}catch(d){o.warn("[Timeline] Error disposing cover orb:",d.message)}window.coverOrbControls=null}window._isTimelineDismissed=!1,window._isDismissing=!1,window.backgroundPaused&&(window.backgroundPaused=!1,window.dispatchEvent(new CustomEvent("timeline:backgroundPaused",{detail:{paused:!1}}))),o.log("[Timeline] Disposed successfully")}catch(d){o.warn("[Timeline] Error during dispose:",d.message)}}export{ni as disposeTimeline,ii as initTimelineAnimation};
