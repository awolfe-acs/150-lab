import{l as r}from"./logger-2Ii2FPkr.js";class F{constructor(){this.tier=null,this.confirmedTier=null,this.runtimeValidated=!1,this.fpsHistory=[],this.fpsHistoryMaxLength=120,this.lowFpsStreak=0,this.highFpsStreak=0,this.lowFpsStreakThreshold=6,this.degradationCallbacks=[],this.fpsCap=null,this.fpsCapCallbacks=[],this.fpsCapEvaluationDelay=5,this.highFpsCount=0,this.maxFpsSeen=0,this.fpsVariance=[],this.independentFpsHistory=[],this.independentFrameCount=0,this.independentLastTime=0,this.independentMeasurementStarted=!1,this.isScrolling=!1,this.scrollTimeout=null,this.scrollThrottleMs=150,this.scrollCallbacks=[],this.lastScrollTime=0,this.metrics={isMobile:!1,isLowEnd:!1,hardwareConcurrency:navigator.hardwareConcurrency||2,deviceMemory:navigator.deviceMemory||4,connectionSpeed:this.getConnectionSpeed(),isAEMEmbedded:this.checkAEMEmbedded(),pixelRatio:window.devicePixelRatio||1,screenSize:window.innerWidth*window.innerHeight,gpuTier:null},this.setupScrollMonitoring()}setupScrollMonitoring(){const e=()=>{const t=performance.now(),i=this.isScrolling;this.isScrolling=!0,this.lastScrollTime=t,i||this.notifyScrollState(!0),this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.isScrolling=!1,this.notifyScrollState(!1)},this.scrollThrottleMs)};window.addEventListener("scroll",e,{passive:!0}),"ontouchstart"in window&&window.addEventListener("touchmove",e,{passive:!0})}notifyScrollState(e){this.scrollCallbacks.forEach(t=>{try{t({isScrolling:e,timestamp:performance.now()})}catch(i){r.warn("[Performance Detector] Scroll callback error:",i)}})}onScrollStateChange(e){typeof e=="function"&&this.scrollCallbacks.push(e)}getIsScrolling(){return this.isScrolling}checkAEMEmbedded(){try{if(window.self!==window.top)return!0;const e=window.location.href.toLowerCase();return e.includes("adobeaemcloud.com")||e.includes("aem")}catch{return!0}}getConnectionSpeed(){if(navigator.connection){const t=navigator.connection.effectiveType;return t==="4g"?"fast":t==="3g"?"medium":"slow"}return"fast"}detectMobile(){const e=navigator.userAgent||navigator.vendor||window.opera,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),i="ontouchstart"in window||navigator.maxTouchPoints>0,s=window.innerWidth<=768;return t||i&&s}async benchmarkGPU(){return new Promise(e=>{const t=document.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl");if(!i){e("low");return}const s=i.getExtension("WEBGL_debug_renderer_info");let n="unknown";if(s){if(n=i.getParameter(s.UNMASKED_RENDERER_WEBGL).toLowerCase(),["intel hd 3000","intel hd 4000","intel hd graphics","powervr","mali-400","mali-450","adreno 3","adreno 4","swiftshader"].some(m=>n.includes(m))){e("low");return}if(["nvidia","geforce","rtx","gtx","radeon","adreno 6","adreno 7","apple gpu","m1","m2"].some(m=>n.includes(m))){e("high");return}}const h=performance.now(),a=new Float32Array(1e4*3);for(let l=0;l<a.length;l++)a[l]=Math.random();const c=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,a,i.STATIC_DRAW),i.finish();const o=performance.now()-h;i.deleteBuffer(c),t.remove(),o<5?e("high"):o<15?e("medium"):e("low")})}async detect(){if(this.tier)return this.tier;this.metrics.isMobile=this.detectMobile(),this.metrics.gpuTier=await this.benchmarkGPU();let e=100;return this.metrics.isMobile&&(e-=30),this.metrics.screenSize<800*600?e-=10:this.metrics.screenSize>1920*1080&&(e-=15),this.metrics.hardwareConcurrency<=2?e-=20:this.metrics.hardwareConcurrency>=8&&(e+=10),this.metrics.deviceMemory<=2?e-=30:this.metrics.deviceMemory>=8&&(e+=10),this.metrics.gpuTier==="low"?e-=30:this.metrics.gpuTier==="high"&&(e+=20),this.metrics.connectionSpeed==="slow"&&(e-=20),this.metrics.isAEMEmbedded&&(e-=15),this.metrics.pixelRatio>2&&(e-=10),e>=70?this.tier="high":e>=40?this.tier="medium":this.tier="low",r.log("[Performance Detector] Metrics:",this.metrics),r.log("[Performance Detector] Score:",e),r.log("[Performance Detector] Tier:",this.tier),this.startIndependentFpsMeasurement(),this.tier}getSettings(){const e=this.confirmedTier||this.tier||"medium",t=this.metrics.isMobile;return{high:{particleCount:t?25:100,pixelRatio:Math.min(window.devicePixelRatio,t?1:1.5),antialias:!1,shadowsEnabled:!1,shaderQuality:t?"medium":"high",globeQuality:t?"medium":"high",mouseParticles:!t,targetFPS:60,enablePostProcessing:!1,maxLights:t?2:3,timelineShaderDotCount:t?{x:36,y:20}:{x:98,y:54},skipParticleUpdatesOnScroll:t,scrollThrottleFPS:t?24:60},medium:{particleCount:t?32:64,pixelRatio:Math.min(window.devicePixelRatio,t?.875:1.25),antialias:!1,shadowsEnabled:!1,shaderQuality:"medium",globeQuality:"medium",mouseParticles:!1,targetFPS:60,enablePostProcessing:!1,maxLights:2,timelineShaderDotCount:t?{x:24,y:14}:{x:72,y:40},skipParticleUpdatesOnScroll:t,scrollThrottleFPS:t?20:45},low:{particleCount:t?12:30,pixelRatio:t?.5:1,antialias:!1,shadowsEnabled:!1,shaderQuality:"low",globeQuality:"low",mouseParticles:!1,targetFPS:this.runtimeValidated&&this.confirmedTier==="low"?40:60,enablePostProcessing:!1,maxLights:1,timelineShaderDotCount:t?{x:18,y:10}:{x:48,y:27},skipParticleUpdatesOnScroll:!0,scrollThrottleFPS:t?15:30}}[e]}getScrollSettings(){const e=this.getSettings(),t=this.metrics.isMobile;return{...e,targetFPS:t?30:45,skipParticleTwinkle:!0,skipParticleMovement:t,reduceShaderComplexity:t}}startIndependentFpsMeasurement(){if(this.independentMeasurementStarted)return;this.independentMeasurementStarted=!0,this.independentLastTime=performance.now(),this.independentFrameCount=0;const e=()=>{if(!this.independentMeasurementStarted)return;this.independentFrameCount++;const t=performance.now(),i=t-this.independentLastTime;if(i>=1e3){const s=Math.round(this.independentFrameCount*1e3/i);this.independentFrameCount=0,this.independentLastTime=t,this.recordIndependentFpsSample(s)}requestAnimationFrame(e)};requestAnimationFrame(e),r.log("[Performance Detector] Started independent FPS measurement")}recordIndependentFpsSample(e){this.independentFpsHistory.push({fps:e,timestamp:Date.now()}),this.independentFpsHistory.length>30&&this.independentFpsHistory.shift(),e>this.maxFpsSeen&&(this.maxFpsSeen=e,r.log(`[Performance Detector] New max FPS seen: ${e}`),e>100&&this.fpsCap===60&&(r.log("[Performance Detector] Upgrading cap: saw FPS > 100, upgrading from 60 to 120"),this.setFpsCap(120,"upgrade_high_fps_detected"))),e>90&&this.highFpsCount++,this.independentFpsHistory.length>=this.fpsCapEvaluationDelay&&!this.fpsCap&&this.evaluateFpsCapFromIndependent()}evaluateFpsCapFromIndependent(){if(this.fpsCap||this.independentFpsHistory.length<this.fpsCapEvaluationDelay)return;const e=this.independentFpsHistory.slice(-10).map(n=>n.fps),t=e.reduce((n,h)=>n+h,0)/e.length,i=Math.min(...e),s=Math.max(...e);r.log("[Performance Detector] Independent FPS Cap Evaluation:",{avgFps:Math.round(t),minFps:i,maxFps:s,maxEverSeen:this.maxFpsSeen,sampleCount:this.independentFpsHistory.length}),this.maxFpsSeen>100||t>80?this.setFpsCap(120,"high_refresh_detected"):t>=40||this.maxFpsSeen>=50?this.setFpsCap(60,"standard_refresh"):t>=15?(r.log(`[Performance Detector] Device truly struggling (avg: ${Math.round(t)}fps, maxSeen: ${this.maxFpsSeen}) - capping at 30fps`),this.setFpsCap(40,"low_performance_detected")):(r.log(`[Performance Detector] WARNING: Extremely low FPS (avg: ${Math.round(t)}fps) - experience may be poor`),this.setFpsCap(30,"very_low_performance"))}reevaluateFpsCap(){if(!this.fpsCap)return!1;const e=this.getAverageFpsFromIndependent(15),t=this.getAverageFps(15),i=e;return r.log(`[Performance Detector] Re-evaluating FPS cap: independent avg ${e}fps, renderer avg ${t}fps, current cap ${this.fpsCap}fps, maxSeen ${this.maxFpsSeen}fps`),this.fpsCap===30&&(i>=45||this.maxFpsSeen>=60)?(r.log(`[Performance Detector] Upgrading FPS cap: avg ${i}fps, maxSeen ${this.maxFpsSeen}fps with 30fps cap -> 60fps cap`),this.setFpsCap(60,"performance_improved"),this.isDegraded=!1,this.runtimeValidated=!1,this.confirmedTier=null,!0):this.fpsCap===60&&i<30&&this.maxFpsSeen<50?(r.log(`[Performance Detector] Downgrading FPS cap: avg ${i}fps, maxSeen ${this.maxFpsSeen}fps with 60fps cap -> 30fps cap`),this.setFpsCap(40,"runtime_degradation"),!0):this.fpsCap===120&&i<45?(r.log(`[Performance Detector] Downgrading FPS cap: avg ${i}fps with 120fps cap -> 60fps cap`),this.setFpsCap(60,"runtime_degradation"),!0):!1}recordFpsSample(e){this.fpsHistory.push({fps:e,timestamp:Date.now()}),this.fpsHistory.length>this.fpsHistoryMaxLength&&this.fpsHistory.shift(),this.evaluatePerformance(e)}setFpsCap(e,t){this.fpsCap!==e&&(r.log(`[Performance Detector] Setting FPS cap to ${e}fps (reason: ${t})`),this.fpsCap=e,this.fpsCapCallbacks.forEach(i=>{try{i({cap:e,reason:t,avgFps:this.getAverageFps(10),maxFpsSeen:this.maxFpsSeen})}catch(s){r.warn("[Performance Detector] FPS cap callback error:",s)}}))}onFpsCapChange(e){typeof e=="function"&&(this.fpsCapCallbacks.push(e),this.fpsCap&&e({cap:this.fpsCap,reason:"initial",avgFps:this.getAverageFps(10),maxFpsSeen:this.maxFpsSeen}))}getFpsCap(){return this.fpsCap}evaluatePerformance(e){if(this.fpsHistory.length<5)return;if(e<25?(this.lowFpsStreak++,this.highFpsStreak=0):e>=50?(this.lowFpsStreak=Math.max(0,this.lowFpsStreak-3),this.highFpsStreak=(this.highFpsStreak||0)+1):(this.lowFpsStreak=Math.max(0,this.lowFpsStreak-1),this.highFpsStreak=Math.max(0,(this.highFpsStreak||0)-1)),this.fpsCap===40&&this.highFpsStreak>=8){const s=this.getAverageFpsFromIndependent(10);s>=45&&(r.log(`[Performance Detector] Upgrading from 30fps cap - avg: ${s}fps, highStreak: ${this.highFpsStreak}`),this.reevaluateFpsCap(),this.highFpsStreak=0)}if(this.lowFpsStreak>=10&&this.fpsCap!==30){const s=this.getAverageFpsFromIndependent(15);s<35?(r.log(`[Performance Detector] Downgrade evaluation - avg: ${s}fps, lowStreak: ${this.lowFpsStreak}`),this.reevaluateFpsCap(),this.lowFpsStreak=0):(r.log(`[Performance Detector] Ignoring low FPS streak - avg FPS is ${s}, which is acceptable`),this.lowFpsStreak=0)}if(this.lowFpsStreak>=this.lowFpsStreakThreshold&&!this.runtimeValidated){const s=this.getAverageFpsFromIndependent(15);s<35?this.confirmLowEndDevice():(r.log(`[Performance Detector] Not confirming low-end - avg FPS is ${s}, which is acceptable`),this.lowFpsStreak=Math.floor(this.lowFpsStreak/2))}}confirmLowEndDevice(){if(this.runtimeValidated&&this.confirmedTier==="low")return;const e=this.getAverageFpsFromIndependent(15),t=this.getAverageFps(15),i=Math.max(e,t);if(r.log(`[Performance Detector] Low-end confirmation check - independent avg: ${e}fps, renderer avg: ${t}fps, maxEverSeen: ${this.maxFpsSeen}`),i>=40||this.maxFpsSeen>=60){r.log(`[Performance Detector] NOT confirming low-end - bestAvg: ${i}fps, maxSeen: ${this.maxFpsSeen}fps is good enough`),this.lowFpsStreak=0;return}r.log("[Performance Detector] Runtime validation: Device confirmed as low-end after persistent poor FPS"),r.log(`[Performance Detector] FPS streak: ${this.lowFpsStreak}, History samples: ${this.fpsHistory.length}, Avg FPS: ${i}`),this.runtimeValidated=!0,this.confirmedTier="low",this.fpsCap!==40&&this.setFpsCap(40,"confirmed_low_end_device"),this.degradationCallbacks.forEach(s=>{try{s({tier:"low",targetFPS:40,reason:"persistent_low_fps"})}catch(n){r.warn("[Performance Detector] Degradation callback error:",n)}})}onDegradation(e){typeof e=="function"&&this.degradationCallbacks.push(e)}getAverageFps(e=10){if(this.fpsHistory.length===0)return 60;const t=this.fpsHistory.slice(-e),i=t.reduce((s,n)=>s+n.fps,0);return Math.round(i/t.length)}getAverageFpsFromIndependent(e=10){if(this.independentFpsHistory.length===0)return 60;const t=this.independentFpsHistory.slice(-e),i=t.reduce((s,n)=>s+n.fps,0);return Math.round(i/t.length)}isConfirmedLowEnd(){return this.runtimeValidated&&this.confirmedTier==="low"}isLowEnd(){return this.tier==="low"}isMobile(){return this.metrics.isMobile}isAEMEmbedded(){return this.metrics.isAEMEmbedded}}const S=new F,x=Object.freeze(Object.defineProperty({__proto__:null,default:S},Symbol.toStringTag,{value:"Module"}));class w{constructor(){this.overlay=null,this.isRunning=!1,this.frameIndex=0,this.animationFrameId=null,this.targetFPS=8,this.frameInterval=1e3/this.targetFPS,this.lastFrameTime=0,this.frames=[],this.frameCount=4,this.grainIntensity=.5,this.grainSize=1,this.opacity=.25,this.textureWidth=48,this.textureHeight=48,this.noiseBuffer=null,this.noiseBufferSize=256*256}init(){if(this.overlay)return;const e=performance.now();this.generateNoiseBuffer(),this.preGenerateFrames(),this.overlay=document.createElement("div"),this.overlay.id="mobile-film-grain",this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      opacity: ${this.opacity};
      mix-blend-mode: overlay;
      background-repeat: repeat;
      background-size: ${Math.round(this.textureWidth*this.grainSize)}px ${Math.round(this.textureHeight*this.grainSize)}px;
      image-rendering: pixelated;
    `,this.frames.length>0&&(this.overlay.style.backgroundImage=`url(${this.frames[0]})`);const t=document.getElementById("shaderBackground");t&&t.parentNode?t.parentNode.insertBefore(this.overlay,t):document.body.appendChild(this.overlay);const i=performance.now()-e;r.log(`[Mobile Film Grain] Initialized in ${i.toFixed(1)}ms with ${this.frameCount} pre-generated frames`)}generateNoiseBuffer(){this.noiseBuffer=new Uint8Array(this.noiseBufferSize);for(let e=0;e<this.noiseBufferSize;e++)this.noiseBuffer[e]=Math.random()*255}preGenerateFrames(){const e=document.createElement("canvas");e.width=this.textureWidth,e.height=this.textureHeight;const t=e.getContext("2d",{alpha:!0}),i=this.grainIntensity*255,s=this.textureWidth*this.textureHeight;for(let n=0;n<this.frameCount;n++){const h=t.createImageData(this.textureWidth,this.textureHeight),a=h.data,c=n*7919;for(let p=0;p<s;p++){const o=p*4,l=(p+c)%this.noiseBufferSize,d=((this.noiseBuffer[l]*31+c)%256-128)*(i/128);a[o]=128+d,a[o+1]=128+d,a[o+2]=128+d,a[o+3]=120}t.putImageData(h,0,0),this.frames.push(e.toDataURL("image/png"))}e.width=0,e.height=0}animate(e){if(!this.isRunning||(this.animationFrameId=requestAnimationFrame(i=>this.animate(i)),document.hidden))return;const t=e-this.lastFrameTime;t<this.frameInterval||(this.lastFrameTime=e-t%this.frameInterval,this.frameIndex=(this.frameIndex+1)%this.frameCount,this.overlay&&this.frames[this.frameIndex]&&(this.overlay.style.backgroundImage=`url(${this.frames[this.frameIndex]})`))}start(){this.isRunning||(this.init(),this.isRunning=!0,this.lastFrameTime=performance.now(),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)),r.log(`[Mobile Film Grain] Started at ~${this.targetFPS}fps`))}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}pauseForScroll(){this.overlay&&(this.overlay.style.display="none")}resumeAfterScroll(){this.overlay&&(this.overlay.style.display="block")}show(){this.overlay&&(this.overlay.style.display="block")}hide(){this.overlay&&(this.overlay.style.display="none")}setIntensity(e){this.grainIntensity=Math.max(0,Math.min(1,e))}setOpacity(e){this.opacity=Math.max(0,Math.min(1,e)),this.overlay&&(this.overlay.style.opacity=this.opacity)}destroy(){this.stop(),this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.frames=[],this.noiseBuffer=null,r.log("[Mobile Film Grain] Destroyed")}}const C=new w;export{x as a,C as m,S as p};
